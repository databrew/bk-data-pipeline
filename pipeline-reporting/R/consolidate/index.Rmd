---
title: "Bohemia Reports Catalog"
description: |
  Catalog of all Bohemia BI Reports and how to get there
date: "`r Sys.time()`"
output:
  html_document:
    theme: cerulean
    toc: yes
---

### Overview
This is the Catalog of all Bohemia BI Reports and their respective URLs. Reports are categorized into different topics, to drill down to a certain topic, please expand the `topic` column. Each topic will contain different reports with corresponding report URL and ODK URL (Monitoring)

```{r, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(
  comment = '', 
  echo = FALSE,
  message = FALSE,
  cache=FALSE,
  warning=FALSE
)
```

```{r, echo=FALSE, message=FALSE}
library(reactable)
library(data.table)
library(dplyr)
library(htmltools)
library(glue)
library(fontawesome)
library(ggplot2)
library(plotly)
library(tools)
```

```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri('../../asset/bohemia.jpg'), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px; width:200px; height:100px')
```

```{r}
# variables / creds for ento
env_pipeline_stage <- Sys.getenv("PIPELINE_STAGE")
bucket_source <- 'databrew.org'
bucket_lake_db <- 'bohemia-reporting'
prod_cloudfront_url <- 'https://d27fg4iv55pk9u.cloudfront.net'
cra_url_access <- 'https://databrew.org/-/single/CLd8IzvVNB5pfAm8QZ6aIftTt5r2IO9?st=D9fnhK7iSUaYIhf5$sTRmQS8xmAjnZr2ouvz!45FgU4OjrXLiC4sSyidRjaXjwry'
site_url_access <- 'https://databrew.org/-/single/wERhS1e7pcpTeqnEpicAWuj3INuKQuC?st=xE5KvLpmFFtQ8dgK6sk3jggvnYaXyF5xn7WL7oxTcWoLH5$n6Z10!pLzORGQuNBU'
```


```{r}
tryCatch({
  logger::log_info('Attempt AWS login')
  # login to AWS - this will be bypassed if executed in CI/CD environment
  cloudbrewr::aws_login(
    role_name = 'cloudbrewr-aws-role',
    profile_name =  'cloudbrewr-aws-role',
    pipeline_stage = env_pipeline_stage)

}, error = function(e){
  logger::log_error('AWS Login Failed')
  stop(e$message)
})
```
```{r}
data <- cloudbrewr::aws_s3_get_catalog(bucket = bucket_lake_db) %>%
  dplyr::mutate(url_key = glue::glue('{prod_cloudfront_url}/{key}')) %>%
  dplyr::select(-etag) %>%
  dplyr::mutate(report_name = basename(key)) %>%
    dplyr::mutate(key_split = stringr::str_split(key, "/")) %>% 
    dplyr::rowwise() %>% 
    dplyr::mutate(folder = key_split[1]) %>% 
    dplyr::filter(key != 'index.html',
                  size > 0) %>%
    dplyr::select(topic = folder, 
                  report_name, 
                  size, 
                  last_modified, 
                  url_key, 
                  folder)
```

### Bohemia Data-Ops Reports

This is all reports used in Bohemia Data-Ops team, all reports are updated **hourly 9-5PM EAT and once at 12AM EAT**

```{r}
d <- data %>% dplyr::filter(topic != 'monitoring')
reactable(
    d,
    columns = list(
        topic = colDef(name = 'Topic', minWidth = 200, filterable = TRUE),
        report_name = colDef(name = 'Report Name', minWidth = 300, filterable =TRUE),
        size = colDef(name = "Size (kb)"),
        last_modified = colDef(name = 'Last Modified', minWidth = 200),
        url_key = colDef(name = 'Report URL',
                         cell = function(value, index) {
                           url <- sprintf("%s", 
                                          d[index, "url_key"], value)
                           htmltools::tags$a(href = url, target = "_blank", 'URL')
                        })
    ),
    groupBy = "topic",
    highlight = TRUE,
    resizable = TRUE,
    bordered = TRUE,
    striped = TRUE)
```

### Bohemia CRA Weekly Monitoring Reports

This catalog covers all reports for CRA monitoring. **Reports are refreshed every Sunday 12.00AM EAT**, each report will be snapshotted into a corresponding report ID where user will be able to point to a specific ID for review. Please drill-down to check all the report snapshots

#### Guideline:

1. Expand drop-down in the interactive table by clicking on the `Topic` field in the table

2. To check on the reports, click the URL under `Report URL`

3. To provide monitoring review, click the URL under `CRA Review URL` and `Site Review URL` depending on user. Clicking the URL will pre-fill forms with corresponding `Report ID` to report findings

```{r}
data <- cloudbrewr::aws_s3_get_catalog(bucket = bucket_lake_db) %>% 
    dplyr::filter(stringr::str_detect(key, 'monitoring/')) %>% 
    dplyr::filter(stringr::str_detect(key, 'icf|lab|pharmacy|sae')) %>% 
    dplyr::filter(stringr::str_detect(key, 'html')) %>% 
    dplyr::mutate(grp = dirname(key)) %>% 
    dplyr::filter(stringr::str_detect(grp, 'icf|lab|pharmacy|sae')) %>%
  dplyr::mutate(url_key = glue::glue('{prod_cloudfront_url}/{key}')) %>%
  dplyr::select(-etag) %>%
  dplyr::mutate(report_name = basename(key)) %>%
    dplyr::mutate(key_split = stringr::str_split(key, "/")) %>% 
    dplyr::rowwise() %>% 
    dplyr::mutate(folder = key_split[2]) %>% 
    dplyr::filter(key != 'index.html',
                  size > 0) %>%
    dplyr::select(report_name, 
                  size, 
                  last_modified, 
                  url_key, 
                  topic = folder) %>%
    dplyr::ungroup() %>% 
    dplyr::mutate(
      cra_url_key = glue::glue(
        '{cra_url_access}&d%5B/data/group_indentifier/report_id%5D={report_id}',
        url_access = url_access,
        report_id = file_path_sans_ext(basename(report_name))),
      site_url_key = glue::glue(
        '{site_url_access}&d%5B/data/group_indentifier/report_id%5D={report_id}',
        url_access = url_access,
        report_id = file_path_sans_ext(basename(report_name)))
  )
```

```{r}
reactable(
    data,
    columns = list(
        topic = colDef(name = 'Topic', minWidth = 200, filterable = TRUE),
        report_name = colDef(name = 'Report Name', minWidth = 200, filterable =TRUE),
        size = colDef(name = "Size (kb)"),
        last_modified = colDef(name = 'Last Modified', minWidth = 200),
        url_key = colDef(name = 'Report URL',
                         cell = function(value, index) {
                           url <- sprintf("%s", 
                                          data[index, "url_key"], value)
                           htmltools::tags$a(href = url, target = "_blank", 'URL')
                        }),
        cra_url_key = colDef(name = 'CRA Review URL',
                         cell = function(value, index) {
                           url <- sprintf("%s", 
                                          data[index, "cra_url_key"], value)
                           htmltools::tags$a(href = url, target = "_blank", 'URL')
                        }),
        site_url_key = colDef(name = 'Site Review URL',
                         cell = function(value, index) {
                           url <- sprintf("%s", 
                                          data[index, "site_url_key"], value)
                           htmltools::tags$a(href = url, target = "_blank", 'URL')
                        })
    ),
    groupBy = "topic",
    highlight = TRUE,
    resizable = TRUE,
    bordered = TRUE,
    striped = TRUE)
```

### Bug Reports

Please report bug to `e.elobolobo@gmail.com` / `atediarjo@gmail.com` or to #data-ops Slack channel
