---
title: "Efficacy Status Report"
output: 
  html_document:
    toc: true
    toc_float: 
      collapsed: true
    theme: cerulean
date: '`r Sys.time()`'
---

Notes:

- Report is refreshed hourly 9-5pm EAT, once 12AM EAT
- Please reach out to nika.gorski@isglobal.org for bug reports


```{r, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(
  comment = '', 
  echo = FALSE,
  message = FALSE,
  cache=FALSE,
  warning=FALSE
)
```

```{r setup, include=FALSE}
### PURPOSE:
# This code aims to determine who is out, refusal, in, and eos after efficacy. This information comes from Safety, Safetynew, and Absence1stattempt. Then for each status (except of in), split each status into the "reason" or the "how" they got to that status.
# load required libraries
library(dplyr)
library(reactable)
library(data.table)
library(cloudbrewr)
library(fontawesome)
library(shiny)
library(tidyr)

ENV_PIPELINE_STAGE <- Sys.getenv("PIPELINE_STAGE")
DATA_STAGING_BUCKET_NAME <- 'databrew.org'
DATA_LAKE_BUCKET_NAME <- 'bohemia-lake-db'
PROJECT_SOURCE <- 'kwale'
SE_FOLDER_TARGET <- glue::glue('{PROJECT_SOURCE}/clean-form')

pad_hhid <- function(data){
  if('hhid' %in% names(data)){
    data %>%
      dplyr::mutate(hhid = stringr::str_pad(hhid, 5, pad = "0"))
  }else{
    data
  }
}


tryCatch({
  logger::log_info('Attempt AWS login')
  # login to AWS - this will be bypassed if executed in CI/CD environment
  cloudbrewr::aws_login(
    role_name = 'cloudbrewr-aws-role',
    profile_name =  'cloudbrewr-aws-role',
    pipeline_stage = ENV_PIPELINE_STAGE)

}, error = function(e){
  logger::log_error('AWS Login Failed')
  stop(e$message)
})


# load in the data
absence1stattempt <- cloudbrewr::aws_s3_get_table(
  bucket = DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/clean-form/absences1stattempt/absences1stattempt.csv')) %>%
  pad_hhid()

assignment <- cloudbrewr::aws_s3_get_table(
  bucket ='bohemia-lake-db',
  key = 'bohemia_ext_data/assignments/assignments.csv') %>%
  pad_hhid()

v0_dem_repeat <- cloudbrewr::aws_s3_get_table(
    bucket = DATA_STAGING_BUCKET_NAME,
    key = glue::glue('{PROJECT_SOURCE}/clean-form/v0demography/v0demography-repeat_individual.csv')) %>%
    pad_hhid()

v0_demography <- cloudbrewr::aws_s3_get_table(
    bucket = DATA_STAGING_BUCKET_NAME,
    key = glue::glue('{PROJECT_SOURCE}/clean-form/v0demography/v0demography.csv')) %>%
    pad_hhid()

efficacy <- cloudbrewr::aws_s3_get_table(
  bucket = DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/clean-form/efficacy/efficacy.csv')) %>%
  pad_hhid()

efficacy_targets <- cloudbrewr::aws_s3_get_table(
  bucket ='bohemia-lake-db',
  key = glue::glue('bohemia_prod/dwh/goal_efficacy_targets/goal_efficacy_targets.csv')) %>%
  pad_hhid()

efficacy_selection <- cloudbrewr::aws_s3_get_table(
  bucket ='bohemia-lake-db',
  key = glue::glue('bohemia_ext_data/efficacy_selection/efficacy_selection.csv'))
  # this contains six extids that were removed because they aged out:
  #'74052-06', # dob change led to not efficacy eligible (aka out of 5-15 years)
  #'18039-03', # "
  #'02042-03', # "
  #'02042-02', # "
  #'26007-03', # "
  #'56118-06') # these extids have been removed from the collected efficacy data


# this is a function to create a download csv button
wrap_download <- function(reactable_obj, element_id, output_filename){
  onclick_command <- glue::glue(
    "Reactable.downloadDataCSV('{element_id}', '{output_filename}')")
  htmltools::browsable(
    tagList(
      tags$button(
        tagList(fontawesome::fa("download"), "Download as CSV"),
        onclick = onclick_command),
      reactable_obj
    ))
}
```

```{r data creation}
# create the merged v0 data
  v0dem <- left_join(v0_dem_repeat, v0_demography, by=c('PARENT_KEY' = 'KEY'))  %>%
    select(extid, dob, sex, todays_date) %>%
    rename(dob_v0 = dob,
           todays_date_v0 = todays_date,
           sex_v0 = sex)

# Remove those who are in but haven't been contacted in 60 days; they are "lost to follow-up"
last_non_absent_visit <- efficacy %>%
  # remove absences / keep only presences
  filter(person_absent == 0) %>%
  # arrange from most recent
  arrange(desc(start_time)) %>%
  dplyr::distinct(extid, .keep_all = TRUE) %>%
  dplyr::select(extid, last_non_absent_visit = start_time) %>%
  mutate(last_non_absent_visit = as.Date(last_non_absent_visit))

individuals <- efficacy %>%
  left_join(last_non_absent_visit) %>%
  mutate(days_since_last_non_absent_visit = Sys.Date() - last_non_absent_visit) %>%
  mutate(ltfu = days_since_last_non_absent_visit >= 90)

# individuals <- individuals %>% filter(!ltfu | is.na(ltfu))
# # remove unnecessary columns
# individuals <- individuals %>%
#   dplyr::select(-last_non_absent_visit,
#                 -days_since_last_non_absent_visit,
#                 -ltfu)

# include efficacy information
  eff <- individuals %>%
    rename(dob_efficacy = dob,
           sex_efficacy = sex, 
           todays_date_efficacy = todays_date) %>%
    mutate(cluster = as.numeric(substr(extid, 1, 2)),
           enrolment = case_when(
      starting_efficacy_status == 'out' &
        efficacy_status != 'out' ~ 'enrolment',
      starting_efficacy_status == 'out' &
        efficacy_status == 'out' ~ 'not yet enrolled',
      TRUE ~ 'follow up'
    ),
          efficacy_reason = case_when(
            efficacy_status == 'in' ~ 'in',
            not_continue_eos == '1' ~ 'decline participation',
            not_agree_efficacy_procedures_eos == '1' ~ 'not agree to efficacy procedures',
            non_resident_eos == '1' ~ 'not a resident',
            other_trials_eos == '1' ~ 'enrolled in other trials',
            second_consecutive_absence_eos == '1' ~ 'ltfu: second consecutive absence',
            person_absent == '1' ~ 'absent',
            person_migrated_eos == '1' |
              person_unenrolled_migrated == '1' ~ 'migrated',
            person_unenrolled_died == '1' ~ 'died',
            thumbprint_status == '0' ~ 'thumbprint status',
            sign_icf_status == '0' ~ 'sign icf status',
            minor_assent_status == '0' ~ 'minor assent',
            ltfu == 'TRUE' ~ 'ltfu: > 60 days',
            #ltfu_eos == '1' ~ 'ltfu: > 60 days',
            TRUE ~ NA_character_  # To handle cases that don't match any condition
    ))
  
  assignment <- assignment %>%
    rename(cluster = cluster_number)
  
    total_eff <- left_join(eff, assignment, by='cluster')
  
  
# create the dataset that will be used for this script
  # this will exclude the people who were manually removed
  data <- left_join(total_eff, v0dem, by = c('extid')) %>%
    filter(extid != '74052-06', # dob change led to not efficacy eligible (aka out of 5-15 years)
           extid != '18039-03', # "
           extid != '02042-03', # "
           extid != '02042-02', # "
           extid != '26007-03', # "
           extid != '56118-06') # these extids have been removed from the data
  
# create the dataset for the extid explorer
  data_investigation <- data %>%
    filter(!is.na(visit)) %>% # removes extids not in Efficacy
    select(visit, extid, efficacy_status, enrolment, efficacy_reason, sex_v0, sex_efficacy, dob_v0, dob_efficacy, todays_date_v0, todays_date_efficacy)
  
  data <- data %>% distinct(extid, visit, .keep_all = TRUE)

  
  # a trial profile tracks where every person went
  by_visit <- data %>%
    pivot_wider(id_cols = c(extid, hhid, cluster, assignment), 
                names_from = visit,
                values_from = c(efficacy_status, efficacy_reason)) %>%
    select(extid, hhid, efficacy_status_V1, efficacy_status_V2, efficacy_status_V3,
           efficacy_status_V4, efficacy_status_V5, efficacy_reason_V1, efficacy_reason_V2, efficacy_reason_V3, 
           efficacy_reason_V4, efficacy_reason_V5, assignment, cluster) %>%
    rename(status_V1 = efficacy_status_V1,
           reason_V1 = efficacy_reason_V1,
           status_V2 = efficacy_status_V2,
           reason_V2 = efficacy_reason_V2,
           status_V3 = efficacy_status_V3,
           reason_V3 = efficacy_reason_V3,
           status_V4 = efficacy_status_V4,
           reason_V4 = efficacy_reason_V4,
           status_V5 = efficacy_status_V5,
           reason_V5 = efficacy_reason_V5)
```
```{r trial_by_visit}
# show the assignment of people who were in at each visit
trial_by_visit <- data %>%
  filter(efficacy_status == 'in') %>%
  group_by(visit, assignment) %>%
    summarise('N' = n()) %>%
    group_by(visit) %>%
    pivot_wider(names_from = assignment, values_from = N) %>%
    ungroup() %>%
    arrange(visit) %>%
    rename('IN people per visit' = visit) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

```

```{r efficacy_trial_profile_into}
######### EFFICACY SELECTION #############

efficacy_selected <- length(unique(efficacy_selection$extid))



############## V1 ##################
v1 <- total_eff %>% 
  filter(visit == 'V1') %>% 
  select(extid, hhid, visit, efficacy_status, efficacy_reason)

v1_total_visited <- length(unique(v1$extid))


###### AGED OUT
aged_out <- c('74052-06', '18039-03', '02042-03', '02042-02', '26007-03', '56118-06')
#table(aged_out %in% by_visit$extid) # not in by_visit
#table(aged_out %in% efficacy_selection$extid) # are in efficacy_preselection
num_aged_out <- length(aged_out)



####### NOT VISITED
v1_extid_not_visited <- anti_join(efficacy_selection, v1, by = 'extid') %>%
  filter(!(extid %in% aged_out)) %>%
  select(extid, hhid) %>%
  mutate(
    hhid = as.character(hhid),  # Convert hhid to character type to retain leading zeros
    hhid = sprintf("%05d", as.numeric(hhid)),  # Ensure hhid has leading zeros if necessary
    visit = 'V1',
    efficacy_status = 'out'
  ) 

num_v1_not_visited <- length(unique(v1_extid_not_visited$extid))


###### REMOVED INDIVIDUALS


v1_removed_extid_data <- v1 %>%
  filter(efficacy_status %in% c('refusal', 'eos') | efficacy_reason %in% c('migrated', 'died')) %>%
  mutate(removal_reason = paste(efficacy_status, efficacy_reason, sep = " "))

v1_removed_extids <- length(unique(v1_removed_extid_data$extid))

v1_removed_extid_table <- v1_removed_extid_data %>%
  arrange(visit) %>%
  group_by(removal_reason) %>%
  summarise('N' = n()) %>%
  arrange(removal_reason) %>%
  add_row(removal_reason = 'total', 
            'N' = sum(.$'N')) %>%
  rename('Removal Reason' = removal_reason)



# add the missed extids back in and remove the 100 refusal houses
v1_clean <- v1 %>%
  anti_join(v1_removed_extid_data, by = "extid") %>%
  bind_rows(v1_extid_not_visited) 

num_v1_clean <- length(unique(v1_clean$extid))



################ V2 ##################

v2 <- total_eff %>% 
  filter(visit == 'V2') %>% 
  select(extid, hhid, visit, efficacy_status, efficacy_reason)

v2_total_visited <- length(unique(v2$extid))


####### NOT VISITED

v2_extid_not_visited <- anti_join(v1_clean, v2, by = 'extid') %>%
  filter(!(extid %in% aged_out)) %>%
  select(extid, hhid, efficacy_status) %>%
  mutate(
    hhid = as.character(hhid),  # Convert hhid to character type to retain leading zeros
    hhid = sprintf("%05d", as.numeric(hhid)),  # Ensure hhid has leading zeros if necessary
    visit = 'V2'
  ) 

num_v2_not_visited <- length(unique(v2_extid_not_visited$extid))



###### REMOVED INDIVIDUALS


v2_removed_extid_data <- v2 %>%
  filter(efficacy_status %in% c('refusal', 'eos') | efficacy_reason %in% c('migrated', 'died')) %>%
  mutate(removal_reason = paste(efficacy_status, efficacy_reason, sep = " "))

v2_removed_extids <- length(unique(v2_removed_extid_data$extid))

v2_removed_extid_table <- v2_removed_extid_data %>%
  arrange(visit) %>%
  group_by(removal_reason) %>%
  summarise('N' = n()) %>%
  arrange(removal_reason) %>%
  add_row(removal_reason = 'total', 
            'N' = sum(.$'N')) %>% 
  rename('Removal Reason' = removal_reason)

# add the missed extids back in and remove the 100 refusal houses
v2_clean <- v2 %>%
  anti_join(v2_removed_extid_data, by = "extid") %>%
  bind_rows(v2_extid_not_visited) 

num_v2_clean <- length(unique(v2_clean$extid))



# v3 ###############################

v3 <- data %>% 
  filter(visit == 'V3') %>% 
  select(extid, hhid, visit, efficacy_status, efficacy_reason, enrolment)

v3_total_visited <- length(unique(v3$extid))


####### NOT VISITED

v3_extid_not_visited <- anti_join(v2_clean, v3, by = 'extid') %>%
  filter(!(extid %in% aged_out)) %>%
  select(extid, hhid, efficacy_status) %>%
  mutate(
    hhid = as.character(hhid),  # Convert hhid to character type to retain leading zeros
    hhid = sprintf("%05d", as.numeric(hhid)),  # Ensure hhid has leading zeros if necessary
    visit = 'V3'
  ) 

num_v3_not_visited <- length(unique(v3_extid_not_visited$extid))

v3_not_visited_keep <- v3_extid_not_visited %>%
  filter(efficacy_status == 'in')
num_v3_not_visited_keep <- length(unique(v3_not_visited_keep$extid))



###### REMOVED INDIVIDUALS


v3_removed_extid_data <- v3 %>%
  filter(efficacy_status %in% c('refusal', 'eos', 'out') | efficacy_reason %in% c('migrated', 'died') | enrolment == 'not yet enrolled') %>%
  mutate(removal_reason = ifelse(efficacy_status == 'out' & enrolment == 'not yet enrolled', 'never enrolled', 
                                  paste(efficacy_status, efficacy_reason, sep = " ")))

v3_removed_extids <- length(unique(v3_removed_extid_data$extid))

v3_removed_extid_table <- v3_removed_extid_data %>%
  arrange(visit) %>%
  group_by(removal_reason) %>%
  summarise('N' = n()) %>%
  arrange(removal_reason) %>%
  add_row(removal_reason = 'total', 
            'N' = sum(.$'N')) %>% 
  rename('Removal Reason' = removal_reason)

v3_never_enrolled <- v3_removed_extid_data %>%
  filter(enrolment == 'not yet enrolled')
num_v3_never_enrolled <- length(unique(v3_never_enrolled$extid))

# add the missed extids back in and remove the 100 refusal houses and not enrolled individuals
v3_clean <- v3 %>%
  anti_join(v3_removed_extid_data, by = "extid") %>%
  bind_rows(v3_not_visited_keep) 
  

num_v3_clean <- length(unique(v3_clean$extid))



# v4 ###############################

v4 <- data %>% 
  filter(visit == 'V4') %>% 
  select(extid, hhid, visit, efficacy_status, efficacy_reason)

v4_total_visited <- length(unique(v4$extid))


####### NOT VISITED

v4_extid_not_visited <- anti_join(v3_clean, v4, by = 'extid') %>%
  filter(!(extid %in% aged_out)) %>%
  select(extid, hhid) %>%
  mutate(
    hhid = as.character(hhid),  # Convert hhid to character type to retain leading zeros
    hhid = sprintf("%05d", as.numeric(hhid)),  # Ensure hhid has leading zeros if necessary
    visit = 'v4',
    efficacy_status = 'out'
  ) 

num_v4_not_visited <- length(unique(v4_extid_not_visited$extid))



###### REMOVED INDIVIDUALS


v4_removed_extid_data <- v4 %>%
  filter(efficacy_status %in% c('refusal', 'eos') | efficacy_reason %in% c('migrated', 'died')) %>%
  mutate(removal_reason = paste(efficacy_status, efficacy_reason, sep = " "))

v4_removed_extids <- length(unique(v4_removed_extid_data$extid))

v4_removed_extid_table <- v4_removed_extid_data %>%
  arrange(visit) %>%
  group_by(removal_reason) %>%
  summarise('N' = n()) %>%
  arrange(removal_reason) %>%
  add_row(removal_reason = 'total', 
            'N' = sum(.$'N')) %>% 
  rename('Removal Reason' = removal_reason)

# add the missed extids back in and remove the 100 refusal houses
v4_clean <- v4 %>%
  anti_join(v4_removed_extid_data, by = "extid") %>%
  bind_rows(v4_extid_not_visited) 

num_v4_clean <- length(unique(v4_clean$extid))



# v5 ###############################

v5 <- total_eff %>% 
  filter(visit == 'V5') %>% 
  select(extid, hhid, visit, efficacy_status, efficacy_reason)

v5_total_visited <- length(unique(v5$extid))


####### NOT VISITED

v5_extid_not_visited <- anti_join(v4_clean, v5, by = 'extid') %>%
  filter(!(extid %in% aged_out)) %>%
  select(extid, hhid) %>%
  mutate(
    hhid = as.character(hhid),  # Convert hhid to character type to retain leading zeros
    hhid = sprintf("%05d", as.numeric(hhid)),  # Ensure hhid has leading zeros if necessary
    visit = 'v5',
    efficacy_status = 'out'
  ) 

num_v5_not_visited <- length(unique(v5_extid_not_visited$extid))



###### REMOVED INDIVIDUALS


v5_removed_extid_data <- v5 %>%
  filter(efficacy_status %in% c('refusal', 'eos') | efficacy_reason %in% c('migrated', 'died')) %>%
  mutate(removal_reason = paste(efficacy_status, efficacy_reason, sep = " "))

v5_removed_extids <- length(unique(v5_removed_extid_data$extid))

v5_removed_extid_table <- v5_removed_extid_data %>%
  arrange(visit) %>%
  group_by(removal_reason) %>%
  summarise('N' = n()) %>%
  arrange(removal_reason) %>%
  add_row(removal_reason = 'total', 
            'N' = sum(.$'N')) %>% 
  rename('Removal Reason' = removal_reason)

# add the missed extids back in and remove the 100 refusal houses
v5_clean <- v5 %>%
  anti_join(v5_removed_extid_data, by = "extid") %>%
  bind_rows(v5_extid_not_visited) 

num_v5_clean <- length(unique(v5_clean$extid))



# v6 ###############################

v6 <- total_eff %>% 
  filter(visit == 'V6') %>% 
  select(extid, hhid, visit, efficacy_status, efficacy_reason)

v6_total_visited <- length(unique(v6$extid))


####### NOT VISITED

v6_extid_not_visited <- anti_join(v5_clean, v6, by = 'extid') %>%
  filter(!(extid %in% aged_out)) %>%
  select(extid, hhid) %>%
  mutate(
    hhid = as.character(hhid),  # Convert hhid to character type to retain leading zeros
    hhid = sprintf("%05d", as.numeric(hhid)),  # Ensure hhid has leading zeros if necessary
    visit = 'v6',
    efficacy_status = 'out'
  ) 

num_v6_not_visited <- length(unique(v6_extid_not_visited$extid))



###### REMOVED INDIVIDUALS


v6_removed_extid_data <- v6 %>%
  filter(efficacy_status %in% c('refusal', 'eos') | efficacy_reason %in% c('migrated', 'died')) %>%
  mutate(removal_reason = paste(efficacy_status, efficacy_reason, sep = " "))

v6_removed_extids <- length(unique(v6_removed_extid_data$extid))

v6_removed_extid_table <- v6_removed_extid_data %>%
  arrange(visit) %>%
  group_by(removal_reason) %>%
  summarise('N' = n()) %>%
  arrange(removal_reason) %>%
  add_row(removal_reason = 'total', 
            'N' = sum(.$'N')) %>% 
  rename('Removal Reason' = removal_reason)

# add the missed extids back in and remove the 100 refusal houses
v6_clean <- v6 %>%
  anti_join(v6_removed_extid_data, by = "extid") %>%
  bind_rows(v6_extid_not_visited) 

num_v6_clean <- length(unique(v6_clean$extid))



# v7 ###############################

v7 <- total_eff %>% 
  filter(visit == 'V7') %>% 
  select(extid, hhid, visit, efficacy_status, efficacy_reason)

v7_total_visited <- length(unique(v7$extid))


####### NOT VISITED

v7_extid_not_visited <- anti_join(v6_clean, v7, by = 'extid') %>%
  filter(!(extid %in% aged_out)) %>%
  select(extid, hhid) %>%
  mutate(
    hhid = as.character(hhid),  # Convert hhid to character type to retain leading zeros
    hhid = sprintf("%05d", as.numeric(hhid)),  # Ensure hhid has leading zeros if necessary
    visit = 'v7',
    efficacy_status = 'out'
  ) 

num_v7_not_visited <- length(unique(v7_extid_not_visited$extid))



###### REMOVED INDIVIDUALS


v7_removed_extid_data <- v7 %>%
  filter(efficacy_status %in% c('refusal', 'eos') | efficacy_reason %in% c('migrated', 'died')) %>%
  mutate(removal_reason = paste(efficacy_status, efficacy_reason, sep = " "))

v7_removed_extids <- length(unique(v7_removed_extid_data$extid))

v7_removed_extid_table <- v7_removed_extid_data %>%
  arrange(visit) %>%
  group_by(removal_reason) %>%
  summarise('N' = n()) %>%
  arrange(removal_reason) %>%
  add_row(removal_reason = 'total', 
            'N' = sum(.$'N')) %>% 
  rename('Removal Reason' = removal_reason)

# add the missed extids back in and remove the 100 refusal houses
v7_clean <- v7 %>%
  anti_join(v7_removed_extid_data, by = "extid") %>%
  bind_rows(v7_extid_not_visited) 

num_v7_clean <- length(unique(v7_clean$extid))

v7_clean_extid_table <- v7_clean %>%
  arrange(visit) %>%
  group_by(efficacy_status) %>%
  summarise('N' = n()) %>%
  arrange(efficacy_status) %>%
  add_row(efficacy_status = 'total', 
            'N' = sum(.$'N')) %>% 
  rename('Efficacy Status' = efficacy_status)


```

```{r enrolled}
# create a dataset of enrolled participants (people who became efficacy status in)
  enrolled <- data %>%
    filter(enrolment == 'enrolment',
           efficacy_status == 'in') 

  amount_enrolled <- length(unique(enrolled$extid))
  
  enrolled_data <- data %>%
    filter(extid %in% enrolled$extid) %>%
    arrange(desc(visit)) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() 
  
  enrolled_table <- enrolled_data %>%
    arrange(visit) %>%
    group_by(efficacy_status, assignment) %>%
    summarise('N' = n()) %>%
    group_by(efficacy_status) %>%
    pivot_wider(names_from = assignment, values_from = N) %>%
    ungroup() %>%
    arrange(efficacy_status) %>%
    rename('ENROLLED status' = efficacy_status) %>%
    add_row('ENROLLED status' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')
  
  # enrolled eos
  enrol_eos <- by_visit %>%
    filter(extid %in% enrolled$extid,
           status_V2 == 'eos' |
             status_V3 == 'eos' |
             status_V4 == 'eos' |
             status_V5 == 'eos')
  
  enrol_eos_data <- data %>%
    filter(extid %in% enrol_eos$extid,
           efficacy_status == 'eos') %>%
    arrange(visit) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() 
  
  enrol_eos_table <- enrol_eos_data %>%
    arrange(visit) %>%
    group_by(efficacy_reason, assignment) %>%
    summarise('N' = n()) %>%
    group_by(efficacy_reason) %>%
    pivot_wider(names_from = assignment, values_from = N, values_fill = 0) %>%
    ungroup() %>%
    arrange(efficacy_reason) %>%
    rename('EOS reason' = efficacy_reason) %>%
    add_row('EOS reason' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

  # enrolled in
  enrol_in <- by_visit %>%
    filter(extid %in% enrolled$extid,
           !(extid %in% enrol_eos_data$extid),
           status_V5 == 'in' | is.na(status_V5))
  
  enrol_in_data <- data %>%
    filter(extid %in% enrol_in$extid,
           efficacy_status == 'in') %>%
    arrange(visit) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup()
  
  enrol_in_table <- enrol_in_data %>%
    arrange(visit) %>%
    group_by(efficacy_status, assignment) %>%
    summarise('N' = n()) %>%
    group_by(efficacy_status) %>%
    pivot_wider(names_from = assignment, values_from = N, values_fill = 0) %>%
    ungroup() %>%
    rename('Enrolled reason' = efficacy_status) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')
  
  merged <- merge(enrol_eos_data, enrol_in, by='extid', all = TRUE)
  
  
  # enrolled completion # will be used later
  # enrol_comp <- by_visit %>%
  #   filter(extid %in% enrolled$extid,
  #          status_V7 == 'completion')
  # 
  # enrol_comp_table <- data %>%
  #   filter(extid %in% enrol_comp$extid,
  #          efficacy_status == 'completion') %>%
  #   arrange(visit) %>%
  #   group_by(efficacy_status, assignment) %>%
  #   summarise('N' = n()) %>%
  #   group_by(efficacy_status) %>%
  #   pivot_wider(names_from = assignment, values_from = N, values_fill = 0) %>%
  #   ungroup() %>%
  #   rename('Enrolled reason' = efficacy_status) %>%
  #   mutate(Total = `1` + `2`) %>%
  #   rename('Assignment 1' = '1',
  #          'Assignment 2' = '2')

```

```{r not_enrolled}

# not enrolled participants
  
  not_enrolled <- by_visit %>%
    filter(!(extid %in% enrolled$extid))

  amount_not_enrolled <- length(unique(not_enrolled$extid))
  
  not_enrolled_data <- data %>%
    filter(extid %in% not_enrolled$extid) %>%
    arrange(desc(visit)) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() 
  
  not_enrolled_table <- not_enrolled_data %>%
    arrange(visit) %>%
    group_by(efficacy_status, assignment) %>%
    summarise('N' = n()) %>%
    group_by(efficacy_status) %>%
    pivot_wider(names_from = assignment, values_from = N) %>%
    ungroup() %>%
    arrange(efficacy_status) %>%
    rename('NOT ENROLLED status' = efficacy_status) %>%
    add_row('NOT ENROLLED status' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

# EOS

  not_enrol_eos <- by_visit %>%
  filter(
    extid %in% not_enrolled$extid,
    (status_V1 == 'eos' | is.na(status_V1) | status_V1 == 'out') &
    (status_V2 == 'eos' | is.na(status_V2) | status_V2 == 'out') &
    (status_V3 == 'eos' | is.na(status_V3)) &
    (status_V4 == 'eos' | is.na(status_V4)) &
    (status_V5 == 'eos' | is.na(status_V5))
  )
  
  not_enrol_eos_data <- data %>%
    filter(extid %in% not_enrol_eos$extid,
           efficacy_status == 'eos') %>%
    arrange(visit) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() 
  
  not_enrol_eos_table <- not_enrol_eos_data %>%
    arrange(visit) %>%
    group_by(efficacy_reason, assignment) %>%
    summarise('N' = n()) %>%
    group_by(efficacy_reason) %>%
    pivot_wider(names_from = assignment, values_from = N, values_fill = 0) %>%
    ungroup() %>%
    arrange(efficacy_reason) %>%
    rename('EOS reason' = efficacy_reason) %>%
    add_row('EOS reason' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

# OUT
  
  not_enrol_out <- by_visit %>%
    filter(extid %in% not_enrolled$extid,
           (status_V1 == 'out' |
              is.na(status_V1)) &
             (status_V2 == 'out' |
                is.na(status_V2)) &
             (status_V3 == 'out' |
                is.na(status_V3)) &
             (status_V4 == 'out' | 
                is.na(status_V4)) &
             (status_V5 == 'out' | 
                is.na(status_V5)))
  
  not_enrol_out_data <- data %>%
    filter(extid %in% not_enrol_out$extid,
           efficacy_status == 'out') %>%
    arrange(visit) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() 
  
  not_enrol_out_table <- not_enrol_out_data %>%
    arrange(visit) %>%
    group_by(efficacy_reason, assignment) %>%
    summarise('N' = n()) %>%
    group_by(efficacy_reason) %>%
    pivot_wider(names_from = assignment, values_from = N, values_fill = 0) %>%
    ungroup() %>%
    arrange(efficacy_reason) %>%
    rename('OUT reason' = efficacy_reason) %>%
    add_row('OUT reason' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

# REFUSAL
  
  not_enrol_ref <- data %>%
    filter(extid %in% not_enrolled$extid,
           efficacy_status == 'refusal')
  
  not_enrol_ref_data <- data %>%
    filter(extid %in% not_enrol_ref$extid,
           efficacy_status == 'refusal') %>%
    arrange(visit) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() 
  
  not_enrol_ref_table <- not_enrol_ref_data %>%
    arrange(visit) %>%
    group_by(efficacy_reason, assignment) %>%
    summarise('N' = n()) %>%
    group_by(efficacy_reason) %>%
    pivot_wider(names_from = assignment, values_from = N, values_fill = 0) %>%
    ungroup() %>%
    arrange(efficacy_reason) %>%
    rename('REFUSAL reason' = efficacy_reason) %>%
    add_row('REFUSAL reason' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

```

```{r not_and_enrolled}
trial_profile <- data %>%
  mutate(enrolled = case_when(
    extid %in% enrolled$extid ~ 'enrolled',
    extid %in% not_enrolled$extid ~ 'not enrolled'
  )) %>%
  select(extid, visit, enrolled, assignment) %>%
  filter(!(is.na(assignment))) %>%
    arrange(visit) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup()

total_trial_table <- trial_profile %>%
    arrange(visit) %>%
    group_by(enrolled, assignment) %>%
    summarise('N' = n()) %>%
    group_by(enrolled) %>%
    pivot_wider(names_from = assignment, values_from = N, values_fill = 0) %>%
    ungroup() %>%
    arrange(enrolled) %>%
    rename('enrolment status' = enrolled) %>%
    add_row('enrolment status' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

```

```{r targets}
# these numbers are determined by Aryton based on Joe's logic and are stored in AWS
target_table <- efficacy_targets %>%
  group_by(visit) %>%
  summarise(hh_target = sum(hh_target),
            ind_target = sum(ind_target))

# identify how many households were visited in V1 and V2
total_efficacy <- efficacy %>%
  group_by(visit) %>%
  summarise(hh_visited = n_distinct(hhid),
            ind_visited = n_distinct(extid))

# join the number of households visited and targets
target_table <- left_join(target_table, total_efficacy, by = c('visit'))

target_table <- target_table %>%
  select(visit, ind_target, ind_visited, hh_target, hh_visited) %>%
  rename(Visit = visit,
         'Individual target' = ind_target,
         'Individual visited' = ind_visited,
         'HH target' = hh_target,
         'HH visited' = hh_visited)
```

```{r total}
## this will create the table of how many people are in, out, refusal, or eos in efficacy v1

# only take the necessary columns from efficacy
total_efficacy <- data %>%
  select(KEY, extid, visit, efficacy_status)

# since this is only a table for V1 we will only keep V1 people
total_efficacy_v1 <- total_efficacy %>%
  filter(visit == 'V1')

  # create a summary table of efficacy_status counts
  # P.S. the efficacy v1 target was determined based on a file received from Joe
  total_efficacy_status_v1 <- total_efficacy_v1 %>%
    group_by(efficacy_status) %>%
    summarise('Number of people visited in V1' = n()) %>%
    arrange(efficacy_status) %>%
    rename('Efficacy status' = efficacy_status) %>%
    add_row('Efficacy status' = 'total people visited', 'Number of people visited in V1' = sum(.$'Number of people visited in V1')) %>%
    mutate('Percent complete' = (as.numeric(`Number of people visited in V1`)) / as.numeric(nrow(total_efficacy_v1)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%'))

# totals for V2
total_efficacy_v2 <- data %>%
  filter(visit == 'V2')

  total_efficacy_status_v2 <- total_efficacy_v2 %>%
      group_by(efficacy_status) %>%
      summarise('Number of people visited in V2' = n()) %>%
      arrange(efficacy_status) %>%
      rename('Efficacy status' = efficacy_status) %>%
      add_row('Efficacy status' = 'total people visited', 'Number of people visited in V2' = sum(.$'Number of people visited in V2')) %>%
      mutate('Percent complete' = (as.numeric(`Number of people visited in V2`)) / as.numeric(nrow(total_efficacy_v2)) * 100) %>%
      mutate('Percent complete' = round(`Percent complete`, 2)) %>%
      mutate('Percent complete' = paste0(`Percent complete`, '%'))
  
# totals for V3
total_efficacy_v3 <- data %>%
  filter(visit == 'V3')

  total_efficacy_status_v3 <- total_efficacy_v3 %>%
      group_by(efficacy_status) %>%
      summarise('Number of people visited in V3' = n()) %>%
      arrange(efficacy_status) %>%
      rename('Efficacy status' = efficacy_status) %>%
      add_row('Efficacy status' = 'total people visited', 'Number of people visited in V3' = sum(.$'Number of people visited in V3')) %>%
      mutate('Percent complete' = (as.numeric(`Number of people visited in V3`)) / as.numeric(nrow(total_efficacy_v3)) * 100) %>%
      mutate('Percent complete' = round(`Percent complete`, 2)) %>%
      mutate('Percent complete' = paste0(`Percent complete`, '%'))
  
  
# totals for V4
total_efficacy_v4 <- data %>%
  filter(visit == 'V4')

  total_efficacy_status_v4 <- total_efficacy_v4 %>%
      group_by(efficacy_status) %>%
      summarise('Number of people visited in V4' = n()) %>%
      arrange(efficacy_status) %>%
      rename('Efficacy status' = efficacy_status) %>%
      add_row('Efficacy status' = 'total people visited', 'Number of people visited in V4' = sum(.$'Number of people visited in V4')) %>%
      mutate('Percent complete' = (as.numeric(`Number of people visited in V4`)) / as.numeric(nrow(total_efficacy_v4)) * 100) %>%
      mutate('Percent complete' = round(`Percent complete`, 2)) %>%
      mutate('Percent complete' = paste0(`Percent complete`, '%'))
  

# totals for V5
total_efficacy_v5 <- data %>%
  filter(visit == 'V5')

  total_efficacy_status_v5 <- total_efficacy_v5 %>%
      group_by(efficacy_status) %>%
      summarise('Number of people visited in V5' = n()) %>%
      arrange(efficacy_status) %>%
      rename('Efficacy status' = efficacy_status) %>%
      add_row('Efficacy status' = 'total people visited', 'Number of people visited in V5' = sum(.$'Number of people visited in V5')) %>%
      mutate('Percent complete' = (as.numeric(`Number of people visited in V5`)) / as.numeric(nrow(total_efficacy_v5)) * 100) %>%
      mutate('Percent complete' = round(`Percent complete`, 2)) %>%
      mutate('Percent complete' = paste0(`Percent complete`, '%'))
  
  
# totals for V6
total_efficacy_v6 <- data %>%
  filter(visit == 'V6')

  total_efficacy_status_v6 <- total_efficacy_v6 %>%
      group_by(efficacy_status) %>%
      summarise('Number of people visited in V6' = n()) %>%
      arrange(efficacy_status) %>%
      rename('Efficacy status' = efficacy_status) %>%
      add_row('Efficacy status' = 'total people visited', 'Number of people visited in V6' = sum(.$'Number of people visited in V6')) %>%
      mutate('Percent complete' = (as.numeric(`Number of people visited in V6`)) / as.numeric(nrow(total_efficacy_v6)) * 100) %>%
      mutate('Percent complete' = round(`Percent complete`, 2)) %>%
      mutate('Percent complete' = paste0(`Percent complete`, '%'))
  
  
# totals for V7
total_efficacy_v7 <- data %>%
  filter(visit == 'V7')

  total_efficacy_status_v7 <- total_efficacy_v7 %>%
      group_by(efficacy_status) %>%
      summarise('Number of people visited in V7' = n()) %>%
      arrange(efficacy_status) %>%
      rename('Efficacy status' = efficacy_status) %>%
      add_row('Efficacy status' = 'total people visited', 'Number of people visited in V7' = sum(.$'Number of people visited in V7')) %>%
      mutate('Percent complete' = (as.numeric(`Number of people visited in V7`)) / as.numeric(nrow(total_efficacy_v7)) * 100) %>%
      mutate('Percent complete' = round(`Percent complete`, 2)) %>%
      mutate('Percent complete' = paste0(`Percent complete`, '%'))
```


```{r in}
## create a table of how many people are in as enrolment and in as follow up in Efficacy

## V1 was checked for all enrolment

## V2 ##########################

efficacy_v2_in <- eff %>%
    filter(visit == 'V2',
           efficacy_status == 'in')
  
  # create a table that shows how many people are follow up and enrolment in V2
  # make a table of reasons people are eos
  in_type_v2 <- efficacy_v2_in %>%
    group_by(enrolment) %>%
    summarise('Number of in people' = n()) %>%
    arrange(enrolment) %>%
    rename('Visit type' = enrolment) %>%
    add_row('Visit type' = 'total in', 'Number of in people' = sum(.$'Number of in people')) %>%
    mutate('Percent' = (as.numeric(`Number of in people`)) / as.numeric(nrow(efficacy_v2_in)) * 100) %>%
    mutate('Percent' = round(`Percent`, 2)) %>%
    mutate('Percent' = paste0(`Percent`, '%')) # Replace zero values with NA
  
  
## V3 #######################
  
  efficacy_v3_in <- eff %>%
    filter(visit == 'V3',
           efficacy_status == 'in')
  
  # create a table that shows how many people are follow up and enrolment in V2
  # make a table of reasons people are eos
  in_type_v3 <- efficacy_v3_in %>%
    group_by(enrolment) %>%
    summarise('Number of in people' = n()) %>%
    arrange(enrolment) %>%
    rename('Visit type' = enrolment) %>%
    add_row('Visit type' = 'total in', 'Number of in people' = sum(.$'Number of in people')) %>%
    mutate('Percent' = (as.numeric(`Number of in people`)) / as.numeric(nrow(efficacy_v3_in)) * 100) %>%
    mutate('Percent' = round(`Percent`, 2)) %>%
    mutate('Percent' = paste0(`Percent`, '%')) # Replace zero values with NA
  
  
## V4 #####################
  
  efficacy_v4_in <- eff %>%
    filter(visit == 'V4',
           efficacy_status == 'in')
  
  # create a table that shows how many people are follow up and enrolment in V2
  # make a table of reasons people are eos
  in_type_v4 <- efficacy_v4_in %>%
    group_by(enrolment) %>%
    summarise('Number of in people' = n()) %>%
    arrange(enrolment) %>%
    rename('Visit type' = enrolment) %>%
    add_row('Visit type' = 'total in', 'Number of in people' = sum(.$'Number of in people')) %>%
    mutate('Percent' = (as.numeric(`Number of in people`)) / as.numeric(nrow(efficacy_v4_in)) * 100) %>%
    mutate('Percent' = round(`Percent`, 2)) %>%
    mutate('Percent' = paste0(`Percent`, '%')) # Replace zero values with NA


## V5 #########################
  
  efficacy_v5_in <- eff %>%
    filter(visit == 'V5',
           efficacy_status == 'in')
  
  # create a table that shows how many people are follow up and enrolment in V2
  # make a table of reasons people are eos
  in_type_v5 <- efficacy_v5_in %>%
    group_by(enrolment) %>%
    summarise('Number of in people' = n()) %>%
    arrange(enrolment) %>%
    rename('Visit type' = enrolment) %>%
    add_row('Visit type' = 'total in', 'Number of in people' = sum(.$'Number of in people')) %>%
    mutate('Percent' = (as.numeric(`Number of in people`)) / as.numeric(nrow(efficacy_v5_in)) * 100) %>%
    mutate('Percent' = round(`Percent`, 2)) %>%
    mutate('Percent' = paste0(`Percent`, '%')) # Replace zero values with NA
  
  
## V6 #####################
  
  efficacy_v6_in <- eff %>%
    filter(visit == 'V6',
           efficacy_status == 'in')
  
  # create a table that shows how many people are follow up and enrolment in V2
  # make a table of reasons people are eos
  in_type_v6 <- efficacy_v6_in %>%
    group_by(enrolment) %>%
    summarise('Number of in people' = n()) %>%
    arrange(enrolment) %>%
    rename('Visit type' = enrolment) %>%
    add_row('Visit type' = 'total in', 'Number of in people' = sum(.$'Number of in people')) %>%
    mutate('Percent' = (as.numeric(`Number of in people`)) / as.numeric(nrow(efficacy_v6_in)) * 100) %>%
    mutate('Percent' = round(`Percent`, 2)) %>%
    mutate('Percent' = paste0(`Percent`, '%')) # Replace zero values with NA
  
  
## V7 ####################
  
  efficacy_v7_in <- eff %>%
    filter(visit == 'V7',
           efficacy_status == 'in')
  
  # create a table that shows how many people are follow up and enrolment in V2
  # make a table of reasons people are eos
  in_type_v7 <- efficacy_v7_in %>%
    group_by(enrolment) %>%
    summarise('Number of in people' = n()) %>%
    arrange(enrolment) %>%
    rename('Visit type' = enrolment) %>%
    add_row('Visit type' = 'total in', 'Number of in people' = sum(.$'Number of in people')) %>%
    mutate('Percent' = (as.numeric(`Number of in people`)) / as.numeric(nrow(efficacy_v7_in)) * 100) %>%
    mutate('Percent' = round(`Percent`, 2)) %>%
    mutate('Percent' = paste0(`Percent`, '%')) # Replace zero values with NA
  
```

```{r eos}
## this will create a table of how many people are eos and why they are eos

## V1 ############################# 
  efficacy_eos_v1 <- data %>%
    filter(visit == 'V1',
           efficacy_status == 'eos')
  
  # make a table of why people are eos
  eos_reasons_v1 <- efficacy_eos_v1 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for eos' = efficacy_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(efficacy_eos_v1)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  

## V2 ###########################
  
  efficacy_eos_v2 <- data %>%
    filter(visit == 'V2',
           efficacy_status == 'eos')
  
  # make a table of why people are eos
  eos_reasons_v2 <- efficacy_eos_v2 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for eos' = efficacy_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(efficacy_eos_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

# create datasets to make an enrolment and follow up eos table
  total_eff_eos_enrolment_v2 <- efficacy_eos_v2 %>%
    filter(enrolment == 'enrolment')
  total_eff_eos_followup_v2 <- efficacy_eos_v2 %>%
    filter(enrolment == 'follow up')
  
# make a table of enrolment people who are eos
  eos_reasons_enrolment_v2 <- total_eff_eos_enrolment_v2 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for eos' = efficacy_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(total_eff_eos_enrolment_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

# make a table of reasons follow up people are eos #
  eos_reasons_followup_v2 <- total_eff_eos_followup_v2 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for eos' = efficacy_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(total_eff_eos_followup_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

  
## V3 ###########################
  
  efficacy_eos_v3 <- data %>%
    filter(visit == 'V3',
           efficacy_status == 'eos')
  
  # make a table of why people are eos
  eos_reasons_v3 <- efficacy_eos_v3 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for eos' = efficacy_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(efficacy_eos_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

# create datasets to make an enrolment and follow up eos table
  total_eff_eos_enrolment_v3 <- efficacy_eos_v3 %>%
    filter(enrolment == 'enrolment')
  total_eff_eos_followup_v3 <- efficacy_eos_v3 %>%
    filter(enrolment == 'follow up')
  
# make a table of enrolment people who are eos
  eos_reasons_enrolment_v3 <- total_eff_eos_enrolment_v3 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for eos' = efficacy_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(total_eff_eos_enrolment_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

# make a table of reasons follow up people are eos #
  eos_reasons_followup_v3 <- total_eff_eos_followup_v3 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for eos' = efficacy_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(total_eff_eos_followup_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

  
## V4 ###########################
  
  efficacy_eos_v4 <- data %>%
    filter(visit == 'V4',
           efficacy_status == 'eos')
  
  # make a table of why people are eos
  eos_reasons_v4 <- efficacy_eos_v4 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for eos' = efficacy_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(efficacy_eos_v4)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V5 ###########################
  
  efficacy_eos_v5 <- data %>%
    filter(visit == 'V5',
           efficacy_status == 'eos')
  
  # make a table of why people are eos
  eos_reasons_v5 <- efficacy_eos_v5 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for eos' = efficacy_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(efficacy_eos_v5)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V6 ###########################
  
  efficacy_eos_v6 <- data %>%
    filter(visit == 'V6',
           efficacy_status == 'eos')
  
  # make a table of why people are eos
  eos_reasons_v6 <- efficacy_eos_v6 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for eos' = efficacy_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(efficacy_eos_v6)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V7 ###########################
  
  efficacy_eos_v7 <- data %>%
    filter(visit == 'V7',
           efficacy_status == 'eos')
  
  # make a table of why people are eos
  eos_reasons_v7 <- efficacy_eos_v7 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for eos' = efficacy_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(efficacy_eos_v7)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

```

```{r out}
## this will create a table of how many people are out and why they are out

## V1 ########################### 
  efficacy_out_v1 <- data %>%
    filter(visit == 'V1',
           efficacy_status == 'out')
  
  out_reasons_v1 <- efficacy_out_v1 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for out' = efficacy_reason) %>%
    add_row('Reason for out' = 'total visited', 'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / as.numeric(nrow(efficacy_out_v1)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
   
## V2 ##############################
  
  efficacy_out_v2 <- data %>%
    filter(visit == 'V2',
           efficacy_status == 'out')
  
    # make a table of why people are out
  out_reasons_v2 <- efficacy_out_v2 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for out' = efficacy_reason) %>%
    add_row('Reason for out' = 'total visited', 'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / as.numeric(nrow(efficacy_out_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

  
## V3 ##############################
  
  efficacy_out_v3 <- data %>%
    filter(visit == 'V3',
           efficacy_status == 'out')
  
    # make a table of why people are out
  out_reasons_v3 <- efficacy_out_v3 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for out' = efficacy_reason) %>%
    add_row('Reason for out' = 'total visited', 'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / as.numeric(nrow(efficacy_out_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V4 ##############################
  
  efficacy_out_v4 <- data %>%
    filter(visit == 'V4',
           efficacy_status == 'out')
  
    # make a table of why people are out
  out_reasons_v4 <- efficacy_out_v4 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for out' = efficacy_reason) %>%
    add_row('Reason for out' = 'total visited', 'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / as.numeric(nrow(efficacy_out_v4)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V5 ##############################
  
  efficacy_out_v5 <- data %>%
    filter(visit == 'V5',
           efficacy_status == 'out')
  
    # make a table of why people are out
  out_reasons_v5 <- efficacy_out_v5 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for out' = efficacy_reason) %>%
    add_row('Reason for out' = 'total visited', 'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / as.numeric(nrow(efficacy_out_v5)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V6 ##############################
  
  efficacy_out_v6 <- data %>%
    filter(visit == 'V6',
           efficacy_status == 'out')
  
    # make a table of why people are out
  out_reasons_v6 <- efficacy_out_v6 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for out' = efficacy_reason) %>%
    add_row('Reason for out' = 'total visited', 'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / as.numeric(nrow(efficacy_out_v6)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V7 ##############################
  
  efficacy_out_v7 <- data %>%
    filter(visit == 'V7',
           efficacy_status == 'out')
  
    # make a table of why people are out
  out_reasons_v7 <- efficacy_out_v7 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for out' = efficacy_reason) %>%
    add_row('Reason for out' = 'total visited', 'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / as.numeric(nrow(efficacy_out_v7)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
```

```{r refusal}
## this will create a table of how many people are refusal and why they are refusal

## V1 ########################### 
  efficacy_refusal_v1 <- data %>%
    filter(visit == 'V1',
           efficacy_status == 'refusal')
  
  refusal_reasons_v1 <- efficacy_refusal_v1 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for refusal' = efficacy_reason) %>%
    add_row('Reason for refusal' = 'total visited', 'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / as.numeric(nrow(efficacy_refusal_v1)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
   
## V2 ##############################
  
  efficacy_refusal_v2 <- data %>%
    filter(visit == 'V2',
           efficacy_status == 'refusal')
  
  refusal_reasons_v2 <- efficacy_refusal_v2 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for refusal' = efficacy_reason) %>%
    add_row('Reason for refusal' = 'total visited', 'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / as.numeric(nrow(efficacy_refusal_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  

## V3 ##############################
  
  efficacy_refusal_v3 <- data %>%
    filter(visit == 'V3',
           efficacy_status == 'refusal')
  
  refusal_reasons_v3 <- efficacy_refusal_v3 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for refusal' = efficacy_reason) %>%
    add_row('Reason for refusal' = 'total visited', 'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / as.numeric(nrow(efficacy_refusal_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  

## V4 ##############################
  
  efficacy_refusal_v4 <- data %>%
    filter(visit == 'V4',
           efficacy_status == 'refusal')
  
  refusal_reasons_v4 <- efficacy_refusal_v4 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for refusal' = efficacy_reason) %>%
    add_row('Reason for refusal' = 'total visited', 'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / as.numeric(nrow(efficacy_refusal_v4)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V5 ##############################
  
  efficacy_refusal_v5 <- data %>%
    filter(visit == 'V5',
           efficacy_status == 'refusal')
  
  refusal_reasons_v5 <- efficacy_refusal_v5 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for refusal' = efficacy_reason) %>%
    add_row('Reason for refusal' = 'total visited', 'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / as.numeric(nrow(efficacy_refusal_v5)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V6 ##############################
  
  efficacy_refusal_v6 <- data %>%
    filter(visit == 'V6',
           efficacy_status == 'refusal')
  
  refusal_reasons_v6 <- efficacy_refusal_v6 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for refusal' = efficacy_reason) %>%
    add_row('Reason for refusal' = 'total visited', 'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / as.numeric(nrow(efficacy_refusal_v6)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V7 ##############################
  
  efficacy_refusal_v7 <- data %>%
    filter(visit == 'V7',
           efficacy_status == 'refusal')
  
  refusal_reasons_v7 <- efficacy_refusal_v7 %>%
    group_by(efficacy_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(efficacy_reason) %>%
    rename('Reason for refusal' = efficacy_reason) %>%
    add_row('Reason for refusal' = 'total visited', 'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / as.numeric(nrow(efficacy_refusal_v7)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
```

```{r rdt-results}
# present the rdt results for the different visits
  eff_results <- efficacy %>%
    select(extid, cluster, pan_result, pf_result, visit, efficacy_status) %>%
    mutate(combination = case_when(pan_result == 'Positive' & pf_result == 'Positive' ~ 'pan + pf +',
                                   pan_result == 'Negative' & pf_result == 'Negative' ~ 'pan - pf -',
                                   pan_result == 'Positive' & pf_result == 'Negative' ~ 'pan + pf -',
                                   pan_result == 'Negative' & pf_result == 'Positive' ~ 'pan - pf +',
                                   pan_result == '' & pf_result == '' ~ 'blank test responses'))


## V1 #################################
  
  eff_results_v1 <- eff_results %>%
    filter(visit == 'V1', 
           efficacy_status == 'in')
  
  # make combination into individual columns
  eff_results_v1_edited <- eff_results_v1 %>%
    mutate(
      neg_pos = ifelse(pan_result == 'Negative' & pf_result == 'Positive', 1, 0),
      pos_neg = ifelse(pan_result == 'Positive' & pf_result == 'Negative', 1, 0),
      pos_pos = ifelse(pan_result == 'Positive' & pf_result == 'Positive', 1, 0),
      neg_neg = ifelse(pan_result == 'Negative' & pf_result == 'Negative', 1, 0)
    )
  
  # Using the four combinations of test possibilities (pan+/-;pf+/-), create a table by cluster which is downloadable.
  eff_cluster_rdt_results_v1 <- eff_results_v1_edited %>%
    group_by(cluster) %>%
    summarise('pan+ pf+' = sum(pos_pos),
              'pan+ pf-' = sum(pos_neg),
              'pan- pf+' = sum(neg_pos),
              'pan- pf-' = sum(neg_neg)) %>%
    rename(Cluster = cluster)

# we want to see the rates of malaria. So create a table of totals (all clusters) of the proportions of the four ways using (pan+/-;pf+/-). Include percentages of each for the entire study.
  eff_results_v1_clean <- eff_results_v1 %>%
    filter(combination != 'blank test responses')
  
  eff_rdt_prop_totals_v1 <- eff_results_v1_clean %>%
    group_by(combination) %>%
    summarise('Count' = n()) %>%
    add_row(combination = 'total children', 'Count' = sum(.$'Count')) %>%
    mutate(Percent = (as.numeric(`Count`)) / as.numeric(nrow(eff_results_v1_clean)) * 100) %>%
    mutate(Percent = round(Percent, 2)) %>%
    mutate(Percent = paste0(Percent, '%')) %>%
    rename('Combination type' = combination)


## V2 ##############################

  eff_results_v2 <- eff_results %>%
    filter(visit == 'V2', 
           efficacy_status == 'in')
  
  # make combination into individual columns
  eff_results_v2_edited <- eff_results_v2 %>%
    mutate(
      neg_pos = ifelse(pan_result == 'Negative' & pf_result == 'Positive', 1, 0),
      pos_neg = ifelse(pan_result == 'Positive' & pf_result == 'Negative', 1, 0),
      pos_pos = ifelse(pan_result == 'Positive' & pf_result == 'Positive', 1, 0),
      neg_neg = ifelse(pan_result == 'Negative' & pf_result == 'Negative', 1, 0)
    )
  
  # Using the four combinations of test possibilities (pan+/-;pf+/-), create a table by cluster which is downloadable.
  eff_cluster_rdt_results_v2 <- eff_results_v2_edited %>%
    group_by(cluster) %>%
    summarise('pan+ pf+' = sum(pos_pos),
              'pan+ pf-' = sum(pos_neg),
              'pan- pf+' = sum(neg_pos),
              'pan- pf-' = sum(neg_neg)) %>%
    rename(Cluster = cluster)

# we want to see the rates of malaria. So create a table of totals (all clusters) of the proportions of the four ways using (pan+/-;pf+/-). Include percentages of each for the entire study.
  eff_results_v2_clean <- eff_results_v2 %>%
    filter(combination != 'blank test responses')
  
  eff_rdt_prop_totals_v2 <- eff_results_v2_clean %>%
    group_by(combination) %>%
    summarise('Count' = n()) %>%
    add_row(combination = 'total children', 'Count' = sum(.$'Count')) %>%
    mutate(Percent = (as.numeric(`Count`)) / as.numeric(nrow(eff_results_v2_clean)) * 100) %>%
    mutate(Percent = round(Percent, 2)) %>%
    mutate(Percent = paste0(Percent, '%')) %>%
    rename('Combination type' = combination)
  

## V3 ##############################

  eff_results_v3 <- eff_results %>%
    filter(visit == 'V3', 
           efficacy_status == 'in')
  
  # make combination into individual columns
  eff_results_v3_edited <- eff_results_v3 %>%
    mutate(
      neg_pos = ifelse(pan_result == 'Negative' & pf_result == 'Positive', 1, 0),
      pos_neg = ifelse(pan_result == 'Positive' & pf_result == 'Negative', 1, 0),
      pos_pos = ifelse(pan_result == 'Positive' & pf_result == 'Positive', 1, 0),
      neg_neg = ifelse(pan_result == 'Negative' & pf_result == 'Negative', 1, 0)
    )
  
  # Using the four combinations of test possibilities (pan+/-;pf+/-), create a table by cluster which is downloadable.
  eff_cluster_rdt_results_v3 <- eff_results_v3_edited %>%
    group_by(cluster) %>%
    summarise('pan+ pf+' = sum(pos_pos),
              'pan+ pf-' = sum(pos_neg),
              'pan- pf+' = sum(neg_pos),
              'pan- pf-' = sum(neg_neg)) %>%
    rename(Cluster = cluster)

# we want to see the rates of malaria. So create a table of totals (all clusters) of the proportions of the four ways using (pan+/-;pf+/-). Include percentages of each for the entire study.
  eff_results_v3_clean <- eff_results_v3 %>%
    filter(combination != 'blank test responses')
  
  eff_rdt_prop_totals_v3 <- eff_results_v3_clean %>%
    group_by(combination) %>%
    summarise('Count' = n()) %>%
    add_row(combination = 'total children', 'Count' = sum(.$'Count')) %>%
    mutate(Percent = (as.numeric(`Count`)) / as.numeric(nrow(eff_results_v3_clean)) * 100) %>%
    mutate(Percent = round(Percent, 2)) %>%
    mutate(Percent = paste0(Percent, '%')) %>%
    rename('Combination type' = combination)
  
  
## V4 ##############################

  eff_results_v4 <- eff_results %>%
    filter(visit == 'V4', 
           efficacy_status == 'in')
  
  # make combination into individual columns
  eff_results_v4_edited <- eff_results_v4 %>%
    mutate(
      neg_pos = ifelse(pan_result == 'Negative' & pf_result == 'Positive', 1, 0),
      pos_neg = ifelse(pan_result == 'Positive' & pf_result == 'Negative', 1, 0),
      pos_pos = ifelse(pan_result == 'Positive' & pf_result == 'Positive', 1, 0),
      neg_neg = ifelse(pan_result == 'Negative' & pf_result == 'Negative', 1, 0)
    )
  
  # Using the four combinations of test possibilities (pan+/-;pf+/-), create a table by cluster which is downloadable.
  eff_cluster_rdt_results_v4 <- eff_results_v4_edited %>%
    group_by(cluster) %>%
    summarise('pan+ pf+' = sum(pos_pos),
              'pan+ pf-' = sum(pos_neg),
              'pan- pf+' = sum(neg_pos),
              'pan- pf-' = sum(neg_neg)) %>%
    rename(Cluster = cluster)

# we want to see the rates of malaria. So create a table of totals (all clusters) of the proportions of the four ways using (pan+/-;pf+/-). Include percentages of each for the entire study.
  eff_results_v4_clean <- eff_results_v4 %>%
    filter(combination != 'blank test responses')
  
  eff_rdt_prop_totals_v4 <- eff_results_v4_clean %>%
    group_by(combination) %>%
    summarise('Count' = n()) %>%
    add_row(combination = 'total children', 'Count' = sum(.$'Count')) %>%
    mutate(Percent = (as.numeric(`Count`)) / as.numeric(nrow(eff_results_v4_clean)) * 100) %>%
    mutate(Percent = round(Percent, 2)) %>%
    mutate(Percent = paste0(Percent, '%')) %>%
    rename('Combination type' = combination)
  
  
## V5 ##############################

  eff_results_v5 <- eff_results %>%
    filter(visit == 'V5', 
           efficacy_status == 'in')
  
  # make combination into individual columns
  eff_results_v5_edited <- eff_results_v5 %>%
    mutate(
      neg_pos = ifelse(pan_result == 'Negative' & pf_result == 'Positive', 1, 0),
      pos_neg = ifelse(pan_result == 'Positive' & pf_result == 'Negative', 1, 0),
      pos_pos = ifelse(pan_result == 'Positive' & pf_result == 'Positive', 1, 0),
      neg_neg = ifelse(pan_result == 'Negative' & pf_result == 'Negative', 1, 0)
    )
  
  # Using the four combinations of test possibilities (pan+/-;pf+/-), create a table by cluster which is downloadable.
  eff_cluster_rdt_results_v5 <- eff_results_v5_edited %>%
    group_by(cluster) %>%
    summarise('pan+ pf+' = sum(pos_pos),
              'pan+ pf-' = sum(pos_neg),
              'pan- pf+' = sum(neg_pos),
              'pan- pf-' = sum(neg_neg)) %>%
    rename(Cluster = cluster)

# we want to see the rates of malaria. So create a table of totals (all clusters) of the proportions of the four ways using (pan+/-;pf+/-). Include percentages of each for the entire study.
  eff_results_v5_clean <- eff_results_v5 %>%
    filter(combination != 'blank test responses')
  
  eff_rdt_prop_totals_v5 <- eff_results_v5_clean %>%
    group_by(combination) %>%
    summarise('Count' = n()) %>%
    add_row(combination = 'total children', 'Count' = sum(.$'Count')) %>%
    mutate(Percent = (as.numeric(`Count`)) / as.numeric(nrow(eff_results_v5_clean)) * 100) %>%
    mutate(Percent = round(Percent, 2)) %>%
    mutate(Percent = paste0(Percent, '%')) %>%
    rename('Combination type' = combination)
  
  
## V6 ##############################

  eff_results_v6 <- eff_results %>%
    filter(visit == 'V6', 
           efficacy_status == 'in')
  
  # make combination into individual columns
  eff_results_v6_edited <- eff_results_v6 %>%
    mutate(
      neg_pos = ifelse(pan_result == 'Negative' & pf_result == 'Positive', 1, 0),
      pos_neg = ifelse(pan_result == 'Positive' & pf_result == 'Negative', 1, 0),
      pos_pos = ifelse(pan_result == 'Positive' & pf_result == 'Positive', 1, 0),
      neg_neg = ifelse(pan_result == 'Negative' & pf_result == 'Negative', 1, 0)
    )
  
  # Using the four combinations of test possibilities (pan+/-;pf+/-), create a table by cluster which is downloadable.
  eff_cluster_rdt_results_v6 <- eff_results_v6_edited %>%
    group_by(cluster) %>%
    summarise('pan+ pf+' = sum(pos_pos),
              'pan+ pf-' = sum(pos_neg),
              'pan- pf+' = sum(neg_pos),
              'pan- pf-' = sum(neg_neg)) %>%
    rename(Cluster = cluster)

# we want to see the rates of malaria. So create a table of totals (all clusters) of the proportions of the four ways using (pan+/-;pf+/-). Include percentages of each for the entire study.
  eff_results_v6_clean <- eff_results_v6 %>%
    filter(combination != 'blank test responses')
  
  eff_rdt_prop_totals_v6 <- eff_results_v6_clean %>%
    group_by(combination) %>%
    summarise('Count' = n()) %>%
    add_row(combination = 'total children', 'Count' = sum(.$'Count')) %>%
    mutate(Percent = (as.numeric(`Count`)) / as.numeric(nrow(eff_results_v6_clean)) * 100) %>%
    mutate(Percent = round(Percent, 2)) %>%
    mutate(Percent = paste0(Percent, '%')) %>%
    rename('Combination type' = combination)
  
  
## V7 ##############################

  eff_results_v7 <- eff_results %>%
    filter(visit == 'V7', 
           efficacy_status == 'in')
  
  # make combination into individual columns
  eff_results_v7_edited <- eff_results_v7 %>%
    mutate(
      neg_pos = ifelse(pan_result == 'Negative' & pf_result == 'Positive', 1, 0),
      pos_neg = ifelse(pan_result == 'Positive' & pf_result == 'Negative', 1, 0),
      pos_pos = ifelse(pan_result == 'Positive' & pf_result == 'Positive', 1, 0),
      neg_neg = ifelse(pan_result == 'Negative' & pf_result == 'Negative', 1, 0)
    )
  
  # Using the four combinations of test possibilities (pan+/-;pf+/-), create a table by cluster which is downloadable.
  eff_cluster_rdt_results_v7 <- eff_results_v7_edited %>%
    group_by(cluster) %>%
    summarise('pan+ pf+' = sum(pos_pos),
              'pan+ pf-' = sum(pos_neg),
              'pan- pf+' = sum(neg_pos),
              'pan- pf-' = sum(neg_neg)) %>%
    rename(Cluster = cluster)

# we want to see the rates of malaria. So create a table of totals (all clusters) of the proportions of the four ways using (pan+/-;pf+/-). Include percentages of each for the entire study.
  eff_results_v7_clean <- eff_results_v7 %>%
    filter(combination != 'blank test responses')
  
  eff_rdt_prop_totals_v7 <- eff_results_v7_clean %>%
    group_by(combination) %>%
    summarise('Count' = n()) %>%
    add_row(combination = 'total children', 'Count' = sum(.$'Count')) %>%
    mutate(Percent = (as.numeric(`Count`)) / as.numeric(nrow(eff_results_v7_clean)) * 100) %>%
    mutate(Percent = round(Percent, 2)) %>%
    mutate(Percent = paste0(Percent, '%')) %>%
    rename('Combination type' = combination)

```

# Efficacy Trial Profile  

This is the efficacy trial profile which breaks down the children visited from beginning to end. It starts at efficacy pre-selection and ends at V7. The aim is to track every child and understand why they are present or not at each stage and to understand where they go.  

***

## Efficacy Preselection
Efficacy started with `r efficacy_selected` pre-selected children. Therefore, the target for V1 is `r efficacy_selected` children.  
  
***

### V1

In V1 `r v1_total_visited` children were visited. If the target for efficacy was `r efficacy_selected`, then this means that `r efficacy_selected - v1_total_visited` less children were visited than expected. See below:

 `r efficacy_selected` (V1 Target) - `r v1_total_visited` (V1 Visited) = `r efficacy_selected - v1_total_visited`

This number discrepancy can be explained by the following reasons:
  
  1. `r num_aged_out` children aged out (became older than 15) and were removed from the dataset  
      *Note: Those extids are `r paste(aged_out, collapse = ', ')`.*
  2. `r num_v1_not_visited` children were not visited in V1 (aka missed the visit),  
      + `r num_aged_out` (aged out kids) + `r num_v1_not_visited` (kids not visited) = `r sum(num_aged_out + num_v1_not_visited)` kids different than the target  
  
While we expected to visit `r efficacy_selected` children, we actually only visited `r v1_total_visited` children because `r num_aged_out` children aged out and did not need to be visited while `r num_v1_not_visited` children should have been visited but were missed. Now that we have determined why our target number for V1 is different than the number of people we actually visited, we need to determine the V2 target.

In preparation for V2, migrations, deaths, refusals, and eos children needed to be removed from the data. `r v1_removed_extids` kids were removed going into V2 for the following reasons:

```{r not_visited_table_v1}
knitr::kable(v1_removed_extid_table)
```

After removing migrations, deaths, refusals, and eos from above, we enter V2 with a target of `r num_v1_clean`. See below:

  * `r v1_total_visited` (V1 submissions) + `r num_v1_not_visited` (extids not visited) - `r v1_removed_extids` (removed extids) = `r  sum(v1_total_visited + num_v1_not_visited - v1_removed_extids)`
  
***

### V2

In V2 `r v2_total_visited` children were visited. If the target for efficacy was `r num_v1_clean`, then this means that `r num_v1_clean - v2_total_visited` less children were visited than expected. See below:

 * `r num_v1_clean` (V2 Target) - `r v2_total_visited` (V2 Visited) = `r num_v1_clean - v2_total_visited`

This number discrepancy can be explained by the following:
  
  * `r num_v2_not_visited` children were not visited in V2 (aka missed the visit).  
  
While we expected to visit `r num_v1_clean` children, we actually only visited `r v2_total_visited` children because `r num_v2_not_visited` children should have been visited but were missed. Now that we have determined why our target number for V2 is different than the number of people we actually visited, we need to determine the V3 target.

In preparation for V3, migrations, deaths, refusals, and eos children needed to be removed from the data. `r v2_removed_extids` kids were removed going into V3 for the following reasons:

```{r not_visited_table_v2}
knitr::kable(v2_removed_extid_table)
```

After removing migrations, deaths, refusals, and eos, we enter V3 with a target of `r num_v2_clean`. See below:

  * `r v2_total_visited` (V2 submissions) + `r num_v2_not_visited` (extids not visited) - `r v2_removed_extids` (removed extids) = `r  sum(v2_total_visited + num_v2_not_visited - v2_removed_extids)`
  
***

### V3

In V3 `r v3_total_visited` children were visited. If the target for efficacy was `r num_v2_clean`, then this means that `r num_v2_clean - v3_total_visited` less children were visited than expected. See below:

 * `r num_v2_clean` (V3 Target) - `r v3_total_visited` (V3 Visited) = `r num_v2_clean - v3_total_visited`

This number discrepancy can be explained by the following:
  
  * `r num_v3_not_visited` children were not visited in V3 (aka missed the visit).  
  
While we expected to visit `r num_v2_clean` children, we actually only visited `r v3_total_visited` children because `r num_v2_not_visited` children should have been visited but were missed. Now that we have determined why our target number for V3 is different than the number of people we actually visited, we need to determine the V4 target.

In preparation for V4, migrations, deaths, refusals, and eos children needed to be removed from the data as well as children who had not yet enrolled (`r num_v3_never_enrolled` with efficacy status "out") since V3 is the last opportunity for enrollment. `r v3_removed_extids` kids were removed going into V4 for the following reasons:

```{r not_visited_table_v3}
knitr::kable(v3_removed_extid_table)
```

After removing migrations, deaths, refusals, and eos, we enter V4 with a target of `r num_v3_clean`. See below:

  * `r v3_total_visited` (V3 submissions) + `r num_v3_not_visited_keep` - `r v3_removed_extids` (removed extids) = `r  sum(v3_total_visited + num_v3_not_visited_keep - v3_removed_extids)`
  
***

### V4

In V4 `r v4_total_visited` children were visited. If the target for efficacy was `r num_v3_clean`, then this means that `r num_v3_clean - v4_total_visited` less children were visited than expected. See below:

 * `r num_v3_clean` (V4 Target) - `r v4_total_visited` (V4 Visited) = `r num_v3_clean - v4_total_visited`

This number can be explained by the following:
  
  * `r num_v4_not_visited` children were not visited in V4 (aka missed the visit).  
  
While we expected to visit `r num_v3_clean` children, we actually only visited `r v4_total_visited` children because `r num_v4_not_visited` children should have been visited but were missed. Now that we have determined why our target number for V4 is different than the number of people we actually visited, we need to determine the V5 target.

In preparation for V5, migrations, deaths, refusals, and eos children needed to be removed from the data. `r v4_removed_extids` kids were removed going into V5 for the following reasons:

```{r not_visited_table_v4}
knitr::kable(v4_removed_extid_table)
```

After removing migrations, deaths, refusals, and eos, we enter V5 with a target of `r num_v4_clean`. See below:

  * `r v4_total_visited` (V4 submissions) + `r num_v4_not_visited` (extids not visited) - `r v4_removed_extids` (removed extids) = `r  sum(v4_total_visited + num_v4_not_visited - v4_removed_extids)`
  
***

### V5

In V5 `r v5_total_visited` children were visited. If the target for efficacy was `r num_v4_clean`, then this means that `r num_v4_clean - v5_total_visited` less children were visited than expected. See below:

 * `r num_v4_clean` (V5 Target) - `r v5_total_visited` (V5 Visited) = `r num_v4_clean - v5_total_visited`

This number can be explained by the following:
  
  * `r num_v5_not_visited` children were not visited in V5 (aka missed the visit).  
  
While we expected to visit `r num_v4_clean` children, we actually only visited `r v5_total_visited` children because `r num_v5_not_visited` children should have been visited but were missed. Now that we have determined why our target number for V5 is different than the number of people we actually visited, we need to determine the V6 target.

In preparation for V6, migrations, deaths, refusals, and eos children needed to be removed from the data. `r v5_removed_extids` kids were removed going into V6 for the following reasons:

```{r not_visited_table_v5}
knitr::kable(v5_removed_extid_table)
```

After removing migrations, deaths, refusals, and eos, we enter V6 with a target of `r num_v5_clean`. See below:

  * `r v5_total_visited` (V5 submissions) + `r num_v5_not_visited` (extids not visited) - `r v5_removed_extids` (removed extids) = `r  sum(v5_total_visited + num_v5_not_visited - v5_removed_extids)`
  
***

### V6 

In V6 `r v6_total_visited` children were visited. If the target for efficacy was `r num_v5_clean`, then this means that `r num_v5_clean - v6_total_visited` less children were visited than expected. See below:

 * `r num_v5_clean` (V6 Target) - `r v6_total_visited` (V6 Visited) = `r num_v5_clean - v6_total_visited`

This number can be explained by the following:
  
  * `r num_v6_not_visited` children were not visited in V6 (aka missed the visit).  
  
While we expected to visit `r num_v5_clean` children, we actually only visited `r v6_total_visited` children because `r num_v6_not_visited` children should have been visited but were missed. Now that we have determined why our target number for V6 is different than the number of people we actually visited, we need to determine the V7 target.

In preparation for V7, migrations, deaths, refusals, and eos children needed to be removed from the data. `r v6_removed_extids` kids were removed going into V7 for the following reasons:

```{r not_visited_table_v6}
knitr::kable(v6_removed_extid_table)
```

After removing migrations, deaths, refusals, and eos, we enter V7 with a target of `r num_v6_clean`. See below:

  * `r v6_total_visited` (V6 submissions) + `r num_v6_not_visited` (extids not visited) - `r v6_removed_extids` (removed extids) = `r  sum(v6_total_visited + num_v6_not_visited - v6_removed_extids)`

***

### V7 

In V7 `r v7_total_visited` children were visited. If the target for efficacy was `r num_v6_clean`, then this means that `r num_v6_clean - v7_total_visited` less children were visited than expected. See below:

 * `r num_v6_clean` (V7 Target) - `r v7_total_visited` (V7 Visited) = `r num_v6_clean - v7_total_visited`

This number can be explained by the following:
  
  * `r num_v7_not_visited` children were not visited in V7 (aka missed the visit).  
  
While we expected to visit `r num_v6_clean` children, we actually only visited `r v7_total_visited` children because `r num_v7_not_visited` children should have been visited but were missed. Now that we have determined why our target number for V7 is different than the number of people we actually visited, we have completed the study.

Below we can find the reason people did not become completion (migrations, deaths, refusals, and eos reasons):

```{r not_visited_table_v7}
knitr::kable(v7_removed_extid_table)
```

We can also see how many people did finish the study:

```{r clean_table_v7}
knitr::kable(v7_clean_extid_table)
```

***

## Enrolment Figures
```{r trial_total}
reactable(total_trial_table, columns = list(), pagination = FALSE)
```

### Enrolled Participants
```{r trial_enrolled}
reactable(enrolled_table, columns = list(), pagination = FALSE)

reactable(enrol_eos_table, columns = list(), pagination = FALSE)

reactable(trial_by_visit, columns = list(), pagination = FALSE)

reactable(enrol_in_table, columns = list(), pagination = FALSE)
```

### Not Enrolled Participants
```{r trial_not_enrolled}
reactable(not_enrolled_table, columns = list(), pagination = FALSE)

reactable(not_enrol_eos_table, columns = list(), pagination = FALSE)

reactable(not_enrol_out_table, columns = list(), pagination = FALSE)

reactable(not_enrol_ref_table, columns = list(), pagination = FALSE)
```


# Efficacy targets
```{r target_show}
reactable(target_table, columns = list(), pagination = FALSE)
```

# V7 Numbers
```{r v7_total_show}
reactable(total_efficacy_status_v7, columns = list(
  `Percent complete` = colDef(align = 'right')
))

# make a note of duplicates
if (any(duplicated(total_efficacy_v7$extid))) {
  cat('Note: Excluding the duplicates, the real total number of people visited is',
      length(unique(total_efficacy_v7$extid)), '.\n')
} else {
  cat("Note: There are no duplicates based on extid in the data.")
}
```

## in
```{r v7_in_show}
reactable(in_type_v7, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page
```

## eos
```{r v7_eos_show}
reactable(eos_reasons_v7, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('decline participation', 
                    'not agree to efficacy procedures', 
                    'not a resident', 
                    'enrolled in other trials')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_eos_v7$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for eos:", paste0(not_found_names, collapse = " / ", "."))
}
```


## out
```{r v7_out_show}
reactable(out_reasons_v7, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('migrated', 
                    'died', 
                    'absent',
                    'not enrolled yet')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_out_v7$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for out status:", paste0(not_found_names, collapse = " / ", "."))
}
```

## refusal
```{r v7_refusal_show}
reactable(refusal_reasons_v7, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('thumbprint status', 
                    'sign icf status', 
                    'minor assent status')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_refusal_v7$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for refusals:", paste0(not_found_names, collapse = "/ ", "."))
}
```

##  rdt results
### total rdt results in v7
```{r rdt-results-totals-v7}
reactable(eff_rdt_prop_totals_v7, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# make a note of blank test responses
if (sum(eff_results_v7$combination == 'blank test responses') >= 1) {
  cat('Note:', sum(eff_results_v7$combination == 'blank test responses'), 'blank test responses have been excluded from this table.\n')
} else {
  cat('Note: No blank test responses were recorded.\n')
}
```

### rdt results by cluster in v7
```{r rdt-results-by-cluster-v7}
element_id <- 'efficacy-rdt-results-by-cluster-v7'

v7_eff_cluster_rdt_results_readable <- reactable(eff_cluster_rdt_results_v7, columns = list(), 
                                              highlight = TRUE,
                                              resizable = TRUE,
                                              bordered = TRUE,
                                              striped = TRUE,
                                              filterable=TRUE,
                                              elementId = element_id
                                              )

wrap_download(
  v7_eff_cluster_rdt_results_readable, 
  element_id,
  'efficacy_rdt_results_by_cluster.csv')
```



# V6 Numbers
```{r v6_total_show}
reactable(total_efficacy_status_v6, columns = list(
  `Percent complete` = colDef(align = 'right')
))

# make a note of duplicates
if (any(duplicated(total_efficacy_v6$extid))) {
  cat('Note: Excluding the duplicates, the real total number of people visited is',
      length(unique(total_efficacy_v6$extid)), '.\n')
} else {
  cat("Note: There are no duplicates based on extid in the data.")
}
```

## in
```{r v6_in_show}
reactable(in_type_v6, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page
```

## eos
```{r v6_eos_show}
reactable(eos_reasons_v6, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('decline participation', 
                    'not agree to efficacy procedures', 
                    'not a resident', 
                    'enrolled in other trials')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_eos_v6$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for eos:", paste0(not_found_names, collapse = " / ", "."))
}
```


## out
```{r v6_out_show}
reactable(out_reasons_v6, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('migrated', 
                    'died', 
                    'absent',
                    'not enrolled yet')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_out_v6$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for out status:", paste0(not_found_names, collapse = " / ", "."))
}
```

## refusal
```{r v6_refusal_show}
reactable(refusal_reasons_v6, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('thumbprint status', 
                    'sign icf status', 
                    'minor assent status')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_refusal_v6$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for refusals:", paste0(not_found_names, collapse = "/ ", "."))
}
```

##  rdt results
### total rdt results in v6
```{r rdt-results-totals-v6}
reactable(eff_rdt_prop_totals_v6, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# make a note of blank test responses
if (sum(eff_results_v6$combination == 'blank test responses') >= 1) {
  cat('Note:', sum(eff_results_v6$combination == 'blank test responses'), 'blank test responses have been excluded from this table.\n')
} else {
  cat('Note: No blank test responses were recorded.\n')
}
```

### rdt results by cluster in v6
```{r rdt-results-by-cluster-v6}
element_id <- 'efficacy-rdt-results-by-cluster-v6'

v6_eff_cluster_rdt_results_readable <- reactable(eff_cluster_rdt_results_v6, columns = list(), 
                                              highlight = TRUE,
                                              resizable = TRUE,
                                              bordered = TRUE,
                                              striped = TRUE,
                                              filterable=TRUE,
                                              elementId = element_id
                                              )

wrap_download(
  v6_eff_cluster_rdt_results_readable, 
  element_id,
  'efficacy_rdt_results_by_cluster.csv')
```


# V5 Numbers
```{r v5_total_show}
reactable(total_efficacy_status_v5, columns = list(
  `Percent complete` = colDef(align = 'right')
))

# make a note of duplicates
if (any(duplicated(total_efficacy_v5$extid))) {
  cat('Note: Excluding the duplicates, the real total number of people visited is',
      length(unique(total_efficacy_v5$extid)), '.\n')
} else {
  cat("Note: There are no duplicates based on extid in the data.")
}
```

## in
```{r v5_in_show}
reactable(in_type_v5, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page
```

## eos
```{r v5_eos_show}
reactable(eos_reasons_v5, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('decline participation', 
                    'not agree to efficacy procedures', 
                    'not a resident', 
                    'enrolled in other trials')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_eos_v5$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for eos:", paste0(not_found_names, collapse = " / ", "."))
}
```


## out
```{r v5_out_show}
reactable(out_reasons_v5, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('migrated', 
                    'died', 
                    'absent',
                    'not enrolled yet')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_out_v5$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for out status:", paste0(not_found_names, collapse = " / ", "."))
}
```

## refusal
```{r v5_refusal_show}
reactable(refusal_reasons_v5, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('thumbprint status', 
                    'sign icf status', 
                    'minor assent status')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_refusal_v5$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for refusals:", paste0(not_found_names, collapse = "/ ", "."))
}
```

##  rdt results
### total rdt results in v5
```{r rdt-results-totals-v5}
reactable(eff_rdt_prop_totals_v5, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# make a note of blank test responses
if (sum(eff_results_v5$combination == 'blank test responses') >= 1) {
  cat('Note:', sum(eff_results_v5$combination == 'blank test responses'), 'blank test responses have been excluded from this table.\n')
} else {
  cat('Note: No blank test responses were recorded.\n')
}
```

### rdt results by cluster in v5
```{r rdt-results-by-cluster-v5}
element_id <- 'efficacy-rdt-results-by-cluster-v5'

v5_eff_cluster_rdt_results_readable <- reactable(eff_cluster_rdt_results_v5, columns = list(), 
                                              highlight = TRUE,
                                              resizable = TRUE,
                                              bordered = TRUE,
                                              striped = TRUE,
                                              filterable=TRUE,
                                              elementId = element_id
                                              )

wrap_download(
  v5_eff_cluster_rdt_results_readable, 
  element_id,
  'efficacy_rdt_results_by_cluster.csv')
```



# V4 Numbers
```{r v4_total_show}
reactable(total_efficacy_status_v4, columns = list(
  `Percent complete` = colDef(align = 'right')
))

# make a note of duplicates
if (any(duplicated(total_efficacy_v4$extid))) {
  cat('Note: Excluding the duplicates, the real total number of people visited is',
      length(unique(total_efficacy_v4$extid)), '.\n')
} else {
  cat("Note: There are no duplicates based on extid in the data.")
}
```

## in
```{r v4_in_show}
reactable(in_type_v4, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page
```

## eos
```{r v4_eos_show}
reactable(eos_reasons_v4, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('decline participation', 
                    'not agree to efficacy procedures', 
                    'not a resident', 
                    'enrolled in other trials')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_eos_v4$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for eos:", paste0(not_found_names, collapse = " / ", "."))
}
```

## out
```{r v4_out_show}
reactable(out_reasons_v4, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('migrated', 
                    'died', 
                    'absent',
                    'not enrolled yet')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_out_v4$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for out status:", paste0(not_found_names, collapse = " / ", "."))
}
```

## refusal
```{r v4_refusal_show}
reactable(refusal_reasons_v4, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('thumbprint status', 
                    'sign icf status', 
                    'minor assent status')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_refusal_v4$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for refusals:", paste0(not_found_names, collapse = "/ ", "."))
}
```

##  rdt results
### total rdt results in v4
```{r rdt-results-totals-v4}
reactable(eff_rdt_prop_totals_v4, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# make a note of blank test responses
if (sum(eff_results_v4$combination == 'blank test responses') >= 1) {
  cat('Note:', sum(eff_results_v4$combination == 'blank test responses'), 'blank test responses have been excluded from this table.\n')
} else {
  cat('Note: No blank test responses were recorded.\n')
}
```

### rdt results by cluster in v4
```{r rdt-results-by-cluster-v4}
element_id <- 'efficacy-rdt-results-by-cluster-v4'

v4_eff_cluster_rdt_results_readable <- reactable(eff_cluster_rdt_results_v4, columns = list(), 
                                              highlight = TRUE,
                                              resizable = TRUE,
                                              bordered = TRUE,
                                              striped = TRUE,
                                              filterable=TRUE,
                                              elementId = element_id
                                              )

wrap_download(
  v4_eff_cluster_rdt_results_readable, 
  element_id,
  'efficacy_rdt_results_by_cluster.csv')
```



# V3 Numbers
```{r v3_total_show}
reactable(total_efficacy_status_v3, columns = list(
  `Percent complete` = colDef(align = 'right')
))

# make a note of duplicates
if (any(duplicated(total_efficacy_v3$extid))) {
  cat('Note: Excluding the duplicates, the real total number of people visited is',
      length(unique(total_efficacy_v3$extid)), '.\n')
} else {
  cat("Note: There are no duplicates based on extid in the data.")
}
```

## in
```{r v3_in_show}
reactable(in_type_v3, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page
```

## eos
```{r v3_eos_show}
reactable(eos_reasons_v3, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('decline participation', 
                    'not agree to efficacy procedures', 
                    'not a resident', 
                    'enrolled in other trials')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_eos_v3$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for eos:", paste0(not_found_names, collapse = " / ", "."))
}
```

### follow up visit
```{r v3_eos_followup_show}

reactable(eos_reasons_followup_v3, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

```

### enrolment visit
```{r v3_eos_enrolment}

reactable(eos_reasons_enrolment_v3, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

```


## out
```{r v3_out_show}
reactable(out_reasons_v3, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('migrated', 
                    'died', 
                    'absent',
                    'not enrolled yet')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_out_v3$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for out status:", paste0(not_found_names, collapse = " / ", "."))
}
```

## refusal
```{r v3_refusal_show}
reactable(refusal_reasons_v3, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('thumbprint status', 
                    'sign icf status', 
                    'minor assent status')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_refusal_v3$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for refusals:", paste0(not_found_names, collapse = "/ ", "."))
}
```

##  rdt results
### total rdt results in v3
```{r rdt-results-totals-v3}
reactable(eff_rdt_prop_totals_v3, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# make a note of blank test responses
if (sum(eff_results_v3$combination == 'blank test responses') >= 1) {
  cat('Note:', sum(eff_results_v3$combination == 'blank test responses'), 'blank test responses have been excluded from this table.\n')
} else {
  cat('Note: No blank test responses were recorded.\n')
}
```

### rdt results by cluster in v3
```{r rdt-results-by-cluster-v3}
element_id <- 'efficacy-rdt-results-by-cluster-v3'

v3_eff_cluster_rdt_results_readable <- reactable(eff_cluster_rdt_results_v3, columns = list(), 
                                              highlight = TRUE,
                                              resizable = TRUE,
                                              bordered = TRUE,
                                              striped = TRUE,
                                              filterable=TRUE,
                                              elementId = element_id
                                              )

wrap_download(
  v3_eff_cluster_rdt_results_readable, 
  element_id,
  'efficacy_rdt_results_by_cluster.csv')
```



# V2 Numbers
```{r v2_total_show}
reactable(total_efficacy_status_v2, columns = list(
  `Percent complete` = colDef(align = 'right')
))

# make a note of duplicates
if (any(duplicated(total_efficacy_v2$extid))) {
  cat('Note: Excluding the duplicates, the real total number of people visited is',
      length(unique(total_efficacy_v2$extid)), '.\n')
} else {
  cat("Note: There are no duplicates based on extid in the data.")
}
```

## in
```{r in_show}
reactable(in_type_v2, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page
```

## eos
```{r v2_eos_show}
reactable(eos_reasons_v2, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('decline participation', 
                    'not agree to efficacy procedures', 
                    'not a resident', 
                    'enrolled in other trials')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_eos_v2$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for eos:", paste0(not_found_names, collapse = " / ", "."))
}
```

### follow up visit
```{r v2_eos_followup_show}

reactable(eos_reasons_followup_v2, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

```

### enrolment visit
```{r v2_eos_enrolment}

reactable(eos_reasons_enrolment_v2, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

```


## out
```{r v2_out_show}
reactable(out_reasons_v2, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('migrated', 
                    'died', 
                    'absent',
                    'not enrolled yet')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_out_v2$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for out status:", paste0(not_found_names, collapse = " / ", "."))
}
```

## refusal
```{r v2_refusal_show}
reactable(refusal_reasons_v2, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# generate a message that says which reasons do not appear
# Specify the names you want to check for
names_to_check <- c('thumbprint status', 
                    'sign icf status', 
                    'minor assent status')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_refusal_v2$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for refusals:", paste0(not_found_names, collapse = "/ ", "."))
}
```

##  rdt results
### total rdt results in v2
```{r rdt-results-totals-v2}
reactable(eff_rdt_prop_totals_v2, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# make a note of blank test responses
if (sum(eff_results_v2$combination == 'blank test responses') >= 1) {
  cat('Note:', sum(eff_results_v2$combination == 'blank test responses'), 'blank test responses have been excluded from this table.\n')
} else {
  cat('Note: No blank test responses were recorded.\n')
}
```

### rdt results by cluster in v2
```{r rdt-results-by-cluster-v2}
element_id <- 'efficacy-rdt-results-by-cluster-v2'

eff_cluster_rdt_results_readable <- reactable(eff_cluster_rdt_results_v2, columns = list(), 
                                              highlight = TRUE,
                                              resizable = TRUE,
                                              bordered = TRUE,
                                              striped = TRUE,
                                              filterable=TRUE,
                                              elementId = element_id
                                              )

wrap_download(
  eff_cluster_rdt_results_readable, 
  element_id,
  'efficacy_rdt_results_by_cluster.csv')
```


# V1 Numbers
```{r v1_total_show}
reactable(total_efficacy_status_v1, columns = list(
  `Percent complete` = colDef(align = "right")
))

# make a note of the real total number of people visited without repeats
if (any(duplicated(total_efficacy_v1$extid))) {
  cat("Note: Excluding the duplicates, the real total number of people visited is", length(unique(total_efficacy_v1$extid)), "\n.")
} else {
  cat("Note: There are no duplicates based on extid in the data.")
}
```

## eos
```{r v1_eos_show}
reactable(eos_reasons_v1, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('decline participation', 'not agree to efficacy procedures', 'not a resident', 'enrolled in other trials')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_eos_v1$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following reasons are not reasons for eos status:", paste0(not_found_names, collapse = " / ", "."))
}
```

## out
```{r v1_out_show}
reactable(out_reasons_v1, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('migrated', 'died', 'absent')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_out_v1$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following reasons are not reasons for out status:", paste0(not_found_names, collapse = ", ", "."))
}
```

## refusal
```{r v1_refusal_show}
reactable(refusal_reasons_v1, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('thumbprint status', 'sign icf status', 'minor assent status')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% efficacy_refusal_v1$efficacy_reason) {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for refusals:", paste0(not_found_names, collapse = ", ", "."))
}
```

##  rdt results
### total rdt results in v1
```{r rdt-results-totals-v1}
reactable(eff_rdt_prop_totals_v1, columns = list(
  `Percent` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# make a note of blank test responses
if (sum(eff_results_v1$combination == 'blank test responses') >= 1) {
  cat('Note:', sum(eff_results_v1$combination == 'blank test responses'), 'blank test responses have been excluded from this table.\n')
} else {
  cat('Note: No blank test responses were recorded. \n')
}

```

### rdt results by cluster in v1
```{r rdt-results-by-cluster-v1}
element_id <- 'efficacy-rdt-results-by-cluster-v1'

v2_eff_cluster_rdt_results_readable <- reactable(eff_cluster_rdt_results_v1, columns = list(), 
                                              highlight = TRUE,
                                              resizable = TRUE,
                                              bordered = TRUE,
                                              striped = TRUE,
                                              filterable=TRUE,
                                              elementId = element_id
                                              )

wrap_download(
  eff_cluster_rdt_results_readable, 
  element_id,
  'v2_efficacy_rdt_results_by_cluster.csv')
```

# extid explorer
```{r extid-explorer}
element_id <- 'extid-explorerer'

data_readable <- reactable(data_investigation, columns = list(), 
                                              highlight = TRUE,
                                              resizable = TRUE,
                                              bordered = TRUE,
                                              striped = TRUE,
                                              filterable=TRUE,
                                              elementId = element_id
                                              )

wrap_download(
  data_readable, 
  element_id,
  'efficacy_extid_explorer.csv')
```
