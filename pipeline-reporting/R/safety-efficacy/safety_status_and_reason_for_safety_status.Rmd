---
title: "Safety Status Report"
output: 
  html_document:
    toc: true
    theme: cerulean
date: '`r Sys.time()`'
---

Notes:

- Report is refreshed hourly 9-5pm EAT, once 12AM EAT
- Please reach out to nikamgorski@gmail.com for bug reports


```{r, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(
  comment = '', 
  echo = FALSE,
  message = FALSE,
  cache=FALSE,
  warning=FALSE
)
```

```{r setup, include=FALSE}
### PURPOSE:
# This code aims to determine who is out, refusal, in, and eos after safety. This information comes from Safety, Safetynew, and Absence1stattempt. Then for each status (except of in), split each status into the "reason" or the "how" they got to that status.
# load required libraries
library(dplyr)
library(reactable)
library(data.table)
library(cloudbrewr)
library(fontawesome)
library(shiny)
library(ggplot2)
library(tidyr)

ENV_PIPELINE_STAGE <- Sys.getenv("PIPELINE_STAGE")
DATA_STAGING_BUCKET_NAME <- 'databrew.org'
DATA_LAKE_BUCKET_NAME <- 'bohemia-lake-db'
PROJECT_SOURCE <- 'kwale'
SE_FOLDER_TARGET <- glue::glue('{PROJECT_SOURCE}/clean-form')

pad_hhid <- function(data){
  if('hhid' %in% names(data)){
    data %>%
      dplyr::mutate(hhid = stringr::str_pad(hhid, 5, pad = "0"))
  }else{
    data
  }
}


tryCatch({
  logger::log_info('Attempt AWS login')
  # login to AWS - this will be bypassed if executed in CI/CD environment
  cloudbrewr::aws_login(
    role_name = 'cloudbrewr-aws-role',
    profile_name =  'cloudbrewr-aws-role',
    pipeline_stage = ENV_PIPELINE_STAGE)

}, error = function(e){
  logger::log_error('AWS Login Failed')
  stop(e$message)
})


# load in the data
absence1stattempt <- cloudbrewr::aws_s3_get_table(
  bucket = DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/sanitized-form/absences1stattempt/absences1stattempt.csv')) %>%
  pad_hhid()

v0_dem_repeat <- cloudbrewr::aws_s3_get_table(
  bucket = DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/sanitized-form/v0demography/v0demography-repeat_individual.csv')) %>%
  pad_hhid()
  
v0_demography <- cloudbrewr::aws_s3_get_table(
  bucket = DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/sanitized-form/v0demography/v0demography.csv')) %>%
  pad_hhid()

safety <- cloudbrewr::aws_s3_get_table(
  bucket = DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/sanitized-form/safety/safety.csv')) %>%
  pad_hhid()

safetynew <- cloudbrewr::aws_s3_get_table(
  bucket =DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/sanitized-form/safetynew/safetynew.csv')) %>%
  pad_hhid()

safety_repeat_individual <- cloudbrewr::aws_s3_get_table(
  bucket = DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/sanitized-form/safety/safety-repeat_individual.csv')) %>%
  pad_hhid()

safetynew_repeat_individual <- cloudbrewr::aws_s3_get_table(
  bucket =DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/sanitized-form/safetynew/safetynew-repeat_individual.csv')) %>%
  pad_hhid()

safety_targets <- cloudbrewr::aws_s3_get_table(
  bucket ='bohemia-lake-db',
  key = glue::glue('bohemia_prod/dwh/goal_safety_targets/goal_safety_targets.csv')) %>%
  pad_hhid()

# this is a function to create a download csv button
wrap_download <- function(reactable_obj, element_id, output_filename){
  onclick_command <- glue::glue(
    "Reactable.downloadDataCSV('{element_id}', '{output_filename}')")
  htmltools::browsable(
    tagList(
      tags$button(
        tagList(fontawesome::fa("download"), "Download as CSV"),
        onclick = onclick_command),
      reactable_obj
    ))
}
```

```{r data creation}
# general edits
absence1stattempt <- absence1stattempt %>%
  rename(extid = extid_enter)

# create the merged v0 data
  v0dem <- left_join(v0_dem_repeat, v0_demography, by=c('PARENT_KEY' = 'KEY')) %>%
    select(extid, dob, sex, todays_date) %>%
    rename(dob_v0 = dob,
           todays_date_v0 = todays_date,
           sex_v0 = sex)
  
# create the merged safety data
  clean_safety_repeat <- safety_repeat_individual %>%
    select(PARENT_KEY, extid, safety_status, starting_safety_status, dob_string, sex, participant_take_drug, participant_take_drug_2, non_resident_eos, weight_eos, weight_eos_short, study_drug_eos, concom_meds_eos, concom_meds_eos_short, severe_illness_eos, severe_illness_eos_short, obvious_screening, baby_not_week_old_eos, pregnant_eos, pregnancy_section_eos, pregnancy_section_eos_short, preg_test_pos_eos_short, preg_test_2_eos_short, obvious_screening, preg_test_refuse_eos_short, other_trials_eos, loa_loa_eos, sum_night_hospital_eos, not_agree_safety_procedures_eos, refuse_drug_eos, refuse_drug_eos_2, not_continue_eos, person_died_eos, person_out_died, person_migrated, person_out_migrated, ind_witness_present, person_absent, obvious_screening, ind_thumbprint_status, ind_sign_icf_status, minor_assent_status, starting_safety_status) %>%
    rename(dob = dob_string)
  clean_safetynew_repeat <- safetynew_repeat_individual %>%
    select(PARENT_KEY, extid, safety_status, dob, sex, participant_take_drug, participant_take_drug_2, non_resident_eos, weight_eos, study_drug_eos, concom_meds_eos, severe_illness_eos, obvious_screening, baby_not_week_old_eos, pregnant_eos, pregnancy_section_eos, obvious_screening, other_trials_eos, loa_loa_eos, not_agree_safety_procedures_eos, refuse_drug_eos, refuse_drug_eos_2, ind_witness_present, obvious_screening, ind_thumbprint_status, ind_sign_icf_status, minor_assent_status) %>%
    rename(take_drug_safetynew = participant_take_drug,
           take_drug_2_safetynew = participant_take_drug_2)
  clean_safety <- safety %>%
    select(KEY, visit, todays_date, hhid, cluster)
  clean_safetynew <- safetynew %>%
    select(KEY, visit, todays_date, hhid, cluster)
  
  # join safety and safety repeat and do the same for safetynew
  joined_safety <- left_join(clean_safety, clean_safety_repeat, by=c('KEY' = 'PARENT_KEY'))
  joined_safetynew <- left_join(clean_safetynew_repeat, clean_safetynew, by=c('PARENT_KEY' = 'KEY'))
  
  # join these two new dataframes
  total_safety <- bind_rows(joined_safety, joined_safetynew) %>%
    mutate(took_drug = coalesce(participant_take_drug, 
                                participant_take_drug_2, 
                                take_drug_safetynew, 
                                take_drug_2_safetynew),
           safetystatus = safety_status,
           safety_reason = case_when(
             safety_status == 'in' ~ 'in',
             starting_safety_status == 'eos' ~ 'previously eos',
             starting_safety_status == 'refusal' ~ 'previously refusal',
             non_resident_eos == '1' ~ 'not resident',
             weight_eos == '1' |
               weight_eos_short == '1' ~ 'under weight',
             study_drug_eos == '1' ~ 'study drug',
             concom_meds_eos == '1' |
               concom_meds_eos_short == '1' ~ 'concom meds',
             severe_illness_eos == '1' |
               severe_illness_eos_short == '1' |
               obvious_screening == 'Ill' ~ 'severe illness',
             baby_not_week_old_eos == '1' ~ 'baby under 1 week',
             preg_test_refuse_eos_short == '1' ~ 'pregnancy test refusal',
             pregnant_eos == '1' |
               preg_test_pos_eos_short == '1' |
               preg_test_2_eos_short == '1' |
               obvious_screening == 'Pregnant' |
               pregnancy_section_eos_short == '1' |
               pregnancy_section_eos == '1' ~ 'pregnant',
             other_trials_eos == '1' ~ 'other trials',
             loa_loa_eos == '1' ~ 'visited loa loa',
             sum_night_hospital_eos >= '1' ~ 'spent night at the hospital',
             not_agree_safety_procedures_eos == '1' ~ 'not agree to safety procedures',
             refuse_drug_eos == '1' |
               refuse_drug_eos_2 == '1' ~ 'participant withdrew informed consent',
             not_continue_eos == '1' ~ 'not wish to continue',
             person_died_eos == '1' |
               person_out_died == '1' ~ 'died',
             person_migrated == '1' & 
               starting_safety_status == 'in' |
               person_out_migrated == '1' ~ 'migrated',
             starting_safety_status == 'eos' ~ 'previously eos',
             obvious_screening == 'ineligible' ~ 'Ineligible at obvious reasoning',
             obvious_screening == 'Baby' ~ 'A baby that cannot walk yet',
             obvious_screening == 'Witness' |
               ind_witness_present == '1 ' ~ 'no witness',
             person_absent == '1' ~ 'absent',
             obvious_screening == 'Refusal' ~ 'a person who does not want to participate',
             obvious_screening == 'Language' ~ 'does not speak English or Swahili',
             ind_thumbprint_status == '0' ~ 'not consented or provided their thumbprint',
             ind_sign_icf_status == '0' ~ 'not agree or sign informed consent',
             minor_assent_status == '0' ~ 'minor not sign assent',
             starting_safety_status == 'refusal' ~ 'previously refusal',
             TRUE ~ NA_character_  # To handle cases that don't match any condition
           ))  
  
  
# join total_safety and v0 data
  data <- merge(total_safety, v0dem, by = c('extid'), all = TRUE)
  
  
# create the dataset for the extid explorer
  data_investigation <- data %>%
    rename(dob_safety_visit = dob,
           todays_date_safety = todays_date,
           sex_safety = sex) %>%
    filter(!is.na(visit),
           safety_status != 'UNDEFINED') %>% # removes extids not in Efficacy
    select(visit, extid, safety_status, safety_reason, sex_v0, sex_safety, 
           dob_v0, dob_safety_visit, todays_date_v0, todays_date_safety)

```

```{r targets}
# these numbers are determined by Aryton based on Joe's logic and are stored in AWS
  target_table <- safety_targets %>%
    group_by(visit) %>%
    summarise(hh_target = sum(hh_target),
              ind_target = sum(ind_target))

# identify how many households were visited in V1 and V2
visited <- total_safety %>%
  group_by(visit) %>%
  summarise(hh_visited = n_distinct(hhid),
            ind_visited = n_distinct(extid))

# join the number of households visited and targets
target_table <- left_join(target_table, visited, by = c('visit'))

target_table <- target_table %>%
  select(visit, ind_target, ind_visited, hh_target, hh_visited) %>%
  rename(Visit = visit,
         'Individual target' = ind_target,
         'Individual visited' = ind_visited,
         'HH target' = hh_target,
         'HH visited' = hh_visited)
```

```{r totals}
## this will create the table of how many people are in, out, refusal, or eos
## it is broken up into each visit number

  # make the safetynew_status and safety_status into one column and the sexes
  total_safety <- data %>%
    filter(safetystatus != 'UNDEFINED') # we find an UNDEFINED from someone most likely submitting a form without filling it out so we will remove NA from extid 


### V1 ################
  
  # since this is only a table for V1 we will only keep V1 people from total_safety
  total_safety_v1 <- total_safety %>%
    filter(visit == 'V1')
  
  # create a summary table of safety_status counts
  total_safety_status_v1 <- total_safety_v1 %>%
    select(extid, safetystatus, cluster, sex, todays_date, visit) %>%
    group_by(safetystatus) %>%
    summarise('Number of people visited in V1' = n()) %>%
    arrange(safetystatus) %>%
    rename('Safety status' = safetystatus) %>%
    add_row('Safety status' = 'total people visited', 'Number of people visited in V1' = sum(.$'Number of people visited in V1')) %>%
    mutate('Percent complete' = (as.numeric(`Number of people visited in V1`)) / as.numeric(nrow(total_safety_v1)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%'))


## V2 #################
  
total_safety_v2 <- total_safety %>%
  filter(visit == 'V2')

total_safety_status_v2 <- total_safety_v2 %>%
  select(extid, safetystatus, cluster, sex, todays_date, visit) %>%
  group_by(safetystatus) %>%
  summarise('Number of people visited in V2' = n()) %>%
  arrange(safetystatus) %>%
  rename('Safety status' = safetystatus) %>%
  add_row('Safety status' = 'total people visited', 'Number of people visited in V2' = sum(.$'Number of people visited in V2')) %>%
  mutate('Percent complete' = (as.numeric(`Number of people visited in V2`)) / as.numeric(nrow(total_safety_v2)) * 100) %>%
  mutate('Percent complete' = round(`Percent complete`, 2)) %>%
  mutate('Percent complete' = paste0(`Percent complete`, '%'))


## V3 ####################

total_safety_v3 <- total_safety %>%
  filter(visit == 'V3') 

total_safety_status_v3 <- total_safety_v3 %>%
  select(extid, safetystatus, cluster, sex, todays_date, visit) %>%
  group_by(safetystatus) %>%
  summarise('Number of people visited in V3' = n()) %>%
  arrange(safetystatus) %>%
  rename('Safety status' = safetystatus) %>%
  add_row('Safety status' = 'total people visited', 'Number of people visited in V3' = sum(.$'Number of people visited in V3')) %>%
  mutate('Percent complete' = (as.numeric(`Number of people visited in V3`)) / as.numeric(nrow(total_safety_v3)) * 100) %>%
  mutate('Percent complete' = round(`Percent complete`, 2)) %>%
  mutate('Percent complete' = paste0(`Percent complete`, '%'))


## V4 #####################

total_safety_v4 <- total_safety %>%
  filter(visit == 'V4') 

total_safety_status_v4 <- total_safety_v4 %>%
  select(extid, safetystatus, cluster, sex, todays_date, visit) %>%
  group_by(safetystatus) %>%
  summarise('Number of people visited in V4' = n()) %>%
  arrange(safetystatus) %>%
  rename('Safety status' = safetystatus) %>%
  add_row('Safety status' = 'total people visited', 'Number of people visited in V4' = sum(.$'Number of people visited in V4')) %>%
  mutate('Percent complete' = (as.numeric(`Number of people visited in V4`)) / as.numeric(nrow(total_safety_v4)) * 100) %>%
  mutate('Percent complete' = round(`Percent complete`, 2)) %>%
  mutate('Percent complete' = paste0(`Percent complete`, '%'))
```

```{r in}
## create a table of how many people are in as enrolment and in as follow up in Safety visits

## V4 ###################

# create a dataset with the in efficacy status people from Safety V2 and then joining Safety V3 and V4 (total_safety_v3 and total_safety_v4)
  safety_v4 <- total_safety_v4 %>%
    rename(v4_safetystatus = safetystatus) %>%
    select(extid, v4_safetystatus, safety_reason) %>% # get the v3 'in' people
    rename(v4_safety_reason = safety_reason)
  
  safety_v4 <- left_join(safety_v4, total_safety_v3, by=c('extid')) %>%
    select(extid, safetystatus, v4_safetystatus, v4_safety_reason) %>%
    rename(v3_safetystatus = safetystatus) %>% # join the v3 'in' people with their v1 statuses
    mutate(visit_type = case_when( # create a column that says whether the safety people are follow up or enrolment.
      v3_safetystatus == 'in' ~ 'follow up',
      v3_safetystatus == 'eos' ~ 'previously eos',
      v3_safetystatus == 'out' |
        is.na(v3_safetystatus) ~ 'enrolment'
    )) 
  
  # create a table that shows how many people are follow up and enrolment in V2
  # make a table of reasons people are eos
  safety_v4_in <- safety_v4 %>%
    filter(v4_safetystatus == 'in')
  
  in_type_v4 <- safety_v4_in %>%
    group_by(visit_type) %>%
    summarise('Number of in people' = n()) %>%
    arrange(visit_type) %>%
    rename('Visit type' = visit_type) %>%
    add_row('Visit type' = 'total in', 'Number of in people' = sum(.$'Number of in people')) %>%
    mutate('Percent' = (as.numeric(`Number of in people`)) / as.numeric(nrow(safety_v4_in)) * 100) %>%
    mutate('Percent' = round(`Percent`, 2)) %>%
    mutate('Percent' = paste0(`Percent`, '%')) # Replace zero values with NA
  

## V3 ###################
  
# create a dataset with the in efficacy status people from Safety V2 and then joining Safety V2 and V3 (total_safety_v2 and total_safety_v3)
  safety_v3 <- total_safety_v3 %>%
    rename(v3_safetystatus = safetystatus) %>%
    select(extid, v3_safetystatus, safety_reason) %>% # get the v3 'in' people
    rename(v3_safety_reason = safety_reason)
  
  safety_v3 <- left_join(safety_v3, total_safety_v2, by=c('extid')) %>%
    select(extid, safetystatus, v3_safetystatus, v3_safety_reason) %>%
    rename(v2_safetystatus = safetystatus) %>% # join the v3 'in' people with their v1 statuses
    mutate(visit_type = case_when( # create a column that says whether the safety people are follow up or enrolment.
      v2_safetystatus == 'in' ~ 'follow up',
      v2_safetystatus == 'eos' ~ 'previously eos',
      v2_safetystatus == 'out' |
        is.na(v2_safetystatus) ~ 'enrolment'
    )) 
  
  # create a table that shows how many people are follow up and enrolment in V2
  # make a table of reasons people are eos
  safety_v3_in <- safety_v3 %>%
    filter(v3_safetystatus == 'in')
  
  in_type_v3 <- safety_v3_in %>%
    group_by(visit_type) %>%
    summarise('Number of in people' = n()) %>%
    arrange(visit_type) %>%
    rename('Visit type' = visit_type) %>%
    add_row('Visit type' = 'total in', 'Number of in people' = sum(.$'Number of in people')) %>%
    mutate('Percent' = (as.numeric(`Number of in people`)) / as.numeric(nrow(safety_v3_in)) * 100) %>%
    mutate('Percent' = round(`Percent`, 2)) %>%
    mutate('Percent' = paste0(`Percent`, '%')) # Replace zero values with NA


## V2 ##############
  
# create a dataset with the in efficacy status people from Safety V2 and then joining Safety V1 and V2 (total_safety_v1 and total_safety_v2)
  safety_v2 <- total_safety_v2 %>%
    rename(v2_safetystatus = safetystatus) %>%
    select(extid, v2_safetystatus, safety_reason) %>% # get the v2 'in' people
    rename(v2_safety_reason = safety_reason)
  
  safety_v2 <- left_join(safety_v2, total_safety_v1, by=c('extid')) %>%
    select(extid, safetystatus, v2_safetystatus, v2_safety_reason) %>%
    rename(v1_safetystatus = safetystatus) %>% # join the v2 'in' people with their v1 statuses
    mutate(visit_type = case_when( # create a column that says whether the safety people are follow up or enrolment.
      v1_safetystatus == 'in' ~ 'follow up',
      v1_safetystatus == 'eos' ~ 'previously eos',
      v1_safetystatus == 'out' |
        is.na(v1_safetystatus) ~ 'enrolment'
    ))
  
  # create a table that shows how many people are follow up and enrolment in V2
  # make a table of reasons people are eos
  safety_v2_in <- safety_v2 %>%
    filter(v2_safetystatus == 'in')
  
  in_type_v2 <- safety_v2_in %>%
    group_by(visit_type) %>%
    summarise('Number of in people' = n()) %>%
    arrange(visit_type) %>%
    rename('Visit type' = visit_type) %>%
    add_row('Visit type' = 'total in', 'Number of in people' = sum(.$'Number of in people')) %>%
    mutate('Percent' = (as.numeric(`Number of in people`)) / as.numeric(nrow(safety_v2_in)) * 100) %>%
    mutate('Percent' = round(`Percent`, 2)) %>%
    mutate('Percent' = paste0(`Percent`, '%')) # Replace zero values with NA

```

```{r eos}

## V1 ###########################
  
  safety_eos_v1 <- data %>%
    filter(visit == 'V1',
           safetystatus == 'eos')
  
  # make a table of why people are eos
  eos_reasons_v1 <- safety_eos_v1 %>%
    group_by(safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for eos' = safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(safety_eos_v1)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
## V2 ############################
  
  safety_eos_v2 <- safety_v2 %>%
    filter(v2_safetystatus == 'eos') # remove people who were eos in V1
  
  total_safe_eos_enrolment_v2 <- safety_eos_v2 %>%
    filter(visit_type == 'enrolment')
  total_safe_eos_followup_v2 <- safety_eos_v2 %>%
    filter(visit_type == 'follow up')

  eos_reasons_v2 <- safety_eos_v2 %>%
    group_by(visit_type) %>%
    summarise('Number of eos people' = n()) %>%
    rename('Reason for eos' = visit_type) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent of eos' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(safety_eos_v2)) * 100) %>%
    mutate('Percent of eos' = round(`Percent of eos`, 2)) %>%
    mutate('Percent of eos' = paste0(`Percent of eos`, '%')) # Replace zero values with NA

# make a table of enrolment people who are eos
  eos_reasons_enrolment_v2 <- total_safe_eos_enrolment_v2 %>%
    group_by(v2_safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(v2_safety_reason) %>%
    rename('Reason for eos' = v2_safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(total_safe_eos_enrolment_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

# make a table of reasons follow up people are eos #
  eos_reasons_followup_v2 <- total_safe_eos_followup_v2 %>%
    group_by(v2_safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(v2_safety_reason) %>%
    rename('Reason for eos' = v2_safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(total_safe_eos_followup_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

## V3 ############################
  
  safety_eos_v3 <- safety_v3 %>%
    filter(v3_safetystatus == 'eos') # remove people who were eos in V1
  
  total_safe_eos_enrolment_v3 <- safety_eos_v3 %>%
    filter(visit_type == 'enrolment')
  total_safe_eos_followup_v3 <- safety_eos_v3 %>%
    filter(visit_type == 'follow up')

  eos_reasons_v3 <- safety_eos_v3 %>%
    group_by(visit_type) %>%
    summarise('Number of eos people' = n()) %>%
    rename('Reason for eos' = visit_type) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent of eos' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(safety_eos_v3)) * 100) %>%
    mutate('Percent of eos' = round(`Percent of eos`, 2)) %>%
    mutate('Percent of eos' = paste0(`Percent of eos`, '%')) # Replace zero values with NA

# make a table of enrolment people who are eos
  eos_reasons_enrolment_v3 <- total_safe_eos_enrolment_v3 %>%
    group_by(v3_safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(v3_safety_reason) %>%
    rename('Reason for eos' = v3_safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(total_safe_eos_enrolment_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

# make a table of reasons follow up people are eos #
  eos_reasons_followup_v3 <- total_safe_eos_followup_v3 %>%
    group_by(v3_safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(v3_safety_reason) %>%
    rename('Reason for eos' = v3_safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(total_safe_eos_followup_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

  
## V4 ############################
  
  safety_eos_v4 <- safety_v4 %>%
    filter(v4_safetystatus == 'eos') # remove people who were eos in V1
  
  total_safe_eos_enrolment_v4 <- safety_eos_v4 %>%
    filter(visit_type == 'enrolment')
  total_safe_eos_followup_v4 <- safety_eos_v4 %>%
    filter(visit_type == 'follow up')

  eos_reasons_v4 <- safety_eos_v4 %>%
    group_by(visit_type) %>%
    summarise('Number of eos people' = n()) %>%
    rename('Reason for eos' = visit_type) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent of eos' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(safety_eos_v4)) * 100) %>%
    mutate('Percent of eos' = round(`Percent of eos`, 2)) %>%
    mutate('Percent of eos' = paste0(`Percent of eos`, '%')) # Replace zero values with NA

# make a table of enrolment people who are eos
  eos_reasons_enrolment_v4 <- total_safe_eos_enrolment_v4 %>%
    group_by(v4_safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(v4_safety_reason) %>%
    rename('Reason for eos' = v4_safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(total_safe_eos_enrolment_v4)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

# make a table of reasons follow up people are eos #
  eos_reasons_followup_v4 <- total_safe_eos_followup_v4 %>%
    group_by(v4_safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(v4_safety_reason) %>%
    rename('Reason for eos' = v4_safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / as.numeric(nrow(total_safe_eos_followup_v4)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA


```

```{r v1_out}

## V1 #####################

  safety_out_v1 <- data %>%
    filter(visit == 'V1',
           safetystatus == 'out')
  
  # make a table of why people are out
  out_reasons_v1 <- safety_out_v1 %>%
    group_by(safety_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for out' = safety_reason) %>%
    add_row('Reason for out' = 'total visited', 'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / as.numeric(nrow(safety_out_v1)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
## V2 #####################

  safety_out_v2 <- data %>%
    filter(visit == 'V2',
           safetystatus == 'out')
  
  # make a table of why people are out
  out_reasons_v2 <- safety_out_v2 %>%
    group_by(safety_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for out' = safety_reason) %>%
    add_row('Reason for out' = 'total visited', 'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / as.numeric(nrow(safety_out_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
## V3 #####################

  safety_out_v3 <- data %>%
    filter(visit == 'V3',
           safetystatus == 'out')
  
  # make a table of why people are out
  out_reasons_v3 <- safety_out_v3 %>%
    group_by(safety_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for out' = safety_reason) %>%
    add_row('Reason for out' = 'total visited', 'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / as.numeric(nrow(safety_out_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V4 #####################

  safety_out_v4 <- data %>%
    filter(visit == 'V4',
           safetystatus == 'out')
  
  # make a table of why people are out
  out_reasons_v4 <- safety_out_v4 %>%
    group_by(safety_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for out' = safety_reason) %>%
    add_row('Reason for out' = 'total visited', 'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / as.numeric(nrow(safety_out_v4)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
```

```{r refusal}
## this will create a table of how many people are refusal and why they are refusal

## V1 #####################

  safety_refusal_v1 <- data %>%
    filter(visit == 'V1',
           safetystatus == 'refusal')
  
  # make a table of why people are refusal
  refusal_reasons_v1 <- safety_refusal_v1 %>%
    group_by(safety_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for refusal' = safety_reason) %>%
    add_row('Reason for refusal' = 'total visited', 'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / as.numeric(nrow(safety_refusal_v1)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

## V2 #####################

  safety_refusal_v2 <- data %>%
    filter(visit == 'V2',
           safetystatus == 'refusal')
  
  # make a table of why people are refusal
  refusal_reasons_v2 <- safety_refusal_v2 %>%
    group_by(safety_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for refusal' = safety_reason) %>%
    add_row('Reason for refusal' = 'total visited', 'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / as.numeric(nrow(safety_refusal_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
## V3 #####################

  safety_refusal_v3 <- data %>%
    filter(visit == 'V3',
           safetystatus == 'refusal')
  
  # make a table of why people are refusal
  refusal_reasons_v3 <- safety_refusal_v3 %>%
    group_by(safety_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for refusal' = safety_reason) %>%
    add_row('Reason for refusal' = 'total visited', 'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / as.numeric(nrow(safety_refusal_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V4 #####################

  safety_refusal_v4 <- data %>%
    filter(visit == 'V4',
           safetystatus == 'refusal')
  
  # make a table of why people are refusal
  refusal_reasons_v4 <- safety_refusal_v4 %>%
    group_by(safety_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for refusal' = safety_reason) %>%
    add_row('Reason for refusal' = 'total visited', 'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / as.numeric(nrow(safety_refusal_v4)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

```
## Safety targets
```{r target_show}
reactable(target_table, columns = list(), pagination = FALSE)
```

## V3 Numbers
### Overall safety statuses
```{r v3_total_show}
reactable(total_safety_status_v3, columns = list(
  `Percent complete` = colDef(align = "right")
))

# make a note of the real total number of people visited without repeats
if (any(duplicated(total_safety_v3$extid))) {
  cat("Note: Excluding the duplicates, the real total number of people visited is", length(unique(total_safety_v3$extid)), "\n")
} else {
  "Note: There are no duplicates based on extid in the data."
}
```

### in
```{r v3_in_show}
reactable(in_type_v3, columns = list(
  `Percent` = colDef(align = "right")
))
```

### eos
```{r v3_eos}
reactable(eos_reasons_v3, columns = list(
  `Percent of eos` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page
```

#### follow up visit
```{r v3_eos_show}
reactable(eos_reasons_followup_v3, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('not wish to continue', 'not agree to safety procedures', 'not resident', 'under weight', 'study drug', 'concom meds', 'severe illness', 'baby under 1 week', 'pregnant', 'other trials', 'visited loa loa', 'spent night at the hospital', 'pregnancy test refusal', 'participant withdrew informed consent', 'died', 'migrated', 'eos in V1')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% eos_reasons_followup_v3$'Reason for eos') {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("Note: The following are not reasons to be eos: (", paste0(not_found_names, collapse = "/ "), ".")
}
```

#### enrolment visit
```{r v3_eos_enrolment}
reactable(eos_reasons_enrolment_v3, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('not agree to safety procedures', 'not resident', 'under weight', 'study drug', 'concom meds', 'severe illness', 'baby under 1 week', 'pregnant, other trials', 'visited loa loa', 'participant withdrew informed consent')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% eos_reasons_enrolment_v3$'Reason for eos') {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for eos status:", paste0(not_found_names, collapse = "/ "))
}
```

### out
``` {r v3_out_show}
reactable(out_reasons_v3, columns = list(`Percent complete` = colDef(align = 'right')))
```

### refusal
``` {r v3_refusal_show}
reactable(refusal_reasons_v3, columns = list(`Percent complete` = colDef(align = 'right')))
```


## V2 Numbers
### Overall safety statuses
```{r v2_total_show}
reactable(total_safety_status_v2, columns = list(
  `Percent complete` = colDef(align = "right")
))

# make a note of the real total number of people visited without repeats
if (any(duplicated(total_safety_v2$extid))) {
  cat("Note: Excluding the duplicates, the real total number of people visited is", length(unique(total_safety_v2$extid)), "\n")
} else {
  "Note: There are no duplicates based on extid in the data."
}
```

### in
```{r v2_in_show}
reactable(in_type_v2, columns = list(
  `Percent` = colDef(align = "right")
))
```

### eos
```{r}
reactable(eos_reasons_v2, columns = list(
  `Percent of eos` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page
```

#### follow up visit
```{r v2_eos_show}
reactable(eos_reasons_followup_v2, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('not wish to continue', 'not agree to safety procedures', 'not resident', 'under weight', 'study drug', 'concom meds', 'severe illness', 'baby under 1 week', 'pregnant', 'other trials', 'visited loa loa', 'spent night at the hospital', 'pregnancy test refusal', 'participant withdrew informed consent', 'died', 'migrated', 'eos in V1')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% eos_reasons_followup_v2$'Reason for eos') {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("Note: The following are not reasons to be eos (", paste0(not_found_names, collapse = "/ "), ".")
}
```

#### enrolment visit
```{r eos_enrolment}
reactable(eos_reasons_enrolment_v2, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('not agree to safety procedures', 'not resident', 'under weight', 'study drug', 'concom meds', 'severe illness', 'baby under 1 week', 'pregnant, other trials', 'visited loa loa', 'participant withdrew informed consent')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% eos_reasons_enrolment_v2$'Reason for eos') {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for eos status:", paste0(not_found_names, collapse = "/ "))
}
```

### out
``` {r v2_out_show}
reactable(out_reasons_v2, columns = list(`Percent complete` = colDef(align = 'right')))
```

### refusal
``` {r v2_refusal_show}
reactable(refusal_reasons_v2, columns = list(`Percent complete` = colDef(align = 'right')))
```

## V1 Numbers
### Overall safety statuses
```{r v1_total_show}
reactable(total_safety_status_v1, columns = list(
  `Percent complete` = colDef(align = "right")
))

# make a note of the real total number of people visited without repeats
if (any(duplicated(total_safety_v1$extid))) {
  cat("Note: Excluding the duplicates, the real total number of people visited is", length(unique(total_safety_v1$extid)), "\n")
} else {
  "Note: There are no duplicates based on extid in the data."
}
```

### Safety status by cluster
```{r cluster safety}
element_id <- 'safety-status-by-cluster'

# make the table of safety status by cluster
cluster_status <- total_safety_v1 %>%
  group_by(cluster, safetystatus) %>%
  summarise(number = n()) %>%
  group_by(cluster) %>%
  mutate(percent = paste(round((number / sum(number) * 100), 1), '%')) %>%
  pivot_wider(names_from = safetystatus,
              values_from = c(number, percent),
              values_fill = list(number = 0, percent = '0%')) %>%
  select(cluster, number_eos, percent_eos, number_refusal, percent_refusal, number_out, percent_out, number_in, percent_in) %>%
  mutate(total = sum(number_eos, number_refusal, number_out, number_in))

table <- reactable(cluster_status, columns = list(`percent_refusal` = colDef(align = 'right'),
                                                 `percent_out` = colDef(align = 'right'),
                                                 `percent_in` = colDef(align = 'right'),
                                                 `percent_eos` = colDef(align = 'right')),
                  highlight = TRUE,
                  resizable = TRUE,
                  bordered = TRUE,
                  striped = TRUE,
                  filterable=TRUE,
                  elementId = element_id)

wrap_download(
  table, 
  element_id,
  'safety_status_reason_by_cluster.csv')
```

### eos
```{r v1_eos_show}
reactable(eos_reasons_v1, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('not resident', 'under weight', 'study drug', 'concom meds', 'severe illness', 'baby under 1 week', 'pregnant', 'other trials', 'visited loa loa', 'spent night at the hospital', 'pregnancy test refusal', 'pregnant', 'participant withdrew informed consent', 'not agree to safety procedures')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% eos_reasons_v1$'Reason for eos') {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for eos status:", paste0(not_found_names, collapse = "/ "))
}
```

### out
``` {r v1_out_show}
reactable(out_reasons_v1, columns = list(`Percent complete` = colDef(align = 'right')))
```

### refusal
``` {r v1_refusal_show}
reactable(refusal_reasons_v1, columns = list(`Percent complete` = colDef(align = 'right')))
```

## extid explorer
```{r extid-explorer}
element_id <- 'extid-explorerer'

data_readable <- reactable(data_investigation, columns = list(), 
                                              highlight = TRUE,
                                              resizable = TRUE,
                                              bordered = TRUE,
                                              striped = TRUE,
                                              filterable=TRUE,
                                              elementId = element_id
                                              )

wrap_download(
  data_readable, 
  element_id,
  'efficacy_extid_explorer.csv')
```
