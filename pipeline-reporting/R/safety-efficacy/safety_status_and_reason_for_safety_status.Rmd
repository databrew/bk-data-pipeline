---
title: "Safety Status Report"
output: 
  html_document:
    toc: true
    toc_float: 
      collapsed: true
    theme: cerulean
date: '`r Sys.time()`'
---

Notes:

- Report is refreshed hourly 9-5pm EAT, once 12AM EAT
- Please reach out to nika.gorski@isglobal.org for bug reports


```{r, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(
  comment = '', 
  echo = FALSE,
  message = FALSE,
  cache=FALSE,
  warning=FALSE
)
```

```{r setup, include=FALSE}
### PURPOSE:
# This code aims to determine who is out, refusal, in, and eos after safety. This information comes from Safety, Safetynew, and Absence1stattempt. Then for each status (except of in), split each status into the "reason" or the "how" they got to that status.
# load required libraries
library(dplyr)
library(reactable)
library(data.table)
library(cloudbrewr)
library(fontawesome)
library(shiny)
library(ggplot2)
library(tidyr)
library(Gmisc, quietly = TRUE)
library(glue)
library(htmlTable)
library(grid)
library(magrittr)

ENV_PIPELINE_STAGE <- Sys.getenv("PIPELINE_STAGE")
DATA_STAGING_BUCKET_NAME <- 'databrew.org'
DATA_LAKE_BUCKET_NAME <- 'bohemia-lake-db'
PROJECT_SOURCE <- 'kwale'
SE_FOLDER_TARGET <- glue::glue('{PROJECT_SOURCE}/clean-form')

pad_hhid <- function(data){
  if('hhid' %in% names(data)){
    data %>%
      dplyr::mutate(hhid = stringr::str_pad(hhid, 5, pad = "0"))
  }else{
    data
  }
}


tryCatch({
  logger::log_info('Attempt AWS login')
  # login to AWS - this will be bypassed if executed in CI/CD environment
  cloudbrewr::aws_login(
    role_name = 'cloudbrewr-aws-role',
    profile_name =  'cloudbrewr-aws-role',
    pipeline_stage = ENV_PIPELINE_STAGE)

}, error = function(e){
  logger::log_error('AWS Login Failed')
  stop(e$message)
})


# load in the data
absence1stattempt <- cloudbrewr::aws_s3_get_table(
  bucket = DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/clean-form/absences1stattempt/absences1stattempt.csv')) %>%
  pad_hhid()

assignment <- cloudbrewr::aws_s3_get_table(
  bucket ='bohemia-lake-db',
  key = 'bohemia_ext_data/assignments/assignments.csv') %>%
  pad_hhid() %>%
  rename(cluster = cluster_number)

v0_dem_repeat <- cloudbrewr::aws_s3_get_table(
  bucket = DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/clean-form/v0demography/v0demography-repeat_individual.csv')) %>%
  pad_hhid()
  
v0_demography <- cloudbrewr::aws_s3_get_table(
  bucket = DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/clean-form/v0demography/v0demography.csv')) %>%
  pad_hhid()

safety <- cloudbrewr::aws_s3_get_table(
  bucket = DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/clean-form/safety/safety.csv')) %>%
  pad_hhid()

safetynew <- cloudbrewr::aws_s3_get_table(
  bucket =DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/clean-form/safetynew/safetynew.csv')) %>%
  pad_hhid()

safety_repeat_individual <- cloudbrewr::aws_s3_get_table(
  bucket = DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/clean-form/safety/safety-repeat_individual.csv')) %>%
  pad_hhid()

safetynew_repeat_individual <- cloudbrewr::aws_s3_get_table(
  bucket =DATA_STAGING_BUCKET_NAME,
  key = glue::glue('{PROJECT_SOURCE}/clean-form/safetynew/safetynew-repeat_individual.csv')) %>%
  pad_hhid()

safety_targets <- cloudbrewr::aws_s3_get_table(
  bucket ='bohemia-lake-db',
  key = glue::glue('bohemia_prod/dwh/goal_safety_targets/goal_safety_targets.csv')) %>%
  pad_hhid()

dropped_hhid <- cloudbrewr::aws_s3_get_table(
  bucket ='bohemia-lake-db',
  key = glue::glue('bohemia_ext_data/v0_dropped_hhid/v0_dropped_hhid.csv')) %>%
  pad_hhid()

dropped_hhid$dropped_hhid <- sprintf("%05d", dropped_hhid$dropped_hhid)

# this is a function to create a download csv button
wrap_download <- function(reactable_obj, element_id, output_filename){
  onclick_command <- glue::glue(
    "Reactable.downloadDataCSV('{element_id}', '{output_filename}')")
  htmltools::browsable(
    tagList(
      tags$button(
        tagList(fontawesome::fa("download"), "Download as CSV"),
        onclick = onclick_command),
      reactable_obj
    ))
}
```

```{r data creation}
# general edits
absence1stattempt <- absence1stattempt %>%
  rename(extid = extid_enter)
  
# create the merged safety data
  clean_safety_repeat <- safety_repeat_individual %>%
    select(PARENT_KEY, extid, safety_status, starting_safety_status, dob_string, 
           sex, participant_take_drug, participant_take_drug_2, non_resident_eos, 
           weight_eos, weight_eos_short, study_drug_eos, concom_meds_eos, 
           concom_meds_eos_short, severe_illness_eos, severe_illness_eos_short, 
           obvious_screening, baby_not_week_old_eos, pregnant_eos, 
           pregnancy_section_eos, pregnancy_section_eos_short, 
           preg_test_pos_eos_short, preg_test_2_eos_short, obvious_screening, 
           preg_test_refuse_eos_short, other_trials_eos, loa_loa_eos, 
           sum_night_hospital_eos, not_agree_safety_procedures_eos, 
           refuse_drug_eos, refuse_drug_eos_2, not_continue_eos, person_died_eos, 
           person_out_died, person_migrated, person_out_migrated, ind_witness_present, 
           person_absent, obvious_screening, ind_thumbprint_status, ind_sign_icf_status,
           minor_assent_status, starting_safety_status, out_v4, preg_test_refuse_eos_v4,
           preg_test_2_refuse_eos_v4, pregnancy_section_eos_v4, pregnant_yn_v4, 
           preg_test_pos_v4, pregnancy_status_v4, pregnancy_status, 
           v4_migrate_absent_eos, v4_absent_eos, person_present) %>%
    rename(dob = dob_string) %>%
    mutate(participant_take_drug = 
             ifelse(participant_take_drug == "", NA, participant_take_drug)) %>%
    mutate(participant_take_drug_2 = 
             ifelse(participant_take_drug_2 == "", NA, participant_take_drug_2))
  clean_safetynew_repeat <- safetynew_repeat_individual %>%
    select(PARENT_KEY, extid, safety_status, dob, sex, participant_take_drug, 
           participant_take_drug_2, non_resident_eos, weight_eos, study_drug_eos, 
           concom_meds_eos, severe_illness_eos, obvious_screening, 
           baby_not_week_old_eos, pregnant_eos, pregnancy_section_eos, 
           obvious_screening, other_trials_eos, loa_loa_eos, 
           not_agree_safety_procedures_eos, refuse_drug_eos, refuse_drug_eos_2, 
           ind_witness_present, obvious_screening, ind_thumbprint_status, 
           ind_sign_icf_status, minor_assent_status) %>%
    rename(take_drug_safetynew = participant_take_drug,
           take_drug_2_safetynew = participant_take_drug_2) %>%
    mutate(take_drug_safetynew = 
             ifelse(take_drug_safetynew == "", NA, take_drug_safetynew)) %>%
    mutate(take_drug_2_safetynew = 
             ifelse(take_drug_2_safetynew == "", NA, take_drug_2_safetynew))
  clean_safety <- safety %>%
    select(KEY, visit, todays_date, hhid, cluster)
  clean_safetynew <- safetynew %>%
    select(KEY, visit, todays_date, hhid, cluster)
  
  # join safety and safety repeat and do the same for safetynew
  joined_safety <- left_join(clean_safety, clean_safety_repeat, by=c('KEY' = 'PARENT_KEY')) %>%
    mutate(type = 'OG')
  joined_safetynew <- left_join(clean_safetynew_repeat, clean_safetynew, by=c('PARENT_KEY' = 'KEY')) %>% 
    mutate(starting_safety_status = 'out',
           type = 'new')
  
  # join these two new dataframes
  total_safety <- bind_rows(joined_safety, joined_safetynew) %>%
    mutate(cluster = as.numeric(substr(extid, 1, 2)),
           took_drug = coalesce(participant_take_drug, 
                                participant_take_drug_2, 
                                take_drug_safetynew, 
                                take_drug_2_safetynew),
           safetystatus = safety_status,
           enrolment = case_when(
                (starting_safety_status == 'out' |
                    is.na(starting_safety_status)) &
                 safety_status != 'out' ~ 'enrolment',
              TRUE ~ 'follow up'),
           safety_reason = case_when(
             non_resident_eos == '1' ~ 'not resident',
             weight_eos == '1' |
               weight_eos_short == '1' ~ 'under weight',
             study_drug_eos == '1' ~ 'study drug',
             concom_meds_eos == '1' |
               concom_meds_eos_short == '1' ~ 'concom meds',
             severe_illness_eos == '1' |
               severe_illness_eos_short == '1' |
               obvious_screening == 'Ill' ~ 'severe illness',
             baby_not_week_old_eos == '1' ~ 'baby under 1 week',
             preg_test_refuse_eos_short == '1' |
               preg_test_refuse_eos_v4 == '1' |
               preg_test_2_refuse_eos_v4 == '1' |
               pregnancy_section_eos_v4 == '1' ~ 'pregnancy test refusal',
             pregnant_eos == '1' |
               preg_test_pos_eos_short == '1' |
               preg_test_2_eos_short == '1' |
               obvious_screening == 'Pregnant' |
               pregnancy_section_eos_short == '1' |
               pregnancy_section_eos == '1' |
               preg_test_pos_v4 == '1' |
               pregnancy_status_v4 == 'in' ~ 'pregnant',
             other_trials_eos == '1' ~ 'other trials',
             loa_loa_eos == '1' ~ 'visited loa loa',
             sum_night_hospital_eos >= '1' ~ 'spent night at the hospital',
             not_agree_safety_procedures_eos == '1' ~ 'not agree to safety procedures',
             refuse_drug_eos == '1' |
               refuse_drug_eos_2 == '1' ~ 'participant withdrew informed consent (refuse drug)',
             not_continue_eos == '1' ~ 'not wish to continue',
             person_died_eos == '1' |
               person_out_died == '1' ~ 'died',
             person_migrated == '1' & 
               starting_safety_status == 'in' |
               person_out_migrated == '1' |
               v4_migrate_absent_eos == '1' ~ 'migrated',
             obvious_screening == 'ineligible' ~ 'Ineligible at obvious reasoning',
             obvious_screening == 'Baby' ~ 'A baby that cannot walk yet',
             obvious_screening == 'Witness' |
               ind_witness_present == '1 ' ~ 'no witness',
             person_absent == '1' |
               v4_absent_eos == '1' ~ 'absent',
             obvious_screening == 'Refusal' ~ 'a person who does not want to participate',
             obvious_screening == 'Language' ~ 'does not speak English or Swahili',
             ind_thumbprint_status == '0' ~ 'not consented or provided their thumbprint',
             ind_sign_icf_status == '0' ~ 'not agree or sign informed consent',
             minor_assent_status == '0' ~ 'minor not sign assent',
             safety_status == 'completion' ~ 'completion',
             safety_status == 'in' ~ 'in',
             starting_safety_status == 'eos' ~ 'previously eos',
             starting_safety_status == 'refusal' ~ 'previously refusal',
             starting_safety_status == 'out' |
              out_v4 == '1' ~ 'previously out',
             TRUE ~ NA_character_  # To handle cases that don't match any condition
           )) 
  
  total_safety <- left_join(total_safety, assignment, by='cluster') %>%
    filter(extid != '2437-61',
           safety_status != 'UNDEFINED')
  
  # create the merged v0 data
  v0dem <- left_join(v0_dem_repeat, v0_demography, by=c('PARENT_KEY' = 'KEY')) %>%
    select(extid, dob, sex, todays_date) %>%
    rename(dob_v0 = dob,
           todays_date_v0 = todays_date,
           sex_v0 = sex) %>%
    mutate(sex_v0 = tolower(sex_v0)) 
  
  
# join total_safety and v0 data
  data <- merge(total_safety, v0dem, by = c('extid'), all = TRUE) %>%
    filter(!hhid %in% dropped_hhid$dropped_hhid)
  
  
# create the dataset for the extid explorer
  data_investigation <- data %>%
    rename(dob_safety_visit = dob,
           todays_date_safety = todays_date,
           sex_safety = sex) %>%
    filter(!is.na(visit),
           safety_status != 'UNDEFINED') %>% 
    select(visit, extid, safety_status, safety_reason, 
           enrolment, sex_v0, sex_safety, dob_v0, 
           dob_safety_visit, todays_date_v0, todays_date_safety, assignment)
  
# a trial profile tracks where every person went
  by_visit <- data %>%
    pivot_wider(id_cols = c(extid, hhid, cluster, assignment), 
                names_from = visit,
                values_from = c(safety_status, safety_reason)) %>%
    select(extid, hhid, safety_status_V1, safety_status_V2, safety_status_V3,
           safety_status_V4, safety_reason_V1, safety_reason_V2, safety_reason_V3, 
           safety_reason_V4, assignment, cluster) %>%
    rename(status_V1 = safety_status_V1,
           reason_V1 = safety_reason_V1,
           status_V2 = safety_status_V2,
           reason_V2 = safety_reason_V2,
           status_V3 = safety_status_V3,
           reason_V3 = safety_reason_V3,
           status_V4 = safety_status_V4,
           reason_V4 = safety_reason_V4)

```

```{r trial_by_visit}
# show the assignment of people who were in at each visit
trial_by_visit <- data %>%
  filter(safety_status %in% c('in')) %>%
  group_by(visit, assignment) %>%
    summarise('N' = n()) %>%
    group_by(visit) %>%
    pivot_wider(names_from = assignment, values_from = N) %>%
    ungroup() %>%
    arrange(visit) %>%
    rename('IN people per visit' = visit) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

# women_by_arm <- enrolled %>%
#   mutate(age = round(as.numeric(difftime('2023-10-01', dob_v0, units = "days") / 365.25), 2)) %>%
#   filter(sex_v0 == 'female',
#          age > '13' & age < '49', # reproductive age
#          safety_status == 'in') %>% 
#   group_by(extid) %>%
#   arrange(desc(visit)) %>%
#   group_by(extid) %>%
#   slice(1) %>%
#   ungroup() 
#   
#   table(women_by_arm$assignment)

```

```{r safety_trial_profile_dem_v1}
######### SAFETY SELECTION #############
# make a v0 dataset and assign it to type OG to distinguish between this and safetynew
v0data <- left_join(v0_dem_repeat, v0_demography, by=c('PARENT_KEY' = 'KEY')) %>%
  left_join(assignment, by='cluster') %>%
    select(extid, hhid, cluster, safety_status, assignment) %>%
  mutate(safety_reason = 'V0',
         visit = 'V0',
         type = 'OG')

num_extid_v0_total_visited <- length(unique(v0data$extid))
num_hhid_v0_total_visited <- length(unique(v0data$hhid))

v0_removed_hhids <- unique(dropped_hhid$dropped_hhid)
num_v0_removed_hhid <- length(v0_removed_hhids)

v0_removed_hhids_dataset <- v0data %>%
  filter(hhid %in% v0_removed_hhids)
num_v0_removed_extid <- length(unique(v0_removed_hhids_dataset$extid))

v0_clean <- v0data %>%
  filter(!hhid %in% v0_removed_hhids)

num_extid_v0_clean <- length(unique(v0_clean$extid))
num_hhid_v0_clean <- length(unique(v0_clean$hhid))


##### V1
v1safety <- data %>%
  filter(visit == 'V1') %>%
  select(visit, extid, hhid, cluster, starting_safety_status, safety_status, safety_reason, assignment, type, pregnancy_status)
num_extid_v1_total_visited <- length(unique(v1safety$extid))
num_hhid_v1_total_visited <- length(unique(v1safety$hhid))

v1safety_new <- v1safety %>%
  filter(type == 'new')
num_extid_v1_new_visited <- length(unique(v1safety_new$extid))
num_hhid_v1_new_visited <- length(unique(v1safety_new$hhid))

v1safety_og <- v1safety %>%
  filter(type == 'OG')
num_extid_v1_og_visited <- length(unique(v1safety_og$extid))
num_hhid_v1_og_visited <- length(unique(v1safety_og$hhid))


# missed V1
v1_not_visited <- anti_join(v0_clean, v1safety, by='extid') %>% 
    select(cluster, extid, hhid) %>%
    mutate(visit = 'V1',
           safety_status = 'out',
           safety_reason = 'missed V1',
           starting_safety_status = 'out')

num_extid_v1_not_visited <- length(unique(v1_not_visited$extid))
num_hhid_v1_not_visited <- length(unique(v1_not_visited$hhid))

v1_hhid_visited_extid_not <- semi_join(v1_not_visited, v1safety, by='hhid')
    num_v1_hhid_visited_extid_not <- length(unique(v1_hhid_visited_extid_not$hhid))
  
  
# refusal information
  v1_refusals <- v1safety %>%
    filter(visit == 'V1') %>%
    filter(safety_status == 'refusal' | safety_reason %in% c('migrated', 'died'))
  
  v1_100_refusal_dataset <- v1safety %>%
    group_by(hhid) %>%
    filter(all(extid %in% v1_refusals$extid),
           safety_status == 'refusal' | safety_reason %in% c('migrated', 'died')) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() %>%
    select(extid, hhid, visit, safety_status, safety_reason, assignment)
  num_extid_v1_100_refusal <- length(unique(v1_100_refusal_dataset$extid))
  num_hhid_v1_100_refusal <- length(unique(v1_100_refusal_dataset$hhid))
  
  v1_ref_ref <- v1_100_refusal_dataset %>%
    group_by(hhid) %>%
    filter(all(safety_status == 'refusal')) 
  num_extid_v1_ref_ref <- length(unique(v1_ref_ref$extid))
  num_hhid_v1_ref_ref <- length(unique(v1_ref_ref$hhid))
  
  v1_mig_died <- v1_100_refusal_dataset %>%
    group_by(hhid) %>%
    filter(all(safety_reason %in% c('migrated', 'died')))
  num_extid_v1_mig_died <- length(unique(v1_mig_died$extid))
  num_hhid_v1_mig_died <- length(unique(v1_mig_died$hhid))
  
  v1_ref_mig_died <- v1_100_refusal_dataset %>%
    filter(!(hhid %in% v1_ref_ref$hhid) & !(hhid %in% v1_mig_died$hhid)) 
  num_extid_v1_ref_mig_died <- length(unique(v1_ref_mig_died$extid))
  num_hhid_v1_ref_mig_died <- length(unique(v1_ref_mig_died$hhid))
  


  
# migrations 
v1_migrations <- v1safety %>%
  filter(safety_reason == 'migrated')
  num_extid_v1_migrations <- length(unique(v1_migrations$extid))
  num_hhid_v1_migrations <- length(unique(v1_migrations$hhid))

v1_migrated_hhs <- v1safety %>%
    group_by(hhid) %>%
    filter(all(extid %in% v1_migrations$extid),
           safety_reason %in% c('migrated'))
  num_hhid_v1_all_migrations <- length(unique(v1_migrated_hhs$hhid))
  
  v1_mig_hhs_not_100 <- v1_migrations %>%
    filter(!extid %in% v1_100_refusal_dataset$extid)
  num_extid_v1_mig_hhs_not_100 <- length(unique(v1_mig_hhs_not_100$extid))
  
  v1_mig_hhs_100 <- v1_migrations %>%
    filter(extid %in% v1_100_refusal_dataset$extid)
  num_extid_v1_mig_hhs_100 <- length(unique(v1_mig_hhs_100$extid))
  
  
  
# deaths
v1_death <- v1safety %>%
  filter(safety_reason == 'died')

v1_death_hhs <- v1safety %>%
    group_by(hhid) %>%
    filter(all(extid %in% v1_death$extid),
           safety_reason %in% c('died'))
  num_extid_v1_death <- length(unique(v1_death$extid))
  num_hhid_v1_death <- length(unique(v1_death$hhid))
  num_hhid_v1_all_death <- length(unique(v1_death_hhs$hhid))
  
  v1_died_hhs_not_100 <- v1_death %>%
    filter(!extid %in% v1_100_refusal_dataset$extid)
  num_extid_v1_died_hhs_not_100 <- length(unique(v1_died_hhs_not_100$extid))
  
  
  # pregnancies
  v1_pregnancies <- v1safety %>%
    filter(pregnancy_status == 'in')
  
  v1_preg_pfu <- length(unique(v1_pregnancies$extid))

    
  
# create safety clean by removing deaths, migrations, and 100% refusal households
  v1_clean <- v1safety %>%
    filter(!extid %in% c(v1_100_refusal_dataset$extid, 
                         v1_death$extid, 
                         v1_migrations$extid))
  num_extid_v1_clean <- length(unique(v1_clean$extid))
  num_hhid_v1_clean <- length(unique(v1_clean$hhid))
  
# make a safety v2 target by adding missed extids and removing eos, refusal, migrated and died
  v2_target <- v1_clean %>%
    bind_rows(v1_not_visited) %>%
    filter(safety_status %in% c('in', 'out'),
           !safety_reason %in% c('migrated', 'died'))
  num_hhid_v2_target <- length(unique(v2_target$hhid))
  
  v2_target_real <- v1_clean %>%
    bind_rows(v1_not_visited)
  num_hhid_v2_target_real <- length(unique(v2_target_real$hhid))
  num_extid_v2_target_real <- length(unique(v2_target_real$extid))
  
# make table of safety statuses
  v1safety_statuses <- v1safety %>%
    group_by(safety_status) %>%
    summarize(n = n()) %>%
    rename('V1 Visited' = n) %>%
    add_row(safety_status = 'total', 'V1 Visited' = sum(.$'V1 Visited'))
  
  v1safety_clean_statuses <- v1_clean %>%
    group_by(safety_status) %>%
    summarize(n = n()) %>%
    rename('V1 Clean' = n) %>%
    add_row(safety_status = 'total', 'V1 Clean' = sum(.$'V1 Clean'))
  
  v2safety_target_statuses <- v2_target %>%
    filter(safety_status %in% c('in', 'out'),
           !safety_reason %in% c('migrated', 'died')) %>%
    group_by(safety_status) %>%
    summarize(`V2 Target` = n()) %>%
    add_row(safety_status = 'eos', `V2 Target` = 0) %>%
    add_row(safety_status = 'refusal', `V2 Target` = 0) %>%
    add_row(safety_status = 'total', `V2 Target` = sum(.$'V2 Target'))
  
  v2safety_target_calculated_statuses <- v1safety %>%
    bind_rows(v1_not_visited) %>%
    filter(!safety_reason %in% c('migrated', 'died'),
           !extid %in% c(v1_100_refusal_dataset$extid, 
                         v1_death$extid, 
                         v1_migrations$extid)) %>%
    group_by(safety_status) %>%
    summarize(`V2 Calculated Target` = n()) %>%
    add_row(safety_status = 'total', `V2 Calculated Target` = sum(.$'V2 Calculated Target'))
  
  v1statuses <- merge(v1safety_statuses, 
                      v1safety_clean_statuses,
                      by='safety_status')  %>%
    merge(v2safety_target_calculated_statuses, by = 'safety_status') %>%
    merge(v2safety_target_statuses, by='safety_status')


  # for in
  v1_in_target <- v2_target %>%
    filter(safety_status == 'in')
  num_v1_in_target <- length(unique(v1_in_target$extid))
  
  # for out
  v1_out <- v1safety %>%
    filter(safety_status == 'out')
  num_v1_out <- length(v1_out$extid)
  
  v1_out_mig <- v1_out %>%
    filter(safety_reason == c('migrated'))
  num_v1_out_mig <- length(unique(v1_out_mig$extid))
  
  v1_out_died <- v1_out %>%
    filter(safety_reason == c('died'))
  num_v1_out_died <- length(unique(v1_out_died$extid))
  
  v2_target_out_start <- v1_out %>%
    filter(!extid %in% c(v1_out_died$extid, v1_out_mig$extid, v1_not_visited$extid)) 
  num_v2_target_out_start <- length(unique(v2_target_out_start$extid))
  
  v2_target_out <- v2_target %>%
    filter(safety_status == 'out') 
  num_v2_target_out <- length(unique(v2_target_out$extid))

  

  
  # for refusal
  
  v1_refusal <- v1safety %>%
    filter(safety_status == 'refusal')
  num_v1_refusal <- length(unique(v1_refusal$extid))
  
  v1_ref_removed <- v1_refusal %>%
    filter(extid %in% v1_100_refusal_dataset$extid)
  num_v1_ref_removed <- length(unique(v1_ref_removed$extid))
  
  
# tracking safety statuses
  v1_status_pathway_data <- v1safety %>%
    mutate(pathway = case_when(
      starting_safety_status == 'out' & safety_status == 'out' ~ 'out to out',
      starting_safety_status == 'out' & safety_status == 'refusal' ~ 'out to refusal',
      starting_safety_status == 'out' & safety_status == 'in' ~ 'out to in',
      starting_safety_status == 'out' & safety_status == 'out' ~ 'out to out',
      starting_safety_status == 'out' & safety_status == 'eos' ~ 'out to eos',
      starting_safety_status == 'in' & safety_status == 'eos' ~ 'in to eos',
      starting_safety_status == 'in' & safety_status == 'in' ~ 'in to in',
      starting_safety_status == 'in' & safety_status == 'completion' ~ 'in to completion',
      TRUE ~ 'other'
    )) 
  
  v1_status_pathway <- v1_status_pathway_data %>%
    group_by(pathway) %>%
    summarize(count = n()) %>%
    add_row(pathway = 'total', count = sum(.$count))

```

```{r safety_trial_profile_v2}
##### V2
v2safety <- data %>%
  filter(visit == 'V2') %>%
  select(visit, extid, hhid, cluster, starting_safety_status, safety_status, safety_reason, assignment, type, took_drug, pregnancy_status)
num_extid_v2_total_visited <- length(unique(v2safety$extid))
num_hhid_v2_total_visited <- length(unique(v2safety$hhid))

v2safety_new <- v2safety %>%
  filter(type == 'new')
num_extid_v2_new_visited <- length(unique(v2safety_new$extid))
num_hhid_v2_new_visited <- length(unique(v2safety_new$hhid))

v2safety_og <- v2safety %>%
  filter(type == 'OG')
num_extid_v2_og_visited <- length(unique(v2safety_og$extid))
num_hhid_v2_og_visited <- length(unique(v2safety_og$hhid))


# missed V2
v2_not_visited <- anti_join(v2_target_real, v2safety, by='extid') %>% 
    select(cluster, extid, hhid, visit, safety_status, safety_reason, starting_safety_status)

num_extid_v2_not_visited <- length(unique(v2_not_visited$extid))
num_hhid_v2_not_visited <- length(unique(v2_not_visited$hhid))

v2_hhid_visited_extid_not <- semi_join(v2_not_visited, v2safety, by='hhid')
    num_v2_hhid_visited_extid_not <- length(unique(v2_hhid_visited_extid_not$hhid))
  
  
# refusal information
  v2_refusals <- v2safety %>%
    filter(visit == 'V2') %>%
    filter(safety_status == 'refusal' | safety_reason %in% c('migrated', 'died'))
  
  v2_100_refusal_dataset <- v2safety %>%
    group_by(hhid) %>%
    filter(all(extid %in% v2_refusals$extid),
           safety_status == 'refusal' | safety_reason %in% c('migrated', 'died')) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() %>%
    select(extid, hhid, visit, safety_status, safety_reason, assignment)
  num_extid_v2_100_refusal <- length(unique(v2_100_refusal_dataset$extid))
  num_hhid_v2_100_refusal <- length(unique(v2_100_refusal_dataset$hhid))
  
  v2_ref_ref <- v2_100_refusal_dataset %>%
    group_by(hhid) %>%
    filter(all(safety_status == 'refusal')) 
  num_extid_v2_ref_ref <- length(unique(v2_ref_ref$extid))
  num_hhid_v2_ref_ref <- length(unique(v2_ref_ref$hhid))
  
  v2_mig_died <- v2_100_refusal_dataset %>%
    group_by(hhid) %>%
    filter(all(safety_reason %in% c('migrated', 'died')))
  num_extid_v2_mig_died <- length(unique(v2_mig_died$extid))
  num_hhid_v2_mig_died <- length(unique(v2_mig_died$hhid))
  
  v2_ref_mig_died <- v2_100_refusal_dataset %>%
    filter(!(hhid %in% v2_ref_ref$hhid) & !(hhid %in% v2_mig_died$hhid)) 
  num_extid_v2_ref_mig_died <- length(unique(v2_ref_mig_died$extid))
  num_hhid_v2_ref_mig_died <- length(unique(v2_ref_mig_died$hhid))
  


# migrations 
v2_migrations <- v2safety %>%
  filter(safety_reason == 'migrated')
  num_extid_v2_migrations <- length(unique(v2_migrations$extid))
  num_hhid_v2_migrations <- length(unique(v2_migrations$hhid))

v2_migrated_hhs <- v2safety %>%
    group_by(hhid) %>%
    filter(all(extid %in% v2_migrations$extid),
           safety_reason %in% c('migrated'))
  num_hhid_v2_all_migrations <- length(unique(v2_migrated_hhs$hhid))
  
  v2_mig_hhs_not_100 <- v2_migrations %>%
    filter(!extid %in% v2_100_refusal_dataset$extid)
  num_extid_v2_mig_hhs_not_100 <- length(unique(v2_mig_hhs_not_100$extid))
  
  v2_mig_hhs_100 <- v2_migrations %>%
    filter(extid %in% v2_100_refusal_dataset$extid)
  num_extid_v2_mig_hhs_100 <- length(unique(v2_mig_hhs_100$extid))
  
  
  
# deaths
v2_death <- v2safety %>%
  filter(safety_reason == 'died')
  num_extid_v2_death <- length(unique(v2_death$extid))
  num_hhid_v2_death <- length(unique(v2_death$hhid))

v2_death_hhs <- v2safety %>%
    group_by(hhid) %>%
    filter(all(extid %in% v2_death$extid),
           safety_reason %in% c('died'))
  num_hhid_v2_all_death <- length(unique(v2_death_hhs$hhid))
  
  v2_died_hhs_not_100 <- v2_death %>%
    filter(!extid %in% v2_100_refusal_dataset$extid)
  num_extid_v2_died_hhs_not_100 <- length(unique(v2_died_hhs_not_100$extid))
  
  v2_died_hhs_100 <- v2_death %>%
    filter(extid %in% v2_100_refusal_dataset$extid)
  num_extid_v2_died_hhs_100 <- length(unique(v2_died_hhs_100$extid))
  
  
  
  # pregnancies
  v2_pregnancies <- v2safety %>%
    filter(pregnancy_status == 'in')
  
  v2_preg_pfu <- length(unique(v2_pregnancies$extid))

    
  
# create safety clean by removing deaths, migrations, and 100% refusal households
  v2_clean <- v2safety %>%
    filter(!extid %in% c(v2_100_refusal_dataset$extid, 
                         v2_death$extid, 
                         v2_migrations$extid))
  num_extid_v2_clean <- length(unique(v2_clean$extid))
  num_hhid_v2_clean <- length(unique(v2_clean$hhid))
  
# make a safety v2 target by adding missed extids and removing eos, refusal, migrated and died
  v3_target <- v2_clean %>%
    bind_rows(v2_not_visited) %>%
    filter(safety_status %in% c('in', 'out'),
           !safety_reason %in% c('migrated', 'died'))
  num_hhid_v3_target <- length(unique(v3_target$hhid))
  
  v3_target_real <- v2_clean %>%
    bind_rows(v2_not_visited)
  num_hhid_v3_target_real <- length(unique(v3_target_real$hhid))
  num_extid_v3_target_real <- length(unique(v3_target_real$extid))
  
  
# make table of safety statuses
  v2safety_statuses <- v2safety %>%
    group_by(safety_status) %>%
    summarize(n = n()) %>%
    rename('V2 Visited' = n) %>%
    add_row(safety_status = 'total', 'V2 Visited' = sum(.$'V2 Visited'))
  
  v2safety_clean_statuses <- v2_clean %>%
    group_by(safety_status) %>%
    summarize(n = n()) %>%
    rename('V2 Clean' = n) %>%
    add_row(safety_status = 'total', 'V2 Clean' = sum(.$'V2 Clean'))
  
  v3safety_target_statuses <- v3_target %>%
    filter(safety_status %in% c('in', 'out'),
           !safety_reason %in% c('migrated', 'died')) %>%
    group_by(safety_status) %>%
    summarize(`V3 Target` = n()) %>%
    add_row(safety_status = 'eos', `V3 Target` = 0) %>%
    add_row(safety_status = 'refusal', `V3 Target` = 0) %>%
    add_row(safety_status = 'total', `V3 Target` = sum(.$'V3 Target'))
  
  v3safety_target_calculated_statuses <- v2safety %>%
    bind_rows(v2_not_visited) %>%
    filter(!safety_reason %in% c('migrated', 'died'),
           !extid %in% c(v2_100_refusal_dataset$extid, 
                         v2_death$extid, 
                         v2_migrations$extid)) %>%
    group_by(safety_status) %>%
    summarize(`V3 Calculated Target` = n()) %>%
    add_row(safety_status = 'total', `V3 Calculated Target` = sum(.$'V3 Calculated Target'))
  
  v2statuses <- merge(v2safety_statuses, 
                      v2safety_clean_statuses,
                      by='safety_status')  %>%
    merge(v3safety_target_calculated_statuses, by = 'safety_status') %>%
    merge(v3safety_target_statuses, by='safety_status')

  # for in
  v2_in_target <- v3_target %>%
    filter(safety_status == 'in')
  num_v2_in_target <- length(unique(v2_in_target$extid))
  
  # for out
  v2_out <- v2safety %>%
    filter(safety_status == 'out')
  num_v2_out <- length(v2_out$extid)
  
  v2_out_mig <- v2_out %>%
    filter(safety_reason == c('migrated'))
  num_v2_out_mig <- length(unique(v2_out_mig$extid))
  
  v2_out_died <- v2_out %>%
    filter(safety_reason == c('died'))
  num_v2_out_died <- length(unique(v2_out_died$extid))
  
  v3_target_out_start <- v2_out %>%
    filter(!extid %in% c(v2_out_died$extid, v2_out_mig$extid, v2_not_visited$extid)) 
  num_v3_target_out_start <- length(unique(v3_target_out_start$extid))
  
  v3_target_out <- v3_target %>%
    filter(safety_status == 'out') 
  num_v3_target_out <- length(unique(v3_target_out$extid))

  

  
  # for refusal
  
  v2_refusal <- v2safety %>%
    filter(safety_status == 'refusal')
  num_v2_refusal <- length(unique(v2_refusal$extid))
  
  v2_ref_removed <- v2_refusal %>%
    filter(extid %in% v2_100_refusal_dataset$extid)
  num_v2_ref_removed <- length(unique(v2_ref_removed$extid))
  
  
# tracking safety statuses
  v2_status_pathway_data <- v2safety %>%
    mutate(pathway = case_when(
      starting_safety_status == 'out' & safety_status == 'out' ~ 'out to out',
      starting_safety_status == 'eos' & safety_status == 'eos' ~ 'previously eos',
      starting_safety_status == 'refusal' & safety_status == 'refusal' ~ 'previously refusal',
      starting_safety_status == 'out' & safety_status == 'refusal' ~ 'out to refusal',
      starting_safety_status == 'out' & safety_status == 'in' ~ 'out to in',
      starting_safety_status == 'out' & safety_status == 'out' ~ 'out to out',
      starting_safety_status == 'out' & safety_status == 'eos' ~ 'out to eos',
      starting_safety_status == 'in' & safety_status == 'eos' ~ 'in to eos',
      starting_safety_status == 'in' & safety_status == 'in' ~ 'in to in',
      starting_safety_status == 'in' & safety_status == 'completion' ~ 'in to completion',
      TRUE ~ 'other'
    ))
  
  v2_status_pathway <- v2_status_pathway_data %>%
    group_by(pathway) %>%
    summarize(count = n()) %>%
    add_row(pathway = 'total', count = sum(.$count))

```

```{r safety_trial_profile_v3}
##### V3
v3safety <- data %>%
  filter(visit == 'V3') %>%
  select(visit, extid, hhid, cluster, starting_safety_status, safety_status, safety_reason, assignment, type, took_drug, pregnancy_status)
num_extid_v3_total_visited <- length(unique(v3safety$extid))
num_hhid_v3_total_visited <- length(unique(v3safety$hhid))

v3safety_new <- v3safety %>%
  filter(type == 'new')
num_extid_v3_new_visited <- length(unique(v3safety_new$extid))
num_hhid_v3_new_visited <- length(unique(v3safety_new$hhid))

v3safety_og <- v3safety %>%
  filter(type == 'OG')
num_extid_v3_og_visited <- length(unique(v3safety_og$extid))
num_hhid_v3_og_visited <- length(unique(v3safety_og$hhid))


# missed V3
v3_not_visited <- anti_join(v3_target_real, v3safety, by='extid') %>% 
    select(cluster, extid, hhid, visit, safety_status, safety_reason, starting_safety_status) 

num_extid_v3_not_visited <- length(unique(v3_not_visited$extid))
num_hhid_v3_not_visited <- length(unique(v3_not_visited$hhid))

v3_hhid_visited_extid_not <- semi_join(v3_not_visited, v3safety, by='hhid')
    num_v3_hhid_visited_extid_not <- length(unique(v3_hhid_visited_extid_not$hhid))
    
    
# refusal information
    v3_refusals <- v3safety %>%
    filter(visit == 'V3') %>%
    filter(safety_status == 'refusal' | safety_reason %in% c('migrated', 'died'))
  
  v3_100_refusal_dataset <- v3safety %>%
    group_by(hhid) %>%
    filter(all(extid %in% v3_refusals$extid),
           safety_status == 'refusal' | safety_reason %in% c('migrated', 'died')) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() %>%
    select(extid, hhid, visit, safety_status, safety_reason, assignment)
  num_extid_v3_100_refusal <- length(unique(v3_100_refusal_dataset$extid))
  num_hhid_v3_100_refusal <- length(unique(v3_100_refusal_dataset$hhid))
  
  v3_ref_ref <- v3_100_refusal_dataset %>%
    group_by(hhid) %>%
    filter(all(safety_status == 'refusal')) 
  num_extid_v3_ref_ref <- length(unique(v3_ref_ref$extid))
  num_hhid_v3_ref_ref <- length(unique(v3_ref_ref$hhid))
  
  v3_mig_died <- v3_100_refusal_dataset %>%
    group_by(hhid) %>%
    filter(all(safety_reason %in% c('migrated', 'died')))
  num_extid_v3_mig_died <- length(unique(v3_mig_died$extid))
  num_hhid_v3_mig_died <- length(unique(v3_mig_died$hhid))
  
  v3_ref_mig_died <- v3_100_refusal_dataset %>%
    filter(!(hhid %in% v3_ref_ref$hhid) & !(hhid %in% v3_mig_died$hhid)) 
  num_extid_v3_ref_mig_died <- length(unique(v3_ref_mig_died$extid))
  num_hhid_v3_ref_mig_died <- length(unique(v3_ref_mig_died$hhid))
  


# migrations 
v3_migrations <- v3safety %>%
  filter(safety_reason == 'migrated')
  num_extid_v3_migrations <- length(unique(v3_migrations$extid))
  num_hhid_v3_migrations <- length(unique(v3_migrations$hhid))

v3_migrated_hhs <- v3safety %>%
    group_by(hhid) %>%
    filter(all(extid %in% v3_migrations$extid),
           safety_reason %in% c('migrated'))
  num_hhid_v3_all_migrations <- length(unique(v3_migrated_hhs$hhid))
  
  v3_mig_hhs_not_100 <- v3_migrations %>%
    filter(!extid %in% v3_100_refusal_dataset$extid)
  num_extid_v3_mig_hhs_not_100 <- length(unique(v3_mig_hhs_not_100$extid))
  
  v3_mig_hhs_100 <- v3_migrations %>%
    filter(extid %in% v3_100_refusal_dataset$extid)
  num_extid_v3_mig_hhs_100 <- length(unique(v3_mig_hhs_100$extid))
  
  
  
# deaths
v3_death <- v3safety %>%
  filter(safety_reason == 'died')
  num_extid_v3_death <- length(unique(v3_death$extid))
  num_hhid_v3_death <- length(unique(v3_death$hhid))

v3_death_hhs <- v3safety %>%
    group_by(hhid) %>%
    filter(all(extid %in% v3_death$extid),
           safety_reason %in% c('died'))
  num_hhid_v3_all_death <- length(unique(v3_death_hhs$hhid))
  
  v3_died_hhs_not_100 <- v3_death %>%
    filter(!extid %in% v3_100_refusal_dataset$extid)
  num_extid_v3_died_hhs_not_100 <- length(unique(v3_died_hhs_not_100$extid))
  
  v3_died_hhs_100 <- v3_death %>%
    filter(extid %in% v3_100_refusal_dataset$extid)
  num_extid_v3_died_hhs_100 <- length(unique(v3_died_hhs_100$extid))
  
  
  
  # pregnancies
  v3_pregnancies <- v3safety %>%
    filter(pregnancy_status == 'in')
  
  v3_preg_pfu <- length(unique(v3_pregnancies$extid))

    
  
# create safety clean by removing deaths, migrations, and 100% refusal households
  v3_clean <- v3safety %>%
    filter(!extid %in% c(v3_100_refusal_dataset$extid, 
                         v3_death$extid, 
                         v3_migrations$extid))
  num_extid_v3_clean <- length(unique(v3_clean$extid))
  num_hhid_v3_clean <- length(unique(v3_clean$hhid))
    
    
# add the missing extids back in
    
v3_safety_with_missed <- v3_clean %>%
  bind_rows(v3_not_visited)
  num_extid_v3_safety_with_missed <- length(unique(v3_safety_with_missed$extid))
  num_hhid_v3_safety_with_missed <- length(unique(v3_safety_with_missed$hhid))
  
  
# hhs without at least one person in and with at least one person in
  v3_removals <- v3_safety_with_missed %>%
    group_by(hhid) %>%
    filter(!any(safety_status == 'in')) %>%
    ungroup()
  num_extid_v3_removals <- length(unique(v3_removals$extid))
  num_hhid_v3_removals <- length(unique(v3_removals$hhid))
  
  
  v3_kept <- v3_safety_with_missed %>%
    group_by(hhid) %>%
    filter(any(safety_status == 'in')) %>%
    ungroup()
  num_extid_v3_kept <- length(unique(v3_kept$extid))
  num_hhid_v3_kept <- length(unique(v3_kept$hhid))
  
  
# make a safety v3 target by removing eos, refusal, migrated and died
  v4_target <- v3_kept %>%
    filter(safety_status %in% c('in'),
           !safety_reason %in% c('migrated', 'died'))
  num_hhid_v4_target <- length(unique(v4_target$hhid))
  
  v4_target_real <- v3_kept
  num_hhid_v4_target_real <- length(unique(v4_target_real$hhid))
  num_extid_v4_target_real <- length(unique(v4_target_real$extid))
  
  
# make table of safety statuses
  v3safety_statuses <- v3safety %>%
    group_by(safety_status) %>%
    summarize(n = n()) %>%
    rename('V3 Visited' = n) %>%
    add_row(safety_status = 'total', 'V3 Visited' = sum(.$'V3 Visited'))
  
  v3safety_clean_statuses <- v3_clean %>%
    group_by(safety_status) %>%
    summarize(n = n()) %>%
    rename('V3 Clean' = n) %>%
    add_row(safety_status = 'total', 'V3 Clean' = sum(.$'V3 Clean'))
  
  v4safety_target_statuses <- v4_target %>%
    filter(safety_status %in% c('in', 'out'),
           !safety_reason %in% c('migrated', 'died')) %>%
    group_by(safety_status) %>%
    summarize(`V4 Target` = n()) %>%
    add_row(safety_status = 'eos', `V4 Target` = 0) %>%
    add_row(safety_status = 'out', `V4 Target` = 0) %>%
    add_row(safety_status = 'refusal', `V4 Target` = 0) %>%
    add_row(safety_status = 'total', `V4 Target` = sum(.$'V4 Target'))
  
  v4safety_target_calculated_statuses <- v4_target_real %>%
    group_by(safety_status) %>%
    summarize(`V4 Calculated Target` = n()) %>%
    add_row(safety_status = 'total', `V4 Calculated Target` = sum(.$'V4 Calculated Target'))
  
  v3statuses <- merge(v3safety_statuses, 
                      v3safety_clean_statuses,
                      by='safety_status')  %>%
    merge(v4safety_target_calculated_statuses, by = 'safety_status') %>%
    merge(v4safety_target_statuses, by='safety_status')

  # for in
  v3_in_target <- v4_target %>%
    filter(safety_status == 'in')
  num_v3_in_target <- length(unique(v3_in_target$extid))
  
  # for out
  v3_out <- v3safety %>%
    filter(safety_status == 'out')
  num_v3_out <- length(v3_out$extid)
  
  v3_out_mig <- v3_out %>%
    filter(safety_reason == c('migrated'))
  num_v3_out_mig <- length(unique(v3_out_mig$extid))
  
  v3_out_died <- v3_out %>%
    filter(safety_reason == c('died'))
  num_v3_out_died <- length(unique(v3_out_died$extid))
  
  v4_target_out_start <- v3_out %>%
    filter(!extid %in% c(v3_out_died$extid, v3_out_mig$extid, v3_not_visited$extid)) 
  num_v4_target_out_start <- length(unique(v4_target_out_start$extid))
  
  v4_target_out <- v4_target %>%
    filter(safety_status == 'out') 
  num_v4_target_out <- length(unique(v4_target_out$extid))
  
  
# for refusal
  
  v3_refusal <- v3safety %>%
    filter(safety_status == 'refusal')
  num_v3_refusal <- length(unique(v3_refusal$extid))
  
  v3_ref_removed <- v3_refusal %>%
    filter(extid %in% v3_100_refusal_dataset$extid)
  num_v3_ref_removed <- length(unique(v3_ref_removed$extid))
  
  
# eos
v3_eos <- v3safety %>%
  filter(safety_status == 'eos')
  num_extid_v3_eos <- length(unique(v3_eos$extid))
  num_hhid_v3_eos <- length(unique(v3_eos$hhid))
  
v3_eos_with_missed <- v3_safety_with_missed %>%
  filter(safety_status == 'eos') %>%
  anti_join(v3_eos, by='extid')
  num_extid_v3_eos_with <- length(unique(v3_eos_with_missed$extid))
  num_hhid_v3_eos_with <- length(unique(v3_eos_with_missed$hhid))
  
v3_eos_mig <- v3_eos %>%
  filter(safety_reason == 'migrated')
  num_extid_v3_eos_mig <- length(unique(v3_eos_mig$extid))
  
v3_eos_died <- v3_eos %>%
  filter(safety_reason == 'died')
  num_extid_v3_eos_died <- length(unique(v3_eos_died$extid))
  
v3_eos_rem <- v3_removals %>%
  filter(safety_status == 'eos',
         !safety_reason %in% c('died', 'migrated'))
  num_extid_v3_eos_rem <- length(unique(v3_eos_rem$extid))


  
  
# tracking safety statuses
  v3_status_pathway_data <- v3safety %>%
    mutate(pathway = case_when(
      starting_safety_status == 'out' & safety_status == 'out' ~ 'out to out',
      starting_safety_status == 'eos' & safety_status == 'eos' ~ 'previously eos',
      starting_safety_status == 'refusal' & safety_status == 'refusal' ~ 'previously refusal',
      starting_safety_status == 'out' & safety_status == 'refusal' ~ 'out to refusal',
      starting_safety_status == 'out' & safety_status == 'in' ~ 'out to in',
      starting_safety_status == 'out' & safety_status == 'out' ~ 'out to out',
      starting_safety_status == 'out' & safety_status == 'eos' ~ 'out to eos',
      starting_safety_status == 'in' & safety_status == 'eos' ~ 'in to eos',
      starting_safety_status == 'in' & safety_status == 'in' ~ 'in to in',
      starting_safety_status == 'in' & safety_status == 'completion' ~ 'in to completion',
      TRUE ~ 'other'
    ))
  
  v3_status_pathway <- v3_status_pathway_data %>%
    group_by(pathway) %>%
    summarize(count = n()) %>%
    add_row(pathway = 'total', count = sum(.$count))

```

```{r safety_trial_profile_v4}
##### V4
v4safety <- data %>%
  filter(visit == 'V4') %>%
  select(visit, extid, hhid, cluster, starting_safety_status, safety_status, safety_reason, assignment, type, took_drug, pregnancy_status)
num_extid_v4_total_visited <- length(unique(v4safety$extid))
num_hhid_v4_total_visited <- length(unique(v4safety$hhid))

v4safety_new <- v4safety %>%
  filter(type == 'new')
num_extid_v4_new_visited <- length(unique(v4safety_new$extid))
num_hhid_v4_new_visited <- length(unique(v4safety_new$hhid))

v4safety_og <- v4safety %>%
  filter(type == 'OG')
num_extid_v4_og_visited <- length(unique(v4safety_og$extid))
num_hhid_v4_og_visited <- length(unique(v4safety_og$hhid))


# missed V4
v4_not_visited <- anti_join(v3_clean, v4safety, by='extid') %>% 
    select(cluster, extid, hhid) %>%
    mutate(visit = 'V4',
           safety_status = 'out',
           safety_reason = 'missed V4',
           starting_safety_status = 'out')

num_extid_v4_not_visited <- length(unique(v4_not_visited$extid))
num_hhid_v4_not_visited <- length(unique(v4_not_visited$hhid))

v4_hhid_visited_extid_not <- semi_join(v4_not_visited, v4safety, by='hhid')
    num_v4_hhid_visited_extid_not <- length(unique(v4_hhid_visited_extid_not$hhid))
  
  
  # pregnancies
  v4_pregnancies <- v4safety %>%
    filter(pregnancy_status == 'in',
           !extid %in% v3_pregnancies$extid,
           safety_reason != 'previously eos')
  
  v4_preg_pfu <- length(unique(v4_pregnancies$extid))
  
  
  
# make table of safety statuses
  v4statuses <- v4safety %>%
    group_by(safety_status) %>%
    summarize(n = n()) %>%
    rename('V4 Visited' = n) %>%
    add_row(safety_status = 'total', 'V4 Visited' = sum(.$'V4 Visited'))

  # for out
  v4_out <- v4safety %>%
    filter(safety_status == 'out')
  num_v4_out <- length(v4_out$extid)
  
  v4_out_mig <- v4_out %>%
    filter(safety_reason == c('migrated'))
  num_v4_out_mig <- length(unique(v4_out_mig$extid))
  
  v4_out_died <- v4_out %>%
    filter(safety_reason == c('died'))
  num_v4_out_died <- length(unique(v4_out_died$extid))
  
  
  # for refusal
  
  v4_refusal <- v4safety %>%
    filter(safety_status == 'refusal')
  num_v4_refusal <- length(unique(v4_refusal$extid))

  
# tracking safety statuses
  v4_status_pathway_data <- v4safety %>%
    mutate(pathway = case_when(
      starting_safety_status == 'out' & safety_status == 'out' ~ 'out to out',
      starting_safety_status == 'eos' & safety_status == 'eos' ~ 'previously eos',
      starting_safety_status == 'refusal' & safety_status == 'refusal' ~ 'previously refusal',
      starting_safety_status == 'out' & safety_status == 'refusal' ~ 'out to refusal',
      starting_safety_status == 'out' & safety_status == 'in' ~ 'out to in',
      starting_safety_status == 'out' & safety_status == 'out' ~ 'out to out',
      starting_safety_status == 'out' & safety_status == 'eos' ~ 'out to eos',
      starting_safety_status == 'in' & safety_status == 'eos' ~ 'in to eos',
      starting_safety_status == 'in' & safety_status == 'in' ~ 'in to in',
      starting_safety_status == 'in' & safety_status == 'completion' ~ 'in to completion',
      TRUE ~ 'other'
    ))
  
  v4_status_pathway <- v4_status_pathway_data %>%
    group_by(pathway) %>%
    summarize(count = n()) %>%
    add_row(pathway = 'total', count = sum(.$count))

```

```{r safety_trial_overall}

status_pathway <- v1_status_pathway_data %>%
  select(extid, pathway) %>%
  rename(path_v1 = pathway) %>%
  merge(v2_status_pathway_data, by='extid') %>%
  select(extid, path_v1, pathway) %>%
  rename(path_v2 = pathway) %>%
  merge(v3_status_pathway_data, by='extid') %>%
  select(extid, path_v1, path_v2, pathway) %>%
  rename(path_v3 = pathway) %>%
  merge(v4_status_pathway_data, by='extid') %>%
  select(extid, path_v1, path_v2, path_v3, pathway) %>%
  rename(path_v4 = pathway) %>%
  filter(rowSums(select(., starts_with("path")) == "out to in") >= 2 |
         rowSums(select(., starts_with("path")) == "out to refusal") >= 2 |
         rowSums(select(., starts_with("path")) == "out to eos") >= 2 |
         rowSums(select(., starts_with("path")) == "in to eos") >= 2 |
         rowSums(select(., starts_with("path")) == "in to completion") >= 2)
#write.csv(status_pathway, file='V1.0 repeat status pathways.csv')


```


```{r enrolled}
# create a dataset of enrolled participants (people who became safety status in)
  enrolled <- data %>%
    filter(enrolment == 'enrolment',
           safety_status == 'in')

  amount_enrolled <- length(unique(enrolled$extid))
  
  enrolled_data <- data %>%
    filter(extid %in% enrolled$extid) %>%
    arrange(desc(visit)) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() 
  
  enrolled_table <- enrolled_data %>%
    arrange(visit) %>%
    group_by(safety_status, assignment) %>%
    summarise('N' = n()) %>%
    group_by(safety_status) %>%
    pivot_wider(names_from = assignment, values_from = N) %>%
    ungroup() %>%
    arrange(safety_status) %>%
    rename('ENROLLED status' = safety_status) %>%
    add_row('ENROLLED status' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

  # enrolled eos
  enrol_eos <- by_visit %>%
    filter(extid %in% enrolled$extid,
           status_V2 == 'eos' |
             status_V3 == 'eos' |
             status_V4 == 'eos')
  
  enrol_eos_data <- data %>%
    filter(extid %in% enrol_eos$extid,
           safety_status == 'eos') %>%
    arrange(visit) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() 
  
  enrol_eos_table <- enrol_eos_data %>%
    arrange(visit) %>%
    group_by(safety_reason, assignment) %>%
    summarise('N' = n()) %>%
    group_by(safety_reason) %>%
    pivot_wider(names_from = assignment, values_from = N) %>%
    ungroup() %>%
    arrange(safety_reason) %>%
    rename('EOS reason' = safety_reason) %>%
    add_row('EOS reason' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

  
  # enrolled completion
  enrol_comp <- by_visit %>%
    filter(extid %in% enrolled$extid,
           status_V4 == 'completion')
  
  enrol_comp_table <- data %>%
    filter(extid %in% enrol_comp$extid,
           safety_status == 'completion') %>%
    arrange(visit) %>%
    group_by(safety_status, assignment) %>%
    summarise('N' = n()) %>%
    group_by(safety_status) %>%
    pivot_wider(names_from = assignment, values_from = N, values_fill = 0) %>%
    ungroup() %>%
    rename('Enrolled reason' = safety_status) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')
  
  v4_pregnant_women <- data_investigation %>%
    filter(visit == 'V4',
           safety_reason == 'pregnant')
  v4_pregnant_women_stat <- length(unique(v4_pregnant_women$extid))

```
```{r not_enrolled}

# not enrolled participants
  
  not_enrolled <- by_visit %>%
    filter(!(extid %in% enrolled$extid),
           !(is.na(assignment))) # this removes the 1795 extids that were dropped due to dropping of clusters

  amount_not_enrolled <- length(unique(not_enrolled$extid))
  
  not_enrolled_data <- data %>%
    filter(extid %in% not_enrolled$extid) %>%
    arrange(desc(visit)) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() 
  
  not_enrolled_table <- not_enrolled_data %>%
    arrange(visit) %>%
    group_by(safety_status, assignment) %>%
    summarise('N' = n()) %>%
    group_by(safety_status) %>%
    pivot_wider(names_from = assignment, values_from = N) %>%
    ungroup() %>%
    arrange(safety_status) %>%
    rename('NOT ENROLLED status' = safety_status) %>%
    add_row('NOT ENROLLED status' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

# EOS

  not_enrol_eos <- by_visit %>%
    filter(extid %in% not_enrolled$extid,
           status_V2 == 'eos' |
             status_V3 == 'eos' |
             status_V4 == 'eos')
  
  not_enrol_eos_data <- data %>%
    filter(extid %in% not_enrol_eos$extid,
           safety_status == 'eos') %>%
    arrange(visit) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() 
  
  not_enrol_eos_table <- not_enrol_eos_data %>%
    arrange(visit) %>%
    group_by(safety_reason, assignment) %>%
    summarise('N' = n()) %>%
    group_by(safety_reason) %>%
    pivot_wider(names_from = assignment, values_from = N, values_fill = 0) %>%
    ungroup() %>%
    arrange(safety_reason) %>%
    rename('EOS reason' = safety_reason) %>%
    add_row('EOS reason' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

# OUT
  
  not_enrol_out <- by_visit %>%
    filter(extid %in% not_enrolled$extid,
           (status_V1 == 'out' |
              is.na(status_V1)) &
             (status_V2 == 'out' |
                is.na(status_V2)) &
             (status_V3 == 'out' |
                is.na(status_V3)) &
             (status_V4 == 'out' | 
                is.na(status_V4)))
  
  not_enrol_out_data <- data %>%
    filter(extid %in% not_enrol_out$extid,
           safety_status == 'out') %>%
    arrange(visit) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() 
  
  not_enrol_out_table <- not_enrol_out_data %>%
    arrange(visit) %>%
    group_by(safety_reason, assignment) %>%
    summarise('N' = n()) %>%
    group_by(safety_reason) %>%
    pivot_wider(names_from = assignment, values_from = N, values_fill = 0) %>%
    ungroup() %>%
    arrange(safety_reason) %>%
    rename('OUT reason' = safety_reason) %>%
    add_row('OUT reason' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

# REFUSAL
  
  not_enrol_ref <- data %>%
    filter(extid %in% not_enrolled$extid,
           safety_status == 'refusal')
  
  not_enrol_ref_data <- data %>%
    filter(extid %in% not_enrol_ref$extid,
           safety_status == 'refusal') %>%
    arrange(visit) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup() 
  
  not_enrol_ref_table <- not_enrol_ref_data %>%
    arrange(visit) %>%
    group_by(safety_reason, assignment) %>%
    summarise('N' = n()) %>%
    group_by(safety_reason) %>%
    pivot_wider(names_from = assignment, values_from = N, values_fill = 0) %>%
    ungroup() %>%
    arrange(safety_reason) %>%
    rename('REFUSAL reason' = safety_reason) %>%
    add_row('REFUSAL reason' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

```

```{r not_and_enrolled}
trial_profile <- data %>%
  mutate(enrolled = case_when(
    extid %in% enrolled$extid ~ 'enrolled',
    extid %in% not_enrolled$extid ~ 'not enrolled'
  )) %>%
  select(extid, visit, enrolled, assignment) %>%
  filter(!(is.na(assignment))) %>%
    arrange(visit) %>%
    group_by(extid) %>%
    slice(1) %>%
    ungroup()

total_trial_table <- trial_profile %>%
    arrange(visit) %>%
    group_by(enrolled, assignment) %>%
    summarise('N' = n()) %>%
    group_by(enrolled) %>%
    pivot_wider(names_from = assignment, values_from = N, values_fill = 0) %>%
    ungroup() %>%
    arrange(enrolled) %>%
    rename('enrolment status' = enrolled) %>%
    add_row('enrolment status' = 'total visited', 
            '1' = sum(.$'1'),
            '2' = sum(.$'2')) %>%
    mutate(Total = `1` + `2`) %>%
    rename('Assignment 1' = '1',
           'Assignment 2' = '2')

```

```{r targets}
# these numbers are determined by Aryton based on Joe's logic and are stored in AWS
  target_table <- safety_targets %>%
    group_by(visit) %>%
    summarise(hh_target = sum(hh_target),
              ind_target = sum(ind_target))

# identify how many households were visited in V1 and V2
visited <- total_safety %>%
  group_by(visit) %>%
  summarise(hh_visited = n_distinct(hhid),
            ind_visited = n_distinct(extid))

# join the number of households visited and targets
target_table <- left_join(target_table, visited, by = c('visit'))

target_table <- target_table %>%
  select(visit, ind_target, ind_visited, hh_target, hh_visited) %>%
  rename(Visit = visit,
         'Individual target' = ind_target,
         'Individual visited' = ind_visited,
         'HH target' = hh_target,
         'HH visited' = hh_visited)
```

```{r totals}
## this will create the table of how many people are in, out, refusal, or eos
## it is broken up into each visit number

  # make the safetynew_status and safety_status into one column and the sexes
  total_safety <- data %>%
    filter(safetystatus != 'UNDEFINED') # we find an UNDEFINED from someone most likely submitting a form without filling it out so we will remove NA from extid 


### V1 ################

# create a summary table of safety_status counts for V1
  total_safety_v1 <- total_safety %>%
    filter(visit == 'V1')

  total_safety_status_v1 <- total_safety_v1 %>%
    select(extid, safetystatus, cluster, sex, todays_date, visit) %>%
    group_by(safetystatus) %>%
    summarise('Number of people visited in V1' = n()) %>%
    arrange(safetystatus) %>%
    rename('Safety status' = safetystatus) %>%
    add_row('Safety status' = 'total people visited', 
            'Number of people visited in V1' = 
              sum(.$'Number of people visited in V1')) %>%
    mutate('Percent complete' = 
             (as.numeric(`Number of people visited in V1`)) / 
             as.numeric(nrow(total_safety_v1)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%'))


## V2 #################
  total_safety_v2 <- total_safety %>%
    filter(visit == 'V2')
  
  total_safety_status_v2 <- total_safety %>%
    filter(visit == 'V2') %>%
    select(extid, safetystatus, cluster, sex, todays_date, visit) %>%
    group_by(safetystatus) %>%
    summarise('Number of people visited in V2' = n()) %>%
    arrange(safetystatus) %>%
    rename('Safety status' = safetystatus) %>%
    add_row('Safety status' = 'total people visited', 
            'Number of people visited in V2' = 
              sum(.$'Number of people visited in V2')) %>%
    mutate('Percent complete' = 
             (as.numeric(`Number of people visited in V2`)) / 
             as.numeric(nrow(total_safety_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%'))


## V3 ####################

  total_safety_v3 <- total_safety %>%
    filter(visit == 'V3')
  
  total_safety_status_v3 <- total_safety %>%
    filter(visit == 'V3') %>%
    select(extid, safetystatus, cluster, sex, todays_date, visit) %>%
    group_by(safetystatus) %>%
    summarise('Number of people visited in V3' = n()) %>%
    arrange(safetystatus) %>%
    rename('Safety status' = safetystatus) %>%
    add_row('Safety status' = 'total people visited', 
            'Number of people visited in V3' = 
              sum(.$'Number of people visited in V3')) %>%
    mutate('Percent complete' = 
             (as.numeric(`Number of people visited in V3`)) / 
             as.numeric(nrow(total_safety_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%'))


## V4 #####################

  total_safety_v4 <- total_safety %>%
    filter(visit == 'V4')
  
  total_safety_status_v4 <- total_safety %>%
    filter(visit == 'V4') %>%
    select(extid, safetystatus, cluster, sex, todays_date, visit) %>%
    group_by(safetystatus) %>%
    summarise('Number of people visited in V4' = n()) %>%
    arrange(safetystatus) %>%
    rename('Safety status' = safetystatus) %>%
    add_row('Safety status' = 'total people visited', 
            'Number of people visited in V4' = 
              sum(.$'Number of people visited in V4')) %>%
    mutate('Percent complete' = 
             (as.numeric(`Number of people visited in V4`)) / 
             as.numeric(nrow(total_safety_v4)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%'))
```

```{r pregnant}
  safety_pregnant_v4 <- data %>%
  filter(safety_reason == 'pregnant',
         visit == 'V4')

  safety_completion_v4 <- data %>%
    filter(safety_status == 'completion',
           visit == 'V4')

  pregnant_completion_v4 <- safety_pregnant_v4 %>%
    group_by(safety_reason) %>%
    summarise('Number of pregnant' = n()) %>%
    rename('Outcome in Safety' = safety_reason) %>%
    mutate('Percent of completion people' = 
             (as.numeric(`Number of pregnant`)) / 
             as.numeric(nrow(safety_completion_v4)) * 100) %>%
    mutate('Percent of completion people' = 
             round(`Percent of completion people`, 2)) %>%
    mutate('Percent of completion people' = 
             paste0(`Percent of completion people`, '%')) # Replace zero values with NA
```

```{r in}
## create a table of how many people are in as enrolment and in as follow up
# every visit is enrolment in V1 so not applicable, start at V2

## V1 checked to ensure code works

## V2 ##############
  
  safety_v2_in <- total_safety %>%
    filter(safety_status == 'in',
           visit == 'V2')

  in_type_v2 <- safety_v2_in %>%
    filter(safety_status == 'in') %>%
    group_by(enrolment) %>%
    summarise('Number of in people' = n()) %>%
    arrange(enrolment) %>%
    rename('Visit type' = enrolment) %>%
    add_row('Visit type' = 'total in', 'Number of in people' = sum(.$'Number of in people')) %>%
    mutate('Percent' = (as.numeric(`Number of in people`)) / as.numeric(nrow(safety_v2_in)) * 100) %>%
    mutate('Percent' = round(`Percent`, 2)) %>%
    mutate('Percent' = paste0(`Percent`, '%')) # Replace zero values with NA
  
## V3 ########################
  
  safety_v3_in <- total_safety %>%
    filter(visit == 'V3',
           safety_status == 'in')
  
  in_type_v3 <- safety_v3_in %>%
    group_by(enrolment) %>%
    summarise('Number of in people' = n()) %>%
    arrange(enrolment) %>%
    rename('Visit type' = enrolment) %>%
    add_row('Visit type' = 'total in', 'Number of in people' = sum(.$'Number of in people')) %>%
    mutate('Percent' = (as.numeric(`Number of in people`)) / as.numeric(nrow(safety_v3_in)) * 100) %>%
    mutate('Percent' = round(`Percent`, 2)) %>%
    mutate('Percent' = paste0(`Percent`, '%')) # Replace zero values with NA

  
## V4 ################

# do not need in for V4 because a person starts as 'in' in V4 but only becomes 'eos' or 'completion'

```

```{r eos}

## V1 ###########################
  
  safety_eos_v1 <- data %>%
    filter(visit == 'V1',
           safetystatus == 'eos')
  
  # make a table of why people are eos
  eos_reasons_v1 <- safety_eos_v1 %>%
    group_by(safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for eos' = safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 
            'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / 
             as.numeric(nrow(safety_eos_v1)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
## V2 ############################
  
  safety_eos_v2 <- total_safety %>%
    filter(visit == 'V2',
           safety_status == 'eos') # remove people who were eos in V1
  
  total_safe_eos_enrolment_v2 <- safety_eos_v2 %>%
    filter(enrolment == 'enrolment')
  total_safe_eos_followup_v2 <- safety_eos_v2 %>%
    filter(enrolment == 'follow up')

  eos_reasons_v2 <- safety_eos_v2 %>%
    group_by(enrolment) %>%
    summarise('Number of eos people' = n()) %>%
    rename('Reason for eos' = enrolment) %>%
    add_row('Reason for eos' = 'total visited', 
            'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent of eos' = (as.numeric(`Number of eos people`)) / 
             as.numeric(nrow(safety_eos_v2)) * 100) %>%
    mutate('Percent of eos' = round(`Percent of eos`, 2)) %>%
    mutate('Percent of eos' = paste0(`Percent of eos`, '%')) # Replace zero values with NA

# make a table of enrolment people who are eos
  eos_reasons_enrolment_v2 <- total_safe_eos_enrolment_v2 %>%
    group_by(safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for eos' = safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 
            'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / 
             as.numeric(nrow(total_safe_eos_enrolment_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

# make a table of reasons follow up people are eos #
  eos_reasons_followup_v2 <- total_safe_eos_followup_v2 %>%
    group_by(safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for eos' = safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 
            'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / 
             as.numeric(nrow(total_safe_eos_followup_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

## V3 ############################
  
  safety_eos_v3 <- total_safety %>%
    filter(visit == 'V3',
           safety_status == 'eos') # remove people who were eos in V1
  
  total_safe_eos_enrolment_v3 <- safety_eos_v3 %>%
    filter(enrolment == 'enrolment')
  total_safe_eos_followup_v3 <- safety_eos_v3 %>%
    filter(enrolment == 'follow up')

  eos_reasons_v3 <- safety_eos_v3 %>%
    group_by(enrolment) %>%
    summarise('Number of eos people' = n()) %>%
    rename('Reason for eos' = enrolment) %>%
    add_row('Reason for eos' = 'total visited', 
            'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent of eos' = (as.numeric(`Number of eos people`)) / 
             as.numeric(nrow(safety_eos_v3)) * 100) %>%
    mutate('Percent of eos' = round(`Percent of eos`, 2)) %>%
    mutate('Percent of eos' = paste0(`Percent of eos`, '%')) # Replace zero values with NA

# make a table of enrolment people who are eos
  eos_reasons_enrolment_v3 <- total_safe_eos_enrolment_v3 %>%
    group_by(safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for eos' = safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 
            'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / 
             as.numeric(nrow(total_safe_eos_enrolment_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA


# make a table of reasons follow up people are eos #
  eos_reasons_followup_v3 <- total_safe_eos_followup_v3 %>%
    group_by(safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for eos' = safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 
            'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / 
             as.numeric(nrow(total_safe_eos_followup_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

  
## V4 ############################
  
  safety_eos_v4 <- total_safety %>%
    filter(visit == 'V4',
           safety_status == 'eos')# remove people who were eos in V1
  
  total_safe_eos_followup_v4 <- safety_eos_v4 %>%
    filter(enrolment == 'follow up')

  eos_reasons_v4 <- safety_eos_v4 %>%
    group_by(safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    rename('Reason for eos' = safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 
            'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent of eos' = (as.numeric(`Number of eos people`)) / 
             as.numeric(nrow(safety_eos_v4)) * 100) %>%
    mutate('Percent of eos' = round(`Percent of eos`, 2)) %>%
    mutate('Percent of eos' = paste0(`Percent of eos`, '%')) # Replace zero values with NA

# make a table of reasons follow up people are eos #
  eos_reasons_followup_v4 <- total_safe_eos_followup_v4 %>%
    group_by(safety_reason) %>%
    summarise('Number of eos people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for eos' = safety_reason) %>%
    add_row('Reason for eos' = 'total visited', 
            'Number of eos people' = sum(.$'Number of eos people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of eos people`)) / 
             as.numeric(nrow(total_safe_eos_followup_v4)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
```

```{r out}

## V1 #####################

  safety_out_v1 <- data %>%
    filter(visit == 'V1',
           safetystatus == 'out')
  
  # make a table of why people are out
  out_reasons_v1 <- safety_out_v1 %>%
    group_by(safety_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for out' = safety_reason) %>%
    add_row('Reason for out' = 'total visited', 
            'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / 
             as.numeric(nrow(safety_out_v1)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
## V2 #####################

  safety_out_v2 <- data %>%
    filter(visit == 'V2',
           safetystatus == 'out')
  
  # make a table of why people are out
  out_reasons_v2 <- safety_out_v2 %>%
    group_by(safety_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for out' = safety_reason) %>%
    add_row('Reason for out' = 'total visited', 
            'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / 
             as.numeric(nrow(safety_out_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
## V3 #####################

  safety_out_v3 <- data %>%
    filter(visit == 'V3',
           safetystatus == 'out')
  
  # make a table of why people are out
  out_reasons_v3 <- safety_out_v3 %>%
    group_by(safety_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for out' = safety_reason) %>%
    add_row('Reason for out' = 'total visited', 
            'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / 
             as.numeric(nrow(safety_out_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V4 #####################
  
    safety_out_v4 <- data %>%
    filter(visit == 'V4',
           safetystatus == 'out')
  
  # make a table of why people are out
  out_reasons_v4 <- safety_out_v4 %>%
    group_by(safety_reason) %>%
    summarise('Number of out people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for out' = safety_reason) %>%
    add_row('Reason for out' = 'total visited', 
            'Number of out people' = sum(.$'Number of out people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of out people`)) / 
             as.numeric(nrow(safety_out_v4)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
```

```{r refusal}
## this will create a table of how many people are refusal and why they are refusal

## V1 #####################

  safety_refusal_v1 <- data %>%
    filter(visit == 'V1',
           safetystatus == 'refusal')
  
  # make a table of why people are refusal
  refusal_reasons_v1 <- safety_refusal_v1 %>%
    group_by(safety_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for refusal' = safety_reason) %>%
    add_row('Reason for refusal' = 'total visited', 
            'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / 
             as.numeric(nrow(safety_refusal_v1)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

## V2 #####################

  safety_refusal_v2 <- data %>%
    filter(visit == 'V2',
           safetystatus == 'refusal')
  
  # make a table of why people are refusal
  refusal_reasons_v2 <- safety_refusal_v2 %>%
    group_by(safety_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for refusal' = safety_reason) %>%
    add_row('Reason for refusal' = 'total visited', 
            'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / 
             as.numeric(nrow(safety_refusal_v2)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
## V3 #####################

  safety_refusal_v3 <- data %>%
    filter(visit == 'V3',
           safetystatus == 'refusal')
  
  # make a table of why people are refusal
  refusal_reasons_v3 <- safety_refusal_v3 %>%
    group_by(safety_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for refusal' = safety_reason) %>%
    add_row('Reason for refusal' = 'total visited', 
            'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / 
             as.numeric(nrow(safety_refusal_v3)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA
  
  
## V4 #####################

  # people cannot become refusal in V4 only eos or completion
  # but we will show previous refusals
  
    safety_refusal_v4 <- data %>%
    filter(visit == 'V4',
           safetystatus == 'refusal')
  
  # make a table of why people are refusal
  refusal_reasons_v4 <- safety_refusal_v4 %>%
    group_by(safety_reason) %>%
    summarise('Number of refusal people' = n()) %>%
    arrange(safety_reason) %>%
    rename('Reason for refusal' = safety_reason) %>%
    add_row('Reason for refusal' = 'total visited', 
            'Number of refusal people' = sum(.$'Number of refusal people')) %>%
    mutate('Percent complete' = (as.numeric(`Number of refusal people`)) / 
             as.numeric(nrow(safety_refusal_v4)) * 100) %>%
    mutate('Percent complete' = round(`Percent complete`, 2)) %>%
    mutate('Percent complete' = paste0(`Percent complete`, '%')) # Replace zero values with NA

```

```{r flowchart_assignment_1}

# calculate households visited per arm
hhid_visited_1 <- data %>%
  filter(!is.na(visit), 
         assignment == 1) %>%
  summarise(hh_visited_1 = n_distinct(hhid)) %>%
  pull(hh_visited_1)

# calculate subjects visited per arm
extid_visited_1 <- data %>%
  filter(!is.na(visit), 
         assignment == 1) %>%
  summarise(ext_visited_1 = n_distinct(extid)) %>%
  pull(ext_visited_1)

# calculate non-enrolled subjects
non_enrolled_1 <- not_enrolled %>%
  filter(assignment == 1) %>%
  summarise(ext_not_enrolled_1 = n_distinct(extid)) %>%
  pull(ext_not_enrolled_1)


# Initiate the boxes that we want to connect
first_title <- hhid_visited_1
first <- boxGrob(paste(first_title, 'households visited in arm 1 clusters'),
                 x = .1, y = .9)

second_title <- extid_visited_1
second <- boxGrob(paste(second_title, 'visited subjects in arm 1 clusters'),
                  x = .1, y = .5)

third_title <- non_enrolled_1
third <- boxGrob(paste(third_title, 'non-enrolled subjects'),
               x = .5, y = .5)

third_side_title <- 'insert'
third_side <- boxGrob(third_title,
               x = .1, y = 0,
               bjust = c("left", "bottom"))


# initiate plotting
grid.newpage()


# Connect the boxes and print/plot them
connectGrob(first, second, 'vertical')
connectGrob(second, third, 'horizontal')

# print the grobs
first
second
third
```

```{r flowchart_assignment_2}
# calculate hhs visited per arm
hhid_visited_2 <- data %>%
  filter(visit != 'NA',
         assignment == 2) %>%
  summarise(hh_visited_2 = n_distinct(hhid)) %>%
  pull(hh_visited_2)

# calculate subjects visited per arm
extid_visited_2 <- data %>%
  filter(visit != 'NA',
         assignment == 2) %>%
  summarise(ext_visited_2 = n_distinct(extid)) %>%
  pull(ext_visited_2)

# calculate non-enrolled subjects
non_enrolled_2 <- not_enrolled %>%
  filter(assignment == 2) %>%
  summarise(ext_not_enrolled_2 = n_distinct(extid)) %>%
  pull(ext_not_enrolled_2)
```


## Safety Trial Profile  

This is the safety trial profile which breaks down the people visited from beginning to end. It starts at Demography and ends at V4. The aim is to track every person and household and to understand why they are present or not at each stage and to understand where they go. Because safety was collected at a household and individual level, each safety visit will have a household and individual component.

***

### Demography

Demography started by visiting `r num_hhid_v0_total_visited` households (`r num_extid_v0_total_visited` people). However, `r num_v0_removed_hhid` households (`r num_v0_removed_extid` people) were removed at the study's discretion (due to the dropping of clusters). Therefore, the target for V1 is `r num_hhid_v0_clean` households (`r num_extid_v0_clean` people).  

* Household level: `r num_hhid_v0_total_visited` visited households - `r num_v0_removed_hhid` removed households = `r num_hhid_v0_total_visited - num_v0_removed_hhid` target households
* Individual level: `r num_extid_v0_total_visited` visited individuals - `r num_v0_removed_extid` removed individuals = `r num_extid_v0_total_visited - num_v0_removed_extid` target individuals
  
***

### Safety V1

#### Household Level
While the target number of households to visit in Safety V1 was `r num_hhid_v0_clean`, only `r num_hhid_v1_total_visited` households were visited. This means:

* `r num_hhid_v0_clean` target hhs - `r num_hhid_v1_total_visited` visited hhs = `r num_hhid_v0_clean - num_hhid_v1_total_visited` missed hhs

When we dive deeper to confirm that `r num_hhid_v0_clean - num_hhid_v1_total_visited` households were missed, we find that `r num_hhid_v1_not_visited - num_v1_hhid_visited_extid_not` households were indeed not visited in V1.  

> _NOTE: `r num_v1_hhid_visited_extid_not` households were visited but only had Safety New members enrolled. The other members of the household had no data submitted for that visit._

Now that we have determined why the target hh and visited hh numbers differ, we will begin to find the V2 target number. To create the V2 target, we must remove the hh below:

* `r num_hhid_v1_ref_ref` households had all individuals refuse,  
* `r num_hhid_v1_all_migrations` households had all individuals migrate,  
* `r num_hhid_v1_all_death` households had all individuals die, and   
* `r num_hhid_v1_ref_mig_died` households had all individuals refuse, migrate, or die.
* Total of above = `r num_hhid_v1_ref_ref + num_hhid_v1_all_migrations + num_hhid_v1_all_death + num_hhid_v1_ref_mig_died`  

This means that `r num_hhid_v1_ref_ref + num_hhid_v1_all_migrations + num_hhid_v1_all_death + num_hhid_v1_ref_mig_died` households were removed.

The V1 Clean data will then have the following households:

* `r num_hhid_v1_total_visited` visited - `r num_hhid_v1_100_refusal` = `r num_hhid_v1_total_visited - num_hhid_v1_100_refusal` V1 Clean

Finally, to create the V2 target we want to keep all people who we visited that are not a part of the households removed and we need to include the households who were missed in V1:

* `r num_hhid_v1_total_visited` visited + `r num_hhid_v1_not_visited - num_v1_hhid_visited_extid_not` not visited - `r num_hhid_v1_100_refusal` = `r num_hhid_v1_total_visited + (num_hhid_v1_not_visited - num_v1_hhid_visited_extid_not) - num_hhid_v1_100_refusal` V2 target

So now there is a V2 target of `r num_hhid_v2_target_real` households.

#### Individual Level
At the individual level, people who were registered in Demography go through the Safety form or they can be added to a household in Safety V1, V2, or V3 through the Safety New Members Form. For the purposes of this document we will refer to safety new member people as __type new__ and people who joined a household in Demography as type __OG__.   
> _Note: OG is slang for original._

Safety V1 visited people who were also visited in Demography (type OG) but also visits new people (type new). In total `r num_extid_v1_total_visited` people were visited in Safety V1 of which `r num_extid_v1_new_visited` were new and `r num_extid_v1_og_visited` were OG. 

In the target for V1, new people were not accounted for, only the OG people. So when we compare the V1 target and V1 OG visited we find that `r num_extid_v1_not_visited` people were not visited:  

* `r num_extid_v0_clean` (target) - `r num_extid_v1_og_visited` (OG visited) = `r num_extid_v0_clean - num_extid_v1_og_visited` (missed people)
* These individuals are coming from the `r length(unique(v1_not_visited$hhid)) - length(unique(v1_hhid_visited_extid_not$hhid))` missed households + `r length(unique(v1_hhid_visited_extid_not$hhid))` households which had no Safety submissions (just Safety New Members).

Now that we understand why the target is different, let's clean V1 by removing all migrations, deaths, and 100% refusal households. __A 100% refusal rate household is defined as a household that is completely made up of individuals who refused, or a combination of refused and migrated and/or dead__: 

* `r num_extid_v1_mig_hhs_not_100` migrations (which are not a part of 100% refusal households),    
* `r num_extid_v1_died_hhs_not_100` deaths (which are not a part of 100% refusal households), and    
* `r num_extid_v1_100_refusal` people belonging to 100% refusal households.
  + `r num_extid_v1_mig_hhs_100` people migrated, and
  + `r num_v1_ref_removed` people refused.
  + Total: `r num_extid_v1_mig_hhs_100` + `r num_v1_ref_removed` = `r num_extid_v1_mig_hhs_100 + num_v1_ref_removed` people
* Total of: `r num_extid_v1_mig_hhs_not_100` migrations + `r num_extid_v1_died_hhs_not_100` deaths + `r num_extid_v1_100_refusal` 100% refusals = `r num_extid_v1_mig_hhs_not_100 + num_extid_v1_died_hhs_not_100 + num_extid_v1_100_refusal` people   

Now when we remove migrations, deaths, and people in 100% refusal households, we get a V1 Clean of `r num_extid_v1_clean`.  

* `r num_extid_v1_total_visited` visited - `r num_extid_v1_mig_hhs_not_100 + num_extid_v1_died_hhs_not_100 + num_extid_v1_100_refusal` removed = `r num_extid_v1_total_visited - (num_extid_v1_mig_hhs_not_100 + num_extid_v1_died_hhs_not_100 + num_extid_v1_100_refusal)` V1 Clean

Now that the data has been cleaned, we will calculate the V2 Target number by adding the people missed in V1 to the V1 Clean. The V2 Target will reflect the number of people who can be visited in the next visit (out and in people).

* `r num_v1_in_target` in + `r num_v2_target_out` out = `r num_v1_in_target + num_v2_target_out` V2 Target

However, for calculation purposes there will be a V2 Calculated Target which will include all people on the roster (in, out, refusals, and eos people who did not migrate, died or are part of a 100% refusal household):   

* `r num_extid_v2_target_real` V2 Calculated Target

To double check everything that has been done, the V1 visited people's safety statuses are compared to V1 Clean and V2 Target below: 

```{r v1_safety_statuses}
knitr::kable(v1statuses)
```

* OUT: `r num_v1_out` V1 Visited out - `r num_v1_out_died` died - `r num_v1_out_mig` migrated =  `r num_v1_out - num_v1_out_died - num_v1_out_mig` V1 Clean out + `r num_extid_v1_not_visited` missed people = `r num_v2_target_out_start + num_extid_v1_not_visited` OUT (participants who can still enter the study)
* REFUSAL: `r num_v1_refusal` - `r num_v1_ref_removed` people in 100% removal households = `r num_v1_refusal - num_v1_ref_removed` REFUSAL (participants who refused but belong to hh that are still part of the study)

Finally, all people should follow the pathways below:

```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri('../../asset/safety_pathway_screenshot.jpg'), 
               alt = 'logo', 
               style = 'padding:10px; width:550px; height:200px')
```

We can check this in the following table:

```{r v1_safety_pathway}
knitr::kable(v1_status_pathway)
```

***

### Safety V2

#### Household Level
While the target number of households to visit in Safety V2 was `r num_hhid_v2_target_real`, only `r num_hhid_v2_total_visited` households were visited. This means:

* `r num_hhid_v2_target_real` target hhs - `r num_hhid_v2_total_visited` visited hhs = `r num_hhid_v2_target_real - num_hhid_v2_total_visited` missed 

When we dive deeper to confirm that `r num_hhid_v2_target_real - num_hhid_v2_total_visited` household was missed, we find that `r num_hhid_v2_not_visited - num_v2_hhid_visited_extid_not` household was indeed not visited in V2.  

> _NOTE: `r num_v2_hhid_visited_extid_not` households were visited but only had Safety New members enrolled. The other members of the household had no data submitted for that visit._

Now that we have determined why the target hh and visited hh numbers differ, we will begin to find the V2 target number. To create the V2 target, we must remove the hh below:

* `r num_hhid_v2_ref_ref` households had all individuals refuse,  
* `r num_hhid_v2_all_migrations` households had all individuals migrate,  
* `r num_hhid_v2_all_death` households had all individuals die, and   
* `r num_hhid_v2_ref_mig_died` households had all individuals refuse, migrate, or die.
* Total of above = `r num_hhid_v2_ref_ref + num_hhid_v2_all_migrations + num_hhid_v2_all_death + num_hhid_v2_ref_mig_died`  

This means that `r num_hhid_v2_ref_ref + num_hhid_v2_all_migrations + num_hhid_v2_all_death + num_hhid_v2_ref_mig_died` households were removed.

The V2 Clean data will then have the following households:

* `r num_hhid_v2_total_visited` visited - `r num_hhid_v2_100_refusal` = `r num_hhid_v2_total_visited - num_hhid_v2_100_refusal` V1 Clean

Finally, to create the V3 target we want to keep all people who we visited that are not a part of the households removed and we need to include the households that were missed in V2:

* `r num_hhid_v2_total_visited` visited + `r num_hhid_v2_not_visited - num_v2_hhid_visited_extid_not` not visited - `r num_hhid_v2_100_refusal` = `r num_hhid_v2_total_visited + (num_hhid_v2_not_visited - num_v2_hhid_visited_extid_not) - num_hhid_v2_100_refusal` V3 target

So now there is a V3 target of `r num_hhid_v3_target_real` households.

#### Individual Level

In total `r num_extid_v2_total_visited` people were visited in Safety V2 of which `r num_extid_v2_new_visited` were new and `r num_extid_v2_og_visited` were OG. 

In the target for V2, new people were not accounted for, only the OG people. So when we compare the V2 calculated target and V2 OG visited we find that `r num_extid_v2_not_visited` people were not visited:  

* `r num_extid_v2_target_real` (calculated target) - `r num_extid_v2_og_visited` (OG visited) = `r num_extid_v2_target_real - num_extid_v2_og_visited` (missed people)
* These individuals are coming from the `r length(unique(v2_not_visited$hhid)) - length(unique(v2_hhid_visited_extid_not$hhid))` missed households + `r length(unique(v2_hhid_visited_extid_not$hhid))` households which had no Safety submissions (just Safety New Members).

Now that we understand why the target is different, let's clean V2 by removing all migrations, deaths, and 100% refusal households: 

* `r num_extid_v2_mig_hhs_not_100` migrations (which are not a part of 100% refusal households),    
* `r num_extid_v2_died_hhs_not_100` deaths (which are not a part of 100% refusal households), and    
* `r num_extid_v2_100_refusal` people belonging to 100% refusal households.
  + `r num_extid_v2_mig_hhs_100` people migrated, 
  + `r num_extid_v2_died_hhs_100` person died, and
  + `r num_v2_ref_removed` people refused.
  + Total: `r num_extid_v2_mig_hhs_100` + `r num_extid_v2_died_hhs_100` + `r num_v2_ref_removed` = `r num_extid_v2_mig_hhs_100 + num_v2_ref_removed + num_extid_v2_died_hhs_100` people
* Total of: `r num_extid_v2_mig_hhs_not_100` migrations + `r num_extid_v2_died_hhs_not_100` deaths + `r num_extid_v2_100_refusal` 100% refusals = `r num_extid_v2_mig_hhs_not_100 + num_extid_v2_died_hhs_not_100 + num_extid_v2_100_refusal` people   

Now when we remove migrations, deaths, and people in 100% refusal households, we get a V2 Clean of `r num_extid_v2_clean`.  

* `r num_extid_v2_total_visited` visited - `r num_extid_v2_mig_hhs_not_100 + num_extid_v2_died_hhs_not_100 + num_extid_v2_100_refusal` removed = `r num_extid_v2_total_visited - (num_extid_v2_mig_hhs_not_100 + num_extid_v2_died_hhs_not_100 + num_extid_v2_100_refusal)` V2 Clean

Now that the data has been cleaned, we will calculate the V3 Target number by adding the people missed in V2 to the V2 Clean. The V3 Target will reflect the number of people who can be visited in the next visit (out and in people).

* `r num_v2_in_target` in + `r num_v3_target_out` out = `r num_v2_in_target + num_v3_target_out` V3 Target   

We calculate the V3 Calculated Target by removing migrations, deaths, and 100% refusal households:

* `r num_extid_v3_target_real` V3 Calculated Target

To double check everything that has been done, the V2 visited people's safety statuses are compared to V2 Clean and V3 Target below: 

```{r v2_safety_statuses}
knitr::kable(v2statuses)
```

* OUT: `r num_v2_out` V2 Visited out - `r num_v2_out_died` died - `r num_v2_out_mig` migrated =  `r num_v2_out - num_v2_out_died - num_v2_out_mig` V2 Clean out + `r num_extid_v2_not_visited` missed people = `r num_v3_target_out_start + num_extid_v2_not_visited` OUT (participants who can still enter the study)
* REFUSAL: `r num_v2_refusal` - `r num_v2_ref_removed` people in 100% removal households = `r num_v2_refusal - num_v2_ref_removed` REFUSAL (participants who refused but belong to hh that are still part of the study).
* 32 women were starting safety status in, took drug, and became pregnant, meaning that they will leave safety and enter pfu. On the table above, they became status eos. Please visit the [PFU Report](https://d27fg4iv55pk9u.cloudfront.net/safety-efficacy/pfu_status_and_reason.html#V2_Numbers) to track these women. _Note: extid 14024-02 was removed from the count of `r v2_preg_pfu` pregnant women because she did not take drug._

We can check this in the following table:

```{r v2_safety_pathway}
knitr::kable(v2_status_pathway)
```

***

### Safety V3

#### Household Level
While the target number of households to visit in Safety V3 was `r num_hhid_v3_target_real`, only `r num_hhid_v3_total_visited` households were visited. This means:

* `r num_hhid_v3_target_real` target hhs - `r num_hhid_v3_total_visited` visited hhs = `r num_hhid_v3_target_real - num_hhid_v3_total_visited` missed 

When we dive deeper to confirm that `r num_hhid_v3_target_real - num_hhid_v3_total_visited` household were missed, we find that `r num_hhid_v3_not_visited - num_v3_hhid_visited_extid_not` households were indeed not visited in V3.  

> _NOTE: `r num_v3_hhid_visited_extid_not` households were visited but only had Safety New members enrolled. The other members of the household had no data submitted for that visit._

Now that we have determined why the target hh and visited hh numbers differ, we will begin to find the V4 target number. To create the V4 target, we must remove the hh below:

* `r num_hhid_v3_ref_ref` households had all individuals refuse,  
* `r num_hhid_v3_all_migrations` households had all individuals migrate,  
* `r num_hhid_v3_all_death` households had all individuals die, and    
* `r num_hhid_v3_ref_mig_died` households had all individuals refuse, migrate, or die.
* Total of above = `r num_hhid_v3_ref_ref + num_hhid_v3_all_migrations + num_hhid_v3_all_death + num_hhid_v3_ref_mig_died`  

This means that `r num_hhid_v3_ref_ref + num_hhid_v3_all_migrations + num_hhid_v3_all_death + num_hhid_v3_ref_mig_died` households were removed.

The V3 Clean data will then have the following households:

* `r num_hhid_v3_total_visited` visited - `r num_hhid_v3_100_refusal` = `r num_hhid_v3_total_visited - num_hhid_v3_100_refusal` V3 Clean

To create the V4 target we want to keep only people who are 'in', including the 'in' people who were missed in V3. Therefore, we must remove the hh below:

* `r num_hhid_v3_removals` households that did not have at least one person in.  

Finally, to create the V4 target we want to keep all households with at least one person in (including households that were not visited in V3):

* `r length(unique(v3_clean$hhid))` V3 Clean + `r num_hhid_v3_not_visited - num_v3_hhid_visited_extid_not` not visited - `r num_hhid_v3_removals` houses with no in people = `r length(unique(v3_clean$hhid)) + (num_hhid_v3_not_visited - num_v3_hhid_visited_extid_not) - num_hhid_v3_removals` V4 target

So now there is a V4 target of `r num_hhid_v4_target_real` households.

#### Individual Level

In total `r num_extid_v3_total_visited` people were visited in Safety V3 of which `r num_extid_v3_new_visited` were new and `r num_extid_v3_og_visited` were OG. 

In the target for V3, new people were not accounted for, only the OG people. So when we compare the V3 calculated target and V3 OG visited we find that `r num_extid_v3_not_visited` people were not visited:  

* `r num_extid_v3_target_real` (calculated target) - `r num_extid_v3_og_visited` (OG visited) = `r num_extid_v3_target_real - num_extid_v3_og_visited` (missed people)
* These individuals are coming from the `r length(unique(v3_not_visited$hhid)) - length(unique(v3_hhid_visited_extid_not$hhid))` missed households + `r length(unique(v3_hhid_visited_extid_not$hhid))` households which had no Safety submissions (just Safety New Members).

Now that we understand why the target is different, let's clean V3 by removing all migrations, deaths, and 100% refusal households: 

* `r num_extid_v3_mig_hhs_not_100` migrations (which are not a part of 100% refusal households),    
* `r num_extid_v3_died_hhs_not_100` deaths (which are not a part of 100% refusal households), and    
* `r num_extid_v3_100_refusal` people belonging to 100% refusal households.
  + `r num_extid_v3_mig_hhs_100` people migrated, 
  + `r num_extid_v3_died_hhs_100` person died, and
  + `r num_v3_ref_removed` people refused.
  + Total: `r num_extid_v3_mig_hhs_100` + `r num_extid_v3_died_hhs_100` + `r num_v3_ref_removed` = `r num_extid_v3_mig_hhs_100 + num_v3_ref_removed + num_extid_v3_died_hhs_100` people
* Total of: `r num_extid_v3_mig_hhs_not_100` migrations + `r num_extid_v3_died_hhs_not_100` deaths + `r num_extid_v3_100_refusal` 100% refusals = `r num_extid_v3_mig_hhs_not_100 + num_extid_v3_died_hhs_not_100 + num_extid_v3_100_refusal` people   

Now when we remove migrations, deaths, and people in 100% refusal households, we get a V3 Clean of `r num_extid_v3_clean`.  

* `r num_extid_v3_total_visited` visited - `r num_extid_v3_mig_hhs_not_100 + num_extid_v3_died_hhs_not_100 + num_extid_v3_100_refusal` removed = `r num_extid_v3_total_visited - (num_extid_v3_mig_hhs_not_100 + num_extid_v3_died_hhs_not_100 + num_extid_v3_100_refusal)` V3 Clean

Now that the data has been cleaned, we will calculate the V4 Target number which will reflect the number of people who can be visited during the next visit (in people).

* `r num_v3_in_target` in = `r num_v3_in_target` V4 Target   

We calculate the V4 Calculated Target which will include all people on the roster (in, out, refusals, and eos people who are a part of a household with at least 1 person in):

* `r num_extid_v4_target_real` V4 Calculated Target

To double check everything that has been done, the V3 visited people's safety statuses are compared to V3 Clean and V4 Target below: 

```{r v3_safety_statuses}
knitr::kable(v3statuses)
```

* EOS: `r num_extid_v3_eos` V3 Visited eos + `r num_extid_v3_eos_with` missed eos people - `r num_extid_v3_eos_rem` eos people apart of households with no one in - `r num_extid_v3_eos_died` died - `r num_extid_v3_eos_mig` migrated = `r num_extid_v3_eos + num_extid_v3_eos_with- num_extid_v3_eos_rem - num_extid_v3_eos_mig - num_extid_v3_eos_died`
* OUT: `r num_v3_out` V3 Visited out - `r num_v3_out_died` died - `r num_v3_out_mig` migrated =  `r num_v3_out - num_v3_out_died - num_v3_out_mig` V3 Clean out + `r num_extid_v3_not_visited` missed people = `r num_v3_target_out_start + num_extid_v3_not_visited` OUT (participants who can still enter the study)
* REFUSAL: `r num_v3_refusal` - `r num_v3_ref_removed` people in 100% removal households = `r num_v3_refusal - num_v3_ref_removed` REFUSAL (participants who refused but belong to hh that are still part of the study).
* PREGNANCIES: `r v3_preg_pfu` women were starting safety status in, took drug, and became pregnant, meaning that they will leave safety and enter pfu. On the table above, they became status eos. Please visit the [PFU Report](https://d27fg4iv55pk9u.cloudfront.net/safety-efficacy/pfu_status_and_reason.html#V3_Numbers) to track these women.

We can check this in the following table:

```{r v3_safety_pathway}
knitr::kable(v3_status_pathway)
```

***

### Safety V4

#### Household Level
While the target number of households to visit in Safety V4 was `r num_hhid_v4_target_real`, only `r num_hhid_v4_total_visited` households were visited. This means:

* `r num_hhid_v4_target_real` target hhs - `r num_hhid_v4_total_visited` visited hhs = `r num_hhid_v4_target_real - num_hhid_v4_total_visited` missed 

When we dive deeper to confirm that `r num_hhid_v4_target_real - num_hhid_v4_total_visited` household was missed, we find that `r num_hhid_v4_not_visited - num_v4_hhid_visited_extid_not` household was indeed not visited in V4.  

> _NOTE: `r num_v4_hhid_visited_extid_not` households were visited but only had Safety New members enrolled. The other members of the household had no data submitted for that visit._

Since V4 is the final visit, there is no need to create a target for the next visit.

#### Individual Level

In total `r num_extid_v4_total_visited` people were visited in Safety V4 of which `r num_extid_v4_new_visited` were new and `r num_extid_v4_og_visited` were OG. 

In the target for V4, new people were not accounted for, only the OG people. So when we compare the V4 calculated target and V4 OG visited we find that `r num_extid_v4_not_visited` people were not visited:  

* `r num_extid_v4_target_real` (calculated target) - `r num_extid_v4_og_visited` (OG visited) = `r num_extid_v4_target_real - num_extid_v4_og_visited` (missed people)
* These individuals are coming from the `r length(unique(v4_not_visited$hhid)) - length(unique(v4_hhid_visited_extid_not$hhid))` missed households and `r length(unique(v4_hhid_visited_extid_not$hhid))` households which had no Safety submissions (just Safety New Members).

Now that we understand why the target is different, let's look at how many people completed safety below:

```{r v4_safety_statuses}
knitr::kable(v4statuses)
```

* `r v4_preg_pfu` women were starting safety status in, took drug, and became pregnant, meaning that they will leave safety and enter pfu. On the table above, they became status eos. Please visit the [PFU Report](https://d27fg4iv55pk9u.cloudfront.net/safety-efficacy/pfu_status_and_reason.html#V4_Numbers) to track these women.

We can check this in the following table:

```{r v4_safety_pathway}
knitr::kable(v4_status_pathway)
```

***



## Safety Totals
```{r trial_total}
reactable(total_trial_table, columns = list(), pagination = FALSE)
```

### Enrolled Participants
```{r trial_enrolled}
reactable(enrolled_table, columns = list(), pagination = FALSE)

reactable(trial_by_visit, columns = list(), pagination = FALSE)

reactable(enrol_eos_table, columns = list(), pagination = FALSE)

reactable(enrol_comp_table, columns = list(), pagination = FALSE)
```
*Note: the `r v4_pregnant_women_stat` women found pregnant in V4 are included in the Enrolled reason completion table.*

### Not Enrolled Participants
```{r trial_not_enrolled}
reactable(not_enrolled_table, columns = list(), pagination = FALSE)

reactable(not_enrol_eos_table, columns = list(), pagination = FALSE)

reactable(not_enrol_out_table, columns = list(), pagination = FALSE)

reactable(not_enrol_ref_table, columns = list(), pagination = FALSE)
```

## Safety targets
```{r target_show}
reactable(target_table, columns = list(), pagination = FALSE)
```

## V4 Numbers
### Overall safety statuses
```{r v4_total_show}
reactable(total_safety_status_v4, columns = list(
  `Percent complete` = colDef(align = "right")
))

# make a note of the real total number of people visited without repeats
if (any(duplicated(total_safety_v4$extid))) {
  cat("Note: Excluding the duplicates, the real total number of people visited is", length(unique(total_safety_v4$extid)), "\n")
} else {
  "Note: There are no duplicates based on extid in the data."
}
```

### pregnancies
```{r v4_pregnant}
reactable(pregnant_completion_v4, columns = list(
  `Percent of completion people` = colDef(align = 'right')
), pagination = FALSE)
```

### eos
```{r v4_wheneos}
reactable(eos_reasons_v4, columns = list(
  `Percent of eos` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page
```

#### follow up visit
```{r v4_eos}
reactable(eos_reasons_followup_v4, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page
```

### out
``` {r v4_out_show}
reactable(out_reasons_v4, columns = list(`Percent complete` = colDef(align = 'right')))
```

### refusal
``` {r v4_refusal_show}
reactable(refusal_reasons_v4, columns = list(`Percent complete` = colDef(align = 'right')))
```

## V3 Numbers
### Overall safety statuses
```{r v3_total_show}
reactable(total_safety_status_v3, columns = list(
  `Percent complete` = colDef(align = "right")
))

# make a note of the real total number of people visited without repeats
if (any(duplicated(total_safety_v3$extid))) {
  cat("Note: Excluding the duplicates, the real total number of people visited is", length(unique(total_safety_v3$extid)), "\n")
} else {
  "Note: There are no duplicates based on extid in the data."
}
```

### in
```{r v3_in_show}
reactable(in_type_v3, columns = list(
  `Percent` = colDef(align = "right")
))
```

### eos
```{r v3_eos}
reactable(eos_reasons_v3, columns = list(
  `Percent of eos` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page
```

#### follow up visit
```{r v3_eos_show}
reactable(eos_reasons_followup_v3, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('not wish to continue', 'not agree to safety procedures', 'not resident', 'under weight', 'study drug', 'concom meds', 'severe illness', 'baby under 1 week', 'pregnant', 'other trials', 'visited loa loa', 'spent night at the hospital', 'pregnancy test refusal', 'participant withdrew informed consent', 'died', 'migrated', 'eos in V1')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% eos_reasons_followup_v3$'Reason for eos') {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("Note: The following are not reasons to be eos: (", paste0(not_found_names, collapse = "/ "), ".")
}
```

#### enrolment visit
```{r v3_eos_enrolment}
reactable(eos_reasons_enrolment_v3, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('not agree to safety procedures', 'not resident', 'under weight', 'study drug', 'concom meds', 'severe illness', 'baby under 1 week', 'pregnant, other trials', 'visited loa loa', 'participant withdrew informed consent')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% eos_reasons_enrolment_v3$'Reason for eos') {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for eos status:", paste0(not_found_names, collapse = "/ "))
}
```

### out
``` {r v3_out_show}
reactable(out_reasons_v3, columns = list(`Percent complete` = colDef(align = 'right')))
```

### refusal
``` {r v3_refusal_show}
reactable(refusal_reasons_v3, columns = list(`Percent complete` = colDef(align = 'right')))
```


## V2 Numbers
### Overall safety statuses
```{r v2_total_show}
reactable(total_safety_status_v2, columns = list(
  `Percent complete` = colDef(align = "right")
))

# make a note of the real total number of people visited without repeats
if (any(duplicated(total_safety_v2$extid))) {
  cat("Note: Excluding the duplicates, the real total number of people visited is", length(unique(total_safety_v2$extid)), "\n")
} else {
  "Note: There are no duplicates based on extid in the data."
}
```

### in
```{r v2_in_show}
reactable(in_type_v2, columns = list(
  `Percent` = colDef(align = "right")
))
```

### eos
```{r}
reactable(eos_reasons_v2, columns = list(
  `Percent of eos` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page
```

#### follow up visit
```{r v2_eos_show}
reactable(eos_reasons_followup_v2, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('not wish to continue', 'not agree to safety procedures', 'not resident', 'under weight', 'study drug', 'concom meds', 'severe illness', 'baby under 1 week', 'pregnant', 'other trials', 'visited loa loa', 'spent night at the hospital', 'pregnancy test refusal', 'participant withdrew informed consent', 'died', 'migrated', 'eos in V1')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% eos_reasons_followup_v2$'Reason for eos') {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("Note: The following are not reasons to be eos (", paste0(not_found_names, collapse = "/ "), ".")
}
```

#### enrolment visit
```{r eos_enrolment}
reactable(eos_reasons_enrolment_v2, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('not agree to safety procedures', 'not resident', 'under weight', 'study drug', 'concom meds', 'severe illness', 'baby under 1 week', 'pregnant, other trials', 'visited loa loa', 'participant withdrew informed consent')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% eos_reasons_enrolment_v2$'Reason for eos') {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for eos status:", paste0(not_found_names, collapse = "/ "))
}
```

### out
``` {r v2_out_show}
reactable(out_reasons_v2, columns = list(`Percent complete` = colDef(align = 'right')))
```

### refusal
``` {r v2_refusal_show}
reactable(refusal_reasons_v2, columns = list(`Percent complete` = colDef(align = 'right')))
```

## V1 Numbers
### Overall safety statuses
```{r v1_total_show}
reactable(total_safety_status_v1, columns = list(
  `Percent complete` = colDef(align = "right")
))

# make a note of the real total number of people visited without repeats
if (any(duplicated(total_safety_v1$extid))) {
  cat("Note: Excluding the duplicates, the real total number of people visited is", length(unique(total_safety_v1$extid)), "\n")
} else {
  "Note: There are no duplicates based on extid in the data."
}
```

### Safety status by cluster
```{r cluster safety}
element_id <- 'safety-status-by-cluster'

# make the table of safety status by cluster
cluster_status <- total_safety_v1 %>%
  group_by(cluster, safetystatus) %>%
  summarise(number = n()) %>%
  group_by(cluster) %>%
  mutate(percent = paste(round((number / sum(number) * 100), 1), '%')) %>%
  pivot_wider(names_from = safetystatus,
              values_from = c(number, percent),
              values_fill = list(number = 0, percent = '0%')) %>%
  select(cluster, number_eos, percent_eos, number_refusal, percent_refusal, number_out, percent_out, number_in, percent_in) %>%
  mutate(total = sum(number_eos, number_refusal, number_out, number_in))

table <- reactable(cluster_status, columns = list(`percent_refusal` = colDef(align = 'right'),
                                                 `percent_out` = colDef(align = 'right'),
                                                 `percent_in` = colDef(align = 'right'),
                                                 `percent_eos` = colDef(align = 'right')),
                  highlight = TRUE,
                  resizable = TRUE,
                  bordered = TRUE,
                  striped = TRUE,
                  filterable=TRUE,
                  elementId = element_id)

wrap_download(
  table, 
  element_id,
  'safety_status_reason_by_cluster.csv')
```

### eos
```{r v1_eos_show}
reactable(eos_reasons_v1, columns = list(
  `Percent complete` = colDef(align = 'right')
), pagination = FALSE) #pagination makes the entire table show on one page

# because the table is organised by extid and not reason, some reasons may not appear on the table; therefore the next part will create a line of code that generates a message that says which reason is not appearing. In this by names I mean the reason column.
# Specify the names you want to check for
names_to_check <- c('not resident', 'under weight', 'study drug', 'concom meds', 'severe illness', 'baby under 1 week', 'pregnant', 'other trials', 'visited loa loa', 'spent night at the hospital', 'pregnancy test refusal', 'pregnant', 'participant withdrew informed consent', 'not agree to safety procedures')

# Initialize a vector to store names not found
not_found_names <- character(0)

# Check each name
for (name in names_to_check) {
  if (!name %in% eos_reasons_v1$'Reason for eos') {
    not_found_names <- c(not_found_names, name)
  }
}

# Generate a message based on the results (only if names are not found)
if (length(not_found_names) > 0) {
  cat("The following are not reasons for eos status:", paste0(not_found_names, collapse = "/ "))
}
```

### out
``` {r v1_out_show}
reactable(out_reasons_v1, columns = list(`Percent complete` = colDef(align = 'right')))
```

### refusal
``` {r v1_refusal_show}
reactable(refusal_reasons_v1, columns = list(`Percent complete` = colDef(align = 'right')))
```

## extid explorer
```{r extid-explorer}
element_id <- 'extid-explorerer'

data_readable <- reactable(data_investigation, columns = list(), 
                                              highlight = TRUE,
                                              resizable = TRUE,
                                              bordered = TRUE,
                                              striped = TRUE,
                                              filterable=TRUE,
                                              elementId = element_id
                                              )

wrap_download(
  data_readable, 
  element_id,
  'efficacy_extid_explorer.csv')
```
